
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Clientes</title>
    <style>
        /* Estilos gerais */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --white-color: #fff;
            --font-family: 'Segoe UI', Arial, sans-serif;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --button-gap: 5px; /* Variavel para o espa√ßamento */
            --client-name-color: #007bff; /* Variavel para a cor do nome */
            --avisado-color: #e0f7fa;
            --debito-color: #fff3e0;
            --vencendo-hoje-color: #fff9c4;
            --vencido-color: #ffcdd2;
        }

        body {
            font-family: var(--font-family);
            padding: 20px;
            background-color: #f4f7f9;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 2000px;
            margin: auto;
            background: var(--white-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        h1, h3 {
            text-align: center;
            color: var(--primary-color);
        }

        /* Estilos para Inputs e R√°dios */
        input[type="text"],
        input[type="tel"],
        input[type="date"],
        textarea {
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .input-group-horizontal {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group-horizontal input {
            flex: 1;
            min-width: 150px;
            margin-bottom: 0;
        }
        
        div > label {
            margin-right: 15px;
            font-weight: 500;
        }

        /* --- NOVOS ESTILOS DE BOT√ÉO --- */
        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: var(--font-family);
            font-weight: bold;
            font-size: 1em;
            color: var(--white-color);
            background-color: var(--primary-color);
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative; /* Para o badge */
            min-width: 44px;
            min-height: 44px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Bot√µes de √≠cone */
        button.icon-btn {
            padding: 0;
            width: 44px;
            height: 44px;
            font-size: 1.2em;
        }

        /* Varia√ß√µes de Cor dos Bot√µes */
        button.btn-secondary { background-color: var(--secondary-color); }
        button.btn-success { background-color: var(--success-color); }
        button.btn-danger { background-color: var(--danger-color); }
        button.btn-warning { background-color: var(--warning-color); color: var(--dark-color); }
        button.btn-info { background-color: var(--info-color); }

        /* Estilos espec√≠ficos de bot√µes existentes */
        .btn-debito-segurar { background-color: var(--warning-color); color: var(--dark-color); }
        .btn-renovar-data-atual { background-color: var(--warning-color); color: var(--dark-color); }
        .modal-confirm-danger { background-color: var(--danger-color); }
        .btn-dola { background-color: #ff9800; } /* Laranja */
        .btn-dola-sent { background-color: var(--success-color); }
        
        #centralMessageButton {
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: var(--success-color);
            border-radius: 10px;
        }

        /* Estilos da Tabela */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            display: none;
        }

        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
            vertical-align: middle;
        }

        td {
            display: flex;
            align-items: center;
            flex-wrap: wrap; 
            gap: var(--button-gap);
        }
        
        /* Bot√µes dentro da tabela menores */
        td button {
            padding: 8px;
            font-size: 1.2em; /* √çcones maiores */
            margin: 2px;
            width: 40px;
            height: 40px;
            line-height: 1; /* Alinhamento vertical */
        }
        
        td a {
            font-weight: bold;
            color: var(--client-name-color);
            text-decoration: none;
            transition: color 0.2s;
            margin-right: 15px; /* Espa√ßo entre o nome e os bot√µes */
        }
        td a:hover {
            filter: brightness(85%);
        }

        tr.avisado { background-color: var(--avisado-color) !important; }
        tr.debito { background-color: var(--debito-color) !important; }
        tr.vencendo-hoje { background-color: var(--vencendo-hoje-color) !important; }
        tr.vencido { background-color: var(--vencido-color) !important; }

        .center { text-align: center; }

        a.cliente-clicado, a.cliente-clicado:link, a.cliente-clicado:visited, a.cliente-clicado:hover, a.cliente-clicado:active {
            color: var(--success-color) !important;
            font-style: italic;
        }
        
        /* NOVOS ESTILOS PERSONALIZ√ÅVEIS */
        body.round-buttons td button,
        body.round-buttons .icon-btn {
            border-radius: 50%;
        }

        body.transparent-buttons td button {
            background-color: transparent;
            color: var(--dark-color);
            box-shadow: none;
            border: 1px solid transparent;
        }
        body.transparent-buttons td button:hover {
            background-color: rgba(0, 0, 0, 0.05);
            border-color: #ddd;
        }
        body.transparent-buttons td button.btn-danger { color: var(--danger-color); }
        body.transparent-buttons td button.btn-success { color: var(--success-color); }
        body.transparent-buttons td button.btn-info { color: var(--info-color); }
        body.transparent-buttons td button.btn-warning { color: #c69500; }
        body.transparent-buttons td button.btn-dola { color: #ff9800; }
        body.transparent-buttons td button.btn-dola-sent { color: var(--success-color); }


        /* Estilos de Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--white-color);
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            width: 90%;
            max-width: 450px;
            box-shadow: var(--box-shadow);
        }
        
        .modal .modal-content button {
            margin-top: 10px;
        }

        /* √çcone de Configura√ß√µes */
        .settings-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: var(--white-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--box-shadow);
            z-index: 999;
            transition: all 0.3s;
        }

        .settings-icon:hover {
            background-color: #0056b3;
            transform: rotate(45deg);
        }

        #settingsArea {
            display: none;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 30px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        #settingsArea label { display: block; margin-bottom: 10px; font-weight: bold; }
        #settingsArea input[type="range"] { width: 100%; margin-bottom: 15px; }
        #settingsArea h4 { margin-top: 20px; color: var(--secondary-color); border-bottom: 1px solid #ddd; padding-bottom: 5px;}
        #settingsArea .color-picker-label { display: flex; align-items: center; gap: 10px;}


        /* Estilo para o badge num√©rico */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--danger-color);
            color: var(--white-color);
            border-radius: 50%;
            padding: 4px 7px;
            font-size: 0.75em;
            min-width: 18px;
            text-align: center;
            line-height: 1;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        /* Overlay de Carregamento */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="ultimaAtualizacaoInfo" style="position: fixed; top: 10px; right: 10px; font-size: 0.9em; color: #555; background-color: #f9f9f9; padding: 5px 10px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 1001;">
        √öltima Altera√ß√£o: Nunca
    </div>
    <div class="container">
        <h1>Controle de Clientes</h1>
        <button id="centralMessageButton" onclick="enviarProximoClienteVencido()">
            Enviar Mensagem para Pr√≥ximo Vencido
            <span id="badgeCentralMessage" class="notification-badge" style="display:none;"></span>
        </button>
        <button onclick="importarClientes()" class="btn-info icon-btn" title="Importar Clientes (JSON)">üì•</button>
        <button onclick="exportarClientes()" class="btn-secondary icon-btn" title="Exportar Clientes (JSON)">üì§</button>

        <h3>Adicionar Cliente</h3>
        <div class="input-group-horizontal">
            <input type="date" id="dataInput" class="configurable-input" required>
            <input type="text" id="nomeInput" class="configurable-input" placeholder="Nome do Cliente" required>
            <input type="tel" id="telefoneInput" class="configurable-input" placeholder="Telefone (ex: 11999999999)" required>
        </div>
        <div>
            <label>
                <input type="radio" name="produto" value="UniTv" checked> UniTv
            </label>
            <label>
                <input type="radio" name="produto" value="Duplecast"> Duplecast
            </label>
        </div>
        <button onclick="adicionarCliente()" class="btn-success">‚ûï Adicionar Cliente</button>

        <h3>Filtros e A√ß√µes</h3>
        <button onclick="filtrarHojeEVencidos()">Vencendo Hoje + Vencidos <span id="badgeHojeEVencidos" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarHoje()">Clientes Vencendo Hoje <span id="badgeHoje" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarAmanha()">Clientes Vencendo Amanh√£ <span id="badgeAmanha" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarVencidos()">Clientes Vencidos <span id="badgeVencidos" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarDebito()" class="btn-warning">Clientes com D√©bito <span id="badgeDebito" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarVerDepois()" class="btn-secondary">Ver Depois <span id="badgeVerDepois" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarArquivados()" class="btn-secondary">Arquivados <span id="badgeArquivados" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarDesativados()" class="btn-secondary">Clientes Desativados <span id="badgeDesativados" class="notification-badge" style="display:none;"></span></button>
        <button onclick="mostrarContagemProdutos()" class="btn-info">Produtos</button>
        <button onclick="exibirTodos()">Reexibir Todos</button>
        <button onclick="confirmarLimparTodos()" class="btn-danger icon-btn" title="Limpar Todos">üóëÔ∏è</button>
        <button onclick="confirmarDesfazer()" class="btn-secondary icon-btn" title="Desfazer">‚Ü©Ô∏è</button>
        <button onclick="confirmarRefazer()" class="btn-secondary icon-btn" title="Refazer">‚Ü™Ô∏è</button>

        <h3>Pesquisa de Clientes</h3>
        <input type="text" id="searchInput" placeholder="Pesquisar por nome ou telefone" oninput="debouncePesquisa()">
        <button onclick="limparPesquisa()" class="btn-secondary icon-btn" title="Limpar Pesquisa">‚ùå</button>

        <table>
            <thead>
                <tr>
                    <th>Cliente e A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tabelaClientes"></tbody>
        </table>

        <hr>
        <h3>Data Atual</h3>
        <p id="dataAtual"></p>

        <div class="settings-icon" onclick="toggleSettingsArea()" title="Ajustes">‚öôÔ∏è</div>
        <div id="settingsArea">
            <h3>Ajustes de Interface</h3>
            
            <h4>Layout e Cores</h4>
            <label for="inputWidth">Largura dos Inputs (%): <span id="inputWidthValue"></span></label>
            <input type="range" id="inputWidth" min="10" max="100" value="16" oninput="updateInputWidth(this.value)">
            <label class="color-picker-label">
                Cor do Nome do Cliente
                <input type="color" id="clientNameColorPicker" oninput="updateCssVariable('--client-name-color', this.value)">
            </label>
             <label class="color-picker-label">
                Fundo "Avisado"
                <input type="color" id="avisadoColorPicker" oninput="updateCssVariable('--avisado-color', this.value)">
            </label>
            <label class="color-picker-label">
                Fundo "D√©bito"
                <input type="color" id="debitoColorPicker" oninput="updateCssVariable('--debito-color', this.value)">
            </label>
            <label class="color-picker-label">
                Fundo "Vencendo Hoje"
                <input type="color" id="vencendoHojeColorPicker" oninput="updateCssVariable('--vencendo-hoje-color', this.value)">
            </label>
            <label class="color-picker-label">
                Fundo "Vencido"
                <input type="color" id="vencidoColorPicker" oninput="updateCssVariable('--vencido-color', this.value)">
            </label>

            <h4>Bot√µes de A√ß√£o</h4>
            <label>
                <input type="checkbox" id="roundButtonsCheckbox" onchange="applyButtonStyles()"> Bot√µes Redondos
            </label>
            <label>
                <input type="checkbox" id="transparentButtonsCheckbox" onchange="applyButtonStyles()"> Fundo Transparente
            </label>
            <label for="buttonSpacingSlider">Espa√ßamento (px): <span id="buttonSpacingValue">5</span></label>
            <input type="range" id="buttonSpacingSlider" min="0" max="20" value="5" oninput="updateButtonSpacing(this.value)">

            <button onclick="abrirModalConfigurarBotoes()">Configurar Bot√µes Vis√≠veis</button>
            <button onclick="saveSettings()" class="btn-success icon-btn" title="Salvar Ajustes">üíæ</button>
            <button onclick="resetSettings()" class="btn-secondary icon-btn" title="Redefinir Padr√£o">üîÑ</button>
        </div>

        <!-- Modais -->
        <div id="modalConfirmacao" class="modal">
            <div class="modal-content">
                <h3>Confirmar Duplica√ß√£o</h3>
                <p>Voc√™ tem certeza que deseja duplicar este cliente?</p>
                <button onclick="confirmarDuplicacao()" class="btn-success">Confirmar</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>
        <div id="modalExclusao" class="modal">
            <div class="modal-content">
                <h3>Confirmar Exclus√£o</h3>
                <p>Voc√™ tem certeza que deseja excluir este cliente?</p>
                <button onclick="confirmarExclusao()" class="btn-danger">Confirmar</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>
        <div id="modalRenovarComDebito" class="modal">
            <div class="modal-content">
                <h3>Renovar com D√©bito?</h3>
                <p>Tem certeza que deseja renovar este cliente e marc√°-lo como D√©bito?</p>
                <button id="btnConfirmarRenovacaoDebito" class="btn-warning">Confirmar</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>
        <div id="modalConfirmacaoGenerica" class="modal">
            <div class="modal-content">
                <h3 id="modalConfirmacaoGenericaTitulo">Confirma√ß√£o</h3>
                <p id="modalConfirmacaoGenericaMensagem">Tem certeza?</p>
                <button id="btnConfirmacaoGenericaConfirmar">Confirmar</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>
        <div id="modalEdicao" class="modal" style="display: none;"></div>
        <div id="modalAlerta" class="modal" style="display: none;"></div>
        <div id="modalContagemProdutos" class="modal">
            <div class="modal-content">
                <h3>Contagem de Produtos</h3>
                <p>UniTv: <span id="countUniTv">0</span> clientes <button onclick="filtrarPorProduto('UniTv')">Detalhes</button></p>
                <p>Duplecast: <span id="countDuplecast">0</span> clientes <button onclick="filtrarPorProduto('Duplecast')">Detalhes</button></p>
                <button onclick="fecharModal()" class="btn-secondary">Fechar</button>
            </div>
        </div>
        <div id="modalEscolherProduto" class="modal">
            <div class="modal-content">
                <h3>Escolher Tipo de Produto</h3>
                <p>Selecione o tipo de produto para o cliente:</p>
                <button onclick="alterarProdutoClienteConfirm('UniTv')">UniTv</button>
                <button onclick="alterarProdutoClienteConfirm('Duplecast')">Duplecast</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>
        <div id="modalConflitoIdNome" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Conflito de Cliente por ID</h3>
                <p>O cliente importado possui o mesmo ID final de telefone (<span id="conflitoId"></span>) que um cliente existente, mas os nomes s√£o diferentes.</p>
                <p><b>Cliente Existente:</b> <span id="conflitoNomeExistente"></span></p>
                <p><b>Cliente Importado:</b> <span id="conflitoNomeImportado"></span></p>
                <p>O que deseja fazer?</p>
                <button id="btnConflitoManterExistente">Manter o Existente</button>
                <button id="btnConflitoUsarImportado" class="btn-warning">Atualizar Cliente Existente</button>
                <button id="btnConflitoManterAmbos" class="btn-info">Manter Ambos (Criar Novo Cliente)</button>
                <button onclick="cancelarConflitoIdNome()" class="btn-secondary">Cancelar Importa√ß√£o Deste</button>
            </div>
        </div>
        <div id="modalVerDepois" class="modal">
            <div class="modal-content">
                <h3>Agendar Reexibi√ß√£o</h3>
                <p>Escolha a data em que este cliente deve voltar a aparecer na lista principal.</p>
                <input type="date" id="dataReexibicaoInput" style="width: 90%; padding: 10px; margin: 10px 0;">
                <button id="btnConfirmarVerDepois" class="btn-success">Confirmar</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>
        <!-- NOVO MODAL PARA CONFIGURAR BOT√ïES -->
        <div id="modalConfigurarBotoes" class="modal">
            <div class="modal-content">
                <h3>Configurar Bot√µes de A√ß√£o</h3>
                <p>Marque os bot√µes que deseja exibir na lista de clientes.</p>
                <div id="botoesConfigList" style="text-align: left; max-height: 300px; overflow-y: auto; margin: 15px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    <!-- Checkboxes ser√£o inseridos aqui pelo JS -->
                </div>
                <button onclick="salvarConfiguracaoBotoes()" class="btn-success">Salvar</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script>
        let clientes = []; // Inicializado como array vazio, ser√° preenchido por loadClientes()
        let clientesFiltrados = [];
        let clienteIndexParaExcluir = null;
        let clienteIndexParaDuplicar = null;
        let clienteIndexParaRenovarDebito = null;
        let clienteIndexParaAlterarProduto = null;
        let modoExibicaoArquivados = false;
        let modoExibicaoOcultos = false;
        let modoExibicaoDesativados = false;
        let filtroProduto = null;
        let historicoClientes = [];
        let redoHistory = [];
        const MAX_HISTORY_STATES = 10;
        let confirmActionCallback = null;
        let clienteIdParaVerDepois = null; // Para armazenar o ID do cliente ao agendar
        // Vari√°veis para gerenciar o processo de importa√ß√£o com conflitos
        let clientesParaProcessarImportacao = [];
        let currentIndexImportacao = 0;
        // Vari√°veis para o bot√£o de mensagem central
        let clientesVencidosParaMensagem = [];
        // Vari√°vel para armazenar o ID do cliente para "Renovar HOJE"
        let clienteIdParaRenovarHoje = null;
        // Vari√°vel para o debounce da pesquisa
        let debounceTimer;

        // ====================================================================================
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwoeQZB6yl-RBXQ8gn7PUOz-QsyYJfeWW8UgDgNf8WUYPCH7DczuoXLb_5PkipxD6OY/exec';
        // ====================================================================================

        let filtroAtual = "hojeEVencidos";
        // NOVO: Configura√ß√£o dos bot√µes de a√ß√£o
        let acaoBotoesConfig = {};
        const defaultAcaoBotoesConfig = {
            dola: {                label: 'ü§ñ Dola',                visivel: true            },
            renovarAuto: {                label: 'Renov. Auto (üîÅ)',                visivel: true            },
            debito: {                label: 'D√âBITO',                visivel: true            },
            renovarHoje: {                label: 'RENOVAR HOJE',                visivel: true            },
            verDepois: {                label: 'Ver Depois',                visivel: true            },
            produto: {                label: 'Produto',                visivel: true            },
            editar: {                label: 'Edit',                visivel: true            },
            excluir: {                label: 'Excluir (‚ùå)',                visivel: true            },
            arquivar: {                label: 'Arquivar (üìÇ)',                visivel: true            },
            desativar: {                label: 'Desativar',                visivel: true            },
            copiar: {                label: 'üìã Copiar',                visivel: true            },
            duplicar: {                label: '‚ûï Duplicar',                visivel: true            }
        };

        // --- Fun√ß√µes de Loading/Spinner ---
        function mostrarCarregando() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        // FUN√á√ÉO ATUALIZADA: Marca o link clicado e ATUALIZA O OBJETO CLIENTE
        function marcarClienteClicado(elemento) {
            // Remove a classe de outros links para garantir que apenas um esteja ativo visualmente
            document.querySelectorAll('a.cliente-clicado').forEach(el => el.classList.remove('cliente-clicado'));

            elemento.classList.add("cliente-clicado");
            const tr = elemento.closest("tr");
            if (tr) {
                const indexNaTabela = Array.from(tr.parentNode.children).indexOf(tr);
                const clienteClicado = clientesExibidos[indexNaTabela];
                if (clienteClicado) {
                    const indexOriginal = clientes.findIndex(c => c.id === clienteClicado.id);
                    if (indexOriginal !== -1) {
                        clientes[indexOriginal].clicado = true;
                        saveClientsToLocalStorage();
                    }
                }
            }
        }

        function esconderCarregando() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function saveClientsToLocalStorage() {
            try {
                localStorage.setItem('clientesCache', JSON.stringify(clientes));
            } catch (e) {
                console.error('Erro ao salvar clientes no localStorage:', e);
            }
        }

        async function sendRequestToBackend(action, data = {}) {
            try {
                const url = `${WEB_APP_URL}?action=${action}`;
                const options = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify(data),
                    muteHttpExceptions: true
                };

                if (action === 'get_all_clients') {
                    options.method = 'GET';
                    delete options.body;
                }

                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro de rede ou servidor: ${response.status} - ${errorText}`);
                }
                const result = await response.json();
                if (result && result.status === 'error') {
                    throw new Error(result.message || 'Erro desconhecido do backend.');
                }
                return result;
            } catch (error) {
                console.error('Erro na comunica√ß√£o com o backend:', error);
                throw error;
            }
        }

        function atualizarUltimaAtualizacao(acao = "dados atualizados", clienteNome = "") {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            const formattedDateTime = now.toLocaleString('pt-BR', options);
            let fullMessage = `√öltima Altera√ß√£o: ${formattedDateTime}`;
            if (clienteNome) {
                const nomeLimpoParaMsg = clienteNome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');
                fullMessage += ` - ${nomeLimpoParaMsg} (${acao})`;
            } else {
                fullMessage += ` (${acao})`;
            }
            localStorage.setItem('ultimaAtualizacaoCliente', fullMessage);
            document.getElementById('ultimaAtualizacaoInfo').textContent = fullMessage;
        }

        function saveStateToHistory(clearRedo = true) {
            const estadoAtual = JSON.parse(JSON.stringify(clientes));
            historicoClientes.push(estadoAtual);
            if (historicoClientes.length > MAX_HISTORY_STATES) {
                historicoClientes.shift();
            }
            if (clearRedo) {
                redoHistory = [];
            }
        }

        function exibirConfirmacaoGenerica(titulo, mensagem, callback, isDanger = false) {
            const modal = document.getElementById("modalConfirmacaoGenerica");
            const btnConfirmar = document.getElementById("btnConfirmacaoGenericaConfirmar");
            document.getElementById("modalConfirmacaoGenericaTitulo").innerText = titulo;
            document.getElementById("modalConfirmacaoGenericaMensagem").innerHTML = mensagem;
            confirmActionCallback = callback;
            
            // Remove classes existentes e adiciona a correta
            btnConfirmar.classList.remove("btn-danger", "btn-success");
            btnConfirmar.classList.add(isDanger ? "btn-danger" : "btn-success");
            
            btnConfirmar.onclick = () => {
                if (confirmActionCallback) {
                    confirmActionCallback();
                    confirmActionCallback = null;
                }
                fecharModal();
            };
            modal.style.display = "flex";
            document.addEventListener("keydown", fecharComEsc);
        }

        function fecharModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = "none";
            });
            const modalEdicao = document.getElementById("modalEdicao");
            if (modalEdicao) {
                modalEdicao.innerHTML = "";
            }
            const modalAlerta = document.getElementById("modalAlerta");
            if (modalAlerta) {
                modalAlerta.innerHTML = "";
            }
            document.removeEventListener("keydown", fecharComEsc);
            document.removeEventListener("keydown", fecharComEscOuEnter);
            clienteIdParaRenovarHoje = null;
        }


        function fecharComEsc(event) {
            if (event.key === "Escape") {
                fecharModal();
            }
        }

        function fecharComEscOuEnter(event) {
            if (event.key === "Enter" || event.key === "Escape") {
                fecharModal();
            }
        }

        function exibirAlerta(mensagem) {
            let modalAlerta = document.getElementById("modalAlerta");
            modalAlerta.style.display = "flex";
            modalAlerta.innerHTML = `<div class="modal-content"><h3>Aviso</h3><p>${mensagem}</p><button class="btn-primary" onclick="fecharModal()">OK</button></div>`;
            document.addEventListener("keydown", fecharComEscOuEnter);
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === "Enter" && document.getElementById("modalExclusao").style.display === "flex") {
                confirmarExclusao();
            }
        });

        async function adicionarCliente() {
            const dataInput = document.getElementById("dataInput").value.trim();
            const nomeInput = document.getElementById("nomeInput").value.trim();
            const telefoneInput = document.getElementById("telefoneInput").value.trim();
            const produtoSelecionado = document.querySelector('input[name="produto"]:checked').value;

            if (!dataInput || !nomeInput || !telefoneInput) {
                return exibirAlerta("Por favor, insira a data, o nome e o telefone do cliente.");
            }
            const telefoneLimpo = telefoneInput.replace(/[^\d]/g, '');
            if (telefoneLimpo.length < 5) {
                return exibirAlerta("O telefone deve ter pelo menos 5 d√≠gitos para gerar o ID.");
            }
            const clienteId = telefoneLimpo.slice(-5);
            const clienteExistenteComMesmoId = clientes.find(c => c.id === clienteId);
            if (clienteExistenteComMesmoId) {
                return exibirAlerta(`J√° existe um cliente com o ID final de telefone ${clienteId} (Nome: ${clienteExistenteComMesmoId.nome}). Por favor, use um telefone final diferente ou edite o cliente existente.`);
            }

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const dataParts = dataInput.split("-");
            const dataFormatadaParaArmazenar = `${dataParts[2]}/${dataParts[1]}/${dataParts[0]}`;
            let nomeComProduto = `${nomeInput} (${produtoSelecionado})`;

            const novoClienteObj = {
                id: clienteId,
                data: dataFormatadaParaArmazenar,
                nome: nomeComProduto,
                telefone: telefoneLimpo,
                avisado: false,
                debito: false,
                Produto: produtoSelecionado,
                arquivado: false,
                oculto: false,
                reexibirEm: null,
                desativado: false,
                dola_sent: false,
                clicado: false
            };

            clientes.push(novoClienteObj);
            saveClientsToLocalStorage();
            document.getElementById("nomeInput").value = "";
            document.getElementById("telefoneInput").value = "";
            exibirTabela();
            atualizarContadores();
            atualizarUltimaAtualizacao("adicionado", nomeInput);

            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                exibirTabela();
                atualizarContadores();
                exibirAlerta(`Erro ao adicionar cliente: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha na adi√ß√£o", nomeInput);
            }
        }

        async function arquivar(index) {
            const clienteParaArquivar = clientesExibidos[index];
            const clienteOriginalIndex = clientes.findIndex(c => c.id === clienteParaArquivar.id);
            if (clienteOriginalIndex === -1) return;

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            clientes[clienteOriginalIndex].arquivado = true;
            clientes[clienteOriginalIndex].oculto = false;
            clientes[clienteOriginalIndex].reexibirEm = null;
            clientes[clienteOriginalIndex].desativado = false;
            clientes[clienteOriginalIndex].clicado = false;
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("arquivado", clienteParaArquivar.nome);
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao arquivar cliente: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha ao arquivar", clienteParaArquivar.nome);
            }
        }

        async function desarquivar(index) {
            const clienteParaDesarquivar = clientesExibidos[index];
            const clienteOriginalIndex = clientes.findIndex(c => c.id === clienteParaDesarquivar.id);
            if (clienteOriginalIndex === -1) return;

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            clientes[clienteOriginalIndex].arquivado = false;
            clientes[clienteOriginalIndex].reexibirEm = null;
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("desarquivado", clienteParaDesarquivar.nome);
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao desarquivar cliente: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha ao desarquivar", clienteParaDesarquivar.nome);
            }
        }

        function filtrarHojeEVencidos() {
            filtroAtual = "hojeEVencidos";
            exibirTabela();
            atualizarContadores();
        }

        function filtrarArquivados() {
            filtroAtual = "arquivados";
            document.getElementById("searchInput").value = "";
            exibirTabela();
        }

        function mostrarApenasOcultosPorFiltro() {
            filtroAtual = "ocultos";
            document.getElementById("searchInput").value = "";
            exibirTabela();
        }

        function filtrarVerDepois() {
            filtroAtual = "verDepois";
            document.getElementById("searchInput").value = "";
            exibirTabela();
        }

        function filtrarDesativados() {
            filtroAtual = "desativados";
            document.getElementById("searchInput").value = "";
            exibirTabela();
        }

        function filtrarPorProduto(produto) {
            filtroAtual = `produto:${produto}`;
            document.getElementById("searchInput").value = "";
            fecharModal();
            exibirTabela();
        }
        let clientesExibidos = [];

        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('/');
            if (parts.length === 3) {
                return `${parts[0]}/${parts[1]}`;
            }
            return dateString.substring(0, 5);
        }

        function exibirTabela() {
            const termoPesquisa = document.getElementById("searchInput").value.trim().toLowerCase();
            let clientesParaProcessar;
            const hojeStr = new Date().toISOString().split('T')[0];

            const isVisivelHoje = (cliente) => {
                return !cliente.reexibirEm || cliente.reexibirEm <= hojeStr;
            };

            if (termoPesquisa !== '') {
                clientesParaProcessar = clientes.filter(cliente =>
                    (cliente.nome.toLowerCase().includes(termoPesquisa) || cliente.telefone.includes(termoPesquisa))
                );
            } else if (filtroAtual === "verDepois") {
                clientesParaProcessar = clientes.filter(cliente => cliente.reexibirEm && cliente.reexibirEm > hojeStr);
            } else if (filtroAtual === "hojeEVencidos") {
                const hoje = new Date();
                const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" +
                    (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" +
                    hoje.getFullYear();
                clientesParaProcessar = clientes.filter(cliente => {
                    const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));
                    const dataCliente = new Date(ano, mes - 1, dia);
                    const isVencendoHoje = cliente.data === hojeFormatada;
                    const isVencido = dataCliente < hojeSemHora;
                    return (isVencendoHoje || isVencido) && !cliente.arquivado && !cliente.oculto && !cliente.desativado && isVisivelHoje(cliente);
                });
            } else if (filtroAtual === "arquivados") {
                clientesParaProcessar = clientes.filter(cliente => cliente.arquivado);
            } else if (filtroAtual === "desativados") {
                clientesParaProcessar = clientes.filter(cliente => cliente.desativado);
            } else if (filtroAtual.startsWith("produto:")) {
                const produto = filtroAtual.split(":")[1];
                clientesParaProcessar = clientes.filter(cliente => cliente.Produto === produto && !cliente.arquivado && !cliente.oculto && !cliente.desativado && isVisivelHoje(cliente));
            } else if (filtroAtual === "hoje") {
                const hoje = new Date();
                const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" +
                    (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" +
                    hoje.getFullYear();
                clientesParaProcessar = clientes.filter(cliente => cliente.data === hojeFormatada && !cliente.arquivado && !cliente.oculto && !cliente.desativado && !cliente.avisado && isVisivelHoje(cliente));
            } else if (filtroAtual === "amanha") {
                const amanha = new Date();
                amanha.setDate(amanha.getDate() + 1);
                const amanhaFormatada = amanha.getDate().toString().padStart(2, '0') + "/" +
                    (amanha.getMonth() + 1).toString().padStart(2, '0') + "/" +
                    amanha.getFullYear();
                clientesParaProcessar = clientes.filter(cliente => cliente.data === amanhaFormatada && !cliente.arquivado && !cliente.oculto && !cliente.desativado && isVisivelHoje(cliente));
            } else if (filtroAtual === "vencidos") {
                const hoje = new Date();
                clientesParaProcessar = clientes.filter(cliente => {
                    const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));
                    const dataCliente = new Date(ano, mes - 1, dia);
                    const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                    return dataCliente < hojeSemHora && !cliente.arquivado && !cliente.oculto && !cliente.desativado && !cliente.avisado && isVisivelHoje(cliente);
                });
            } else if (filtroAtual === "debito") {
                clientesParaProcessar = clientes.filter(cliente => cliente.debito && !cliente.arquivado && !cliente.oculto && !cliente.desativado && isVisivelHoje(cliente));
            } else if (filtroAtual === "todos") {
                clientesParaProcessar = clientes.filter(cliente => !cliente.arquivado && !cliente.oculto && !cliente.desativado && isVisivelHoje(cliente));
            } else {
                clientesParaProcessar = clientes.filter(cliente => !cliente.arquivado && !cliente.oculto && !cliente.desativado && isVisivelHoje(cliente));
            }

            clientesExibidos = clientesParaProcessar;

            if (clientesExibidos.length === 0) {
                document.querySelector("table").style.display = "none";
                document.getElementById("tabelaClientes").innerHTML = `<tr><td colspan="1" style="text-align: center; color: gray;">Nenhum cliente para exibir neste filtro.</td></tr>`;
                prepararClientesVencidosParaMensagem();
                atualizarContadores();
                return;
            }

            document.querySelector("table").style.display = "table";
            const tabela = document.getElementById("tabelaClientes");
            tabela.innerHTML = "";

            clientesExibidos.sort((a, b) => {
                const [diaA, mesA, anoA] = a.data.split("/").map(num => parseInt(num));
                const [diaB, mesB, anoB] = b.data.split("/").map(num => parseInt(num));
                const dataA = new Date(anoA, mesA - 1, diaA);
                const dataB = new Date(anoB, mesB - 1, diaB);
                return dataA - dataB;
            });

            const hoje = new Date();
            const hojeFormatadaDDMMYYYY = hoje.getDate().toString().padStart(2, '0') + "/" +
                (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" +
                hoje.getFullYear();

            clientesExibidos.forEach((cliente, index) => {
                const tr = document.createElement("tr");
                tr.classList.remove("avisado", "debito", "vencendo-hoje", "vencido");
                if (cliente.avisado) tr.classList.add("avisado");
                if (cliente.debito) tr.classList.add("debito");
                const [diaCliente, mesCliente, anoCliente] = cliente.data.split("/").map(num => parseInt(num));
                const dataCliente = new Date(anoCliente, mesCliente - 1, diaCliente);
                const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                if (cliente.data === hojeFormatadaDDMMYYYY) {
                    tr.classList.add("vencendo-hoje");
                } else if (dataCliente < hojeSemHora) {
                    tr.classList.add("vencido");
                }
                let botoesAcao = '';
                if (filtroAtual === "arquivados") {
                    botoesAcao = `
                        <button title="Desarquivar Cliente" onclick="desarquivar(${index})" class="btn-success">‚Ü©Ô∏è</button>
                        <button title="Excluir Cliente" onclick="excluir(${index})" class="btn-danger">‚ùå</button>
                    `;
                } else if (filtroAtual === "verDepois") {
                    const dataAgendada = new Date(cliente.reexibirEm + 'T00:00:00').toLocaleDateString('pt-BR');
                    botoesAcao = `
                        <span>Reexibir em: ${dataAgendada}</span>
                        <button title="Reexibir Agora" onclick="desmarcarVerDepois(${index})" class="btn-success">‚Ü©Ô∏è</button>
                        <button title="Editar Cliente" onclick="editar(${index})" class="btn-info">‚úèÔ∏è</button>
                        <button title="Excluir Cliente" onclick="excluir(${index})" class="btn-danger">‚ùå</button>
                    `;
                } else if (filtroAtual === "desativados") {
                    botoesAcao = `
                        <button title="Reativar Cliente" onclick="toggleDesativado(${index})" class="btn-success">‚ö°</button>
                        <button title="Excluir Cliente" onclick="excluir(${index})" class="btn-danger">‚ùå</button>
                    `;
                } else {
                    const dolaButtonClass = cliente.dola_sent ? 'btn-dola-sent' : 'btn-dola';
                    let botoesHtml = [];
                    if (acaoBotoesConfig.dola.visivel) botoesHtml.push(`<button title="Enviar Lembrete Dola" class="${dolaButtonClass}" onclick="enviarMensagemWhatsAppDola(${index})">ü§ñ</button>`);
                    if (acaoBotoesConfig.renovarAuto.visivel) botoesHtml.push(`<button title="Renovar Autom√°tico" onclick="renovarAutomatico(${index})">üîÅ</button>`);
                    if (acaoBotoesConfig.debito.visivel) botoesHtml.push(`<button title="Renovar com D√©bito" class="btn-debito-segurar" onclick="pedirConfirmacaoRenovacaoDebito(${index})">üí∞</button>`);
                    if (acaoBotoesConfig.renovarHoje.visivel) botoesHtml.push(`<button title="Renovar a Partir de Hoje" class="btn-renovar-data-atual" onclick="pedirConfirmacaoRenovarHoje(${index})">üìÖ</button>`);
                    if (acaoBotoesConfig.verDepois.visivel) botoesHtml.push(`<button title="Agendar Reexibi√ß√£o" onclick="abrirModalVerDepois(${index})">‚è∞</button>`);
                    if (acaoBotoesConfig.produto.visivel) botoesHtml.push(`<button title="Alterar Produto" onclick="abrirModalAlterarProduto(${index})">üì¶</button>`);
                    if (acaoBotoesConfig.editar.visivel) botoesHtml.push(`<button title="Editar Cliente" onclick="editar(${index})">‚úèÔ∏è</button>`);
                    if (acaoBotoesConfig.excluir.visivel) botoesHtml.push(`<button title="Excluir Cliente" onclick="excluir(${index})" class="btn-danger">‚ùå</button>`);
                    if (acaoBotoesConfig.arquivar.visivel) botoesHtml.push(`<button title="Arquivar Cliente" onclick="arquivar(${index})">üìÇ</button>`);
                    if (acaoBotoesConfig.desativar.visivel) botoesHtml.push(`<button title="Desativar Cliente" onclick="toggleDesativado(${index})" class="btn-secondary">üîå</button>`);
                    if (acaoBotoesConfig.copiar.visivel) botoesHtml.push(`<button title="Copiar Mensagem WhatsApp" onclick="copiarMensagemWhatsApp(${index})">üìã</button>`);
                    if (acaoBotoesConfig.duplicar.visivel) botoesHtml.push(`<button title="Duplicar Cliente" onclick="duplicarCliente(${index})">‚ûï</button>`);
                    botoesAcao = botoesHtml.join('');
                }

                const nomeExibicaoBase = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');
                const classeDinamica = cliente.clicado ? 'cliente-clicado' : '';

                tr.innerHTML = `
                    <td>
                        <span>${formatDateForDisplay(cliente.data)}</span>
                        <a href="#" class="${classeDinamica}" onclick="marcarClienteClicado(this); enviarMensagemWhatsApp('${nomeExibicaoBase}', '${cliente.telefone}', ${index}); return false;">
                            ${nomeExibicaoBase} (${cliente.Produto || 'N/I'})
                        </a>
                        ${botoesAcao}
                    </td>
                `;
                tabela.appendChild(tr);
            });
            atualizarContadores();
        }

        async function toggleAvisadoFromAvisados(clientId) {
            const clienteOriginalIndex = clientes.findIndex(c => c.id === clientId);
            if (clienteOriginalIndex === -1) return;

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            clientes[clienteOriginalIndex].avisado = false;
            clientes[clienteOriginalIndex].oculto = false;
            clientes[clienteOriginalIndex].clicado = false;
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("desmarcado avisado", clientes[clienteOriginalIndex].nome);
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao desmarcar cliente como avisado: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha ao desmarcar avisado", clientes[clienteOriginalIndex].nome);
            }
        }
        // --- Novas fun√ß√µes auxiliares para a lista de Avisados ---
        function abrirModalVerDepoisById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                abrirModalVerDepois(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function abrirModalAlterarProdutoById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                abrirModalAlterarProduto(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function editarClienteById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                editar(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function excluirClienteById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                excluir(index);
            }
        }

        function arquivarById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                arquivar(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function toggleDesativadoById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                toggleDesativado(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function duplicarClienteById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                duplicarCliente(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function enviarMensagemWhatsAppDolaById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                enviarMensagemWhatsAppDola(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function renovarAutomatiscoById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                renovarAutomatico(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function pedirConfirmacaoRenovacaoDebitoById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                pedirConfirmacaoRenovacaoDebito(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function pedirConfirmacaoRenovacaoDebito(index) {
             clienteIndexParaRenovarDebito = index;
             document.getElementById('modalRenovarComDebito').style.display = 'flex';
             document.getElementById('btnConfirmarRenovacaoDebito').onclick = confirmarRenovacaoComDebito;
        }

        function pedirConfirmacaoRenovarHojeById(clientId) {
            clienteIdParaRenovarHoje = clientId;
            exibirConfirmacaoGenerica("Confirmar Renova√ß√£o HOJE", "Tem certeza que deseja renovar a data de vencimento deste cliente para **HOJE**?", confirmarRenovarHoje, false);
        }

        async function renovarAutomatico(index) {
            const cliente = clientesExibidos[index];
            if (!cliente.Produto || cliente.Produto === "N√£o informado") {
                exibirAlerta("O produto do cliente n√£o est√° informado! Por favor, edite o cliente e defina o produto antes de renovar.");
                return;
            }
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const clienteOriginalIndex = clientes.findIndex(c => c.id === cliente.id);
            if (clienteOriginalIndex !== -1) {
                renovarProximoMes(clientes[clienteOriginalIndex]);
                clientes[clienteOriginalIndex].debito = false;
                clientes[clienteOriginalIndex].oculto = false;
                clientes[clienteOriginalIndex].avisado = false;
                clientes[clienteOriginalIndex].reexibirEm = null;
                clientes[clienteOriginalIndex].desativado = false;
                clientes[clienteOriginalIndex].dola_sent = false;
                clientes[clienteOriginalIndex].clicado = false;
            }
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("renovado automaticamente", cliente.nome);
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao renovar automaticamente: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha na renova√ß√£o autom√°tica", cliente.nome);
            }
        }

        function pedirConfirmacaoRenovarHoje(index) {
            const cliente = clientesExibidos[index];
            clienteIdParaRenovarHoje = cliente.id;
            exibirConfirmacaoGenerica("Confirmar Renova√ß√£o HOJE", `Tem certeza que deseja renovar a data de vencimento de **${cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '')}** para **HOJE**?`, confirmarRenovarHoje, false);
        }

        async function confirmarRenovarHoje() {
            if (clienteIdParaRenovarHoje === null) return;
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const clienteOriginalIndex = clientes.findIndex(c => c.id === clienteIdParaRenovarHoje);
            const clienteOriginalNome = clientes[clienteOriginalIndex].nome;
            if (clienteOriginalIndex !== -1) {
                const hoje = new Date();
                const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" + (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" + hoje.getFullYear();
                clientes[clienteOriginalIndex].data = hojeFormatada;
                clientes[clienteOriginalIndex].debito = false;
                clientes[clienteOriginalIndex].oculto = false;
                clientes[clienteOriginalIndex].avisado = false;
                clientes[clienteOriginalIndex].reexibirEm = null;
                clientes[clienteOriginalIndex].desativado = false;
                clientes[clienteOriginalIndex].dola_sent = false;
                clientes[clienteOriginalIndex].clicado = false;
            }
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("renovado a partir da data atual", clienteOriginalNome);
            exibirAlerta(`Cliente "${clienteOriginalNome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '')}" renovado para hoje!`);
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao renovar para hoje: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha na renova√ß√£o para hoje", clienteOriginalNome);
            }
            clienteIdParaRenovarHoje = null;
        }

        async function confirmarRenovacaoComDebito() {
            if (clienteIndexParaRenovarDebito === null) return;
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const cliente = clientesExibidos[clienteIndexParaRenovarDebito];
            const clienteOriginalIndex = clientes.findIndex(c => c.id === cliente.id);
            const clienteNome = cliente.nome;
            if (!cliente.Produto || cliente.Produto === "N√£o informado") {
                exibirAlerta("O produto do cliente n√£o est√° informado! Por favor, edite o cliente e defina o produto antes de renovar.");
                fecharModal();
                return;
            }
            if (clienteOriginalIndex !== -1) {
                renovarProximoMes(clientes[clienteOriginalIndex]);
                clientes[clienteOriginalIndex].debito = true;
                clientes[clienteOriginalIndex].oculto = false;
                clientes[clienteOriginalIndex].avisado = false;
                clientes[clienteOriginalIndex].reexibirEm = null;
                clientes[clienteOriginalIndex].desativado = false;
                clientes[clienteOriginalIndex].dola_sent = false;
                clientes[clienteOriginalIndex].clicado = false;
            }
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            fecharModal();
            clienteIndexParaRenovarDebito = null;
            exibirAlerta("Cliente renovado e marcado como D√âBITO!");
            atualizarUltimaAtualizacao("renovado com d√©bito", clienteNome);
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao renovar com d√©bito: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha na renova√ß√£o com d√©bito", clienteNome);
            }
        }

        function renovarProximoMes(clienteObj) {
            const [dia, mes, ano] = clienteObj.data.split("/").map(num => parseInt(num));
            const dataObj = new Date(ano, mes - 1, dia);
            dataObj.setMonth(dataObj.getMonth() + 1);
            if (dataObj.getDate() !== dia) {
                dataObj.setDate(0);
            }
            clienteObj.data = `${dataObj.getDate().toString().padStart(2, '0')}/${(dataObj.getMonth() + 1).toString().padStart(2, '0')}/${dataObj.getFullYear()}`;
        }

        function duplicarCliente(index) {
            clienteIndexParaDuplicar = index;
            document.getElementById("modalConfirmacao").style.display = "flex";
        }

        async function confirmarDuplicacao() {
            if (clienteIndexParaDuplicar === null) return;
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const clienteOriginal = clientesExibidos[clienteIndexParaDuplicar];
            let novoTelefoneBase = clienteOriginal.telefone;
            let novoId = clienteOriginal.id;
            let contadorDuplicacao = 1;
            while (clientes.some(c => c.id === novoId)) {
                novoTelefoneBase = clienteOriginal.telefone + '_' + contadorDuplicacao;
                novoId = novoTelefoneBase.slice(-5);
                if (novoTelefoneBase.length < 5) {
                    novoId = "DUP" + String(contadorDuplicacao).padStart(3, '0');
                } else {
                    novoId = novoTelefoneBase.slice(-5);
                }
                contadorDuplicacao++;
                if (contadorDuplicacao > 100) {
                    exibirAlerta("N√£o foi poss√≠vel gerar um ID √∫nico para a duplica√ß√£o. Tente novamente.");
                    fecharModal();
                    return;
                }
            }
            const novoCliente = {
                id: novoId,
                data: clienteOriginal.data,
                nome: clienteOriginal.nome + " (C√≥pia)",
                telefone: novoTelefoneBase,
                avisado: false,
                debito: false,
                Produto: clienteOriginal.Produto || "N√£o informado",
                arquivado: false,
                oculto: false,
                reexibirEm: null,
                desativado: false,
                dola_sent: false,
                clicado: false
            };
            clientes.push(novoCliente);
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            fecharModal();
            clienteIndexParaDuplicar = null;
            atualizarUltimaAtualizacao("duplicado", clienteOriginal.nome);
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao duplicar cliente: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha na duplica√ß√£o", clienteOriginal.nome);
            }
        }

        function getNomeMes(mesNumero) {
            const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            return meses[mesNumero - 1];
        }

        async function copiarMensagemWhatsApp(index) {
            const cliente = clientesExibidos[index];
            const nomeExibicaoBase = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');
            const vencimento = cliente.data;
            const hoje = new Date();
            const [diaVenc, mesVenc, anoVenc] = vencimento.split("/").map(num => parseInt(num));
            const dataVencimentoObj = new Date(anoVenc, mesVenc - 1, diaVenc);
            const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
            const dataVencimentoSemHora = new Date(dataVencimentoObj.getFullYear(), dataVencimentoObj.getMonth(), dataVencimentoObj.getDate());
            const vencido = dataVencimentoSemHora < hojeSemHora;
            const hora = hoje.getHours();
            let saudacao = (hora >= 6 && hora < 12) ? "Bom dia" : (hora >= 12 && hora < 18) ? "Boa tarde" : "Boa noite";
            const nomeMes = getNomeMes(parseInt(mesVenc));
            let mensagem;
            if (vencido) {
                mensagem = `${saudacao}! Lembrete de vencimento *est√° vencido* *${vencimento} (${nomeMes})*. Lembrando que pagando no dia do vencimento o mensal √© de 30 reais,ap√≥s o dia de vencimento o mensal √© de 35 reais.O pagamento via PIX pode ser feito no n√∫mero: *11950912509* (Waldemar Jose Luiz)`;
            } else {
                mensagem = `${saudacao}! Lembrete de *Vencimento*: ${cliente.data} (${nomeMes})O pagamento via PIX pode ser realizado no n√∫mero: *11947406124* (Waldemar Jose Luiz)`;
            }
            try {
                await navigator.clipboard.writeText(mensagem);
                exibirAlerta("Mensagem copiada para a √°rea de transfer√™ncia!");
            } catch (err) {
                exibirAlerta("Erro ao copiar a mensagem. Por favor, tente novamente.");
                console.error("Erro ao copiar mensagem: ", err);
            }
        }

        async function copiarMensagemWhatsAppById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                await copiarMensagemWhatsApp(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        async function enviarMensagemWhatsAppDola(index) {
            const cliente = clientesExibidos[index];
            let telefoneParaWhatsApp = cliente.telefone.replace(/\D/g, '');
            if (!telefoneParaWhatsApp) {
                exibirAlerta("N√∫mero de telefone inv√°lido!");
                return;
            }
            if (!telefoneParaWhatsApp.startsWith('55')) {
                telefoneParaWhatsApp = '55' + telefoneParaWhatsApp;
            }

            const [diaVenc, mesVenc] = cliente.data.split('/');
            const mensagemDolaLembrete = `oi me lembre todo dia ${diaVenc} de cada m√™s de pagar Tv para Luiz no pix 11947406124 no nome de Waldemar jose luiz.`;
            const urlDola = `https://wa.me/16502234435?text=${encodeURIComponent(mensagemDolaLembrete)}`;
            const nomeMes = getNomeMes(parseInt(mesVenc));
            const mensagemCliente = `Ol√°! Lembrete de vencimento do seu plano de TV. üìÖ Vencimento: ${cliente.data} (${nomeMes}).üí≥ Pix: 11947406124 (Waldemar Jos√© Luiz).\nüîî Para ser lembrado automaticamente todo m√™s, clique em "Conversar" no link abaixo, ative o lembrete com o Dola e depois confirme aqui comigo se deu certo:\n${urlDola}\n‚ùì Qualquer d√∫vida, entre em contato.`;
            const urlFinal = `https://wa.me/${telefoneParaWhatsApp}?text=${encodeURIComponent(mensagemCliente)}`;
            window.open(urlFinal, '_blank');

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            let clienteOriginal = clientes.find(c => c.id === cliente.id);
            if (clienteOriginal) {
                clienteOriginal.oculto = false;
                clienteOriginal.dola_sent = true;
                clienteOriginal.clicado = true;
            }
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("mensagem Dola enviada", cliente.nome);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao enviar mensagem WhatsApp: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha no envio de mensagem Dola", cliente.nome);
            }
        }

        async function enviarMensagemWhatsApp(clienteNome, clienteTelefone, index) {
            let telefoneParaWhatsApp = clienteTelefone.replace(/\D/g, '');
            if (!telefoneParaWhatsApp) {
                exibirAlerta("N√∫mero de telefone inv√°lido!");
                return;
            }
            if (!telefoneParaWhatsApp.startsWith('55')) {
                telefoneParaWhatsApp = '55' + telefoneParaWhatsApp;
            }
            const cliente = clientesExibidos[index];
            const vencimento = cliente.data;
            const hoje = new Date();
            const [diaVenc, mesVenc, anoVenc] = vencimento.split("/").map(num => parseInt(num));
            const dataVencimentoObj = new Date(anoVenc, mesVenc - 1, diaVenc);
            const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
            const dataVencimentoSemHora = new Date(dataVencimentoObj.getFullYear(), dataVencimentoObj.getMonth(), dataVencimentoObj.getDate());
            const vencido = dataVencimentoSemHora < hojeSemHora;
            const hora = hoje.getHours();
            let saudacao = (hora >= 6 && hora < 12) ? "Bom dia" : (hora >= 12 && hora < 18) ? "Boa tarde" : "Boa noite";
            const nomeMes = getNomeMes(parseInt(mesVenc));
            let mensagem;
            if (vencido) {
                mensagem = `${saudacao}! Lembrete de *vencimento* *${vencimento} (${nomeMes})*. Lembrando que pagando no dia do vencimento o mensal √© de 30 reais,ap√≥s o dia de vencimento o mensal √© de 35 reais.O pagamento via PIX pode ser feito no n√∫mero: *11947406124* (Waldemar Jose Luiz)`;
            } else {
                mensagem = `${saudacao}! Lembrete de vencimento *Vencimento*: ${cliente.data} (${nomeMes})O pagamento via PIX pode ser realizado no n√∫mero: *11947406124* (Waldemar Jose Luiz)`;
            }
            const url = `https://wa.me/${telefoneParaWhatsApp}?text=${encodeURIComponent(mensagem)}`;
            window.open(url, '_blank');

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            let clienteOriginal = clientes.find(c => c.id === cliente.id);
            if (clienteOriginal) {
                clienteOriginal.avisado = true;
                clienteOriginal.oculto = false;
                clienteOriginal.clicado = true;
            }
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("mensagem WhatsApp enviada", cliente.nome);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao enviar mensagem WhatsApp: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha no envio de mensagem", cliente.nome);
            }
        }

        function exportarClientes() {
            const clientesParaExportar = clientes.map(c => ({
                id: c.id,
                data: c.data,
                nome: c.nome,
                telefone: c.telefone,
                avisado: c.avisado || false,
                debito: c.debito || false,
                Produto: c.Produto || "N√£o informado",
                arquivado: c.arquivado || false,
                oculto: c.oculto || false,
                reexibirEm: c.reexibirEm || null,
                desativado: c.desativado || false,
                dola_sent: c.dola_sent || false,
                clicado: c.clicado || false
            }));
            const clientesJson = JSON.stringify(clientesParaExportar, null, 4);
            const blob = new Blob([clientesJson], {
                type: "application/json"
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "clientes.json";
            link.click();
            atualizarUltimaAtualizacao("clientes exportados");
        }

        async function importarClientes(file = null) {
            let fileToImport = file;
            if (!fileToImport) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => importarClientes(e.target.files[0]);
                input.click();
                return;
            }

            mostrarCarregando();
            const reader = new FileReader();
            reader.onload = async () => {
                try {
                    saveStateToHistory();
                    const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
                    const clientesImportadosRaw = JSON.parse(reader.result);
                    const clientesProcessados = clientesImportadosRaw.map(c => {
                        const telefoneLimpo = c.telefone ? String(c.telefone).replace(/[^\d]/g, '') : '';
                        const id = telefoneLimpo.length >= 5 ? telefoneLimpo.slice(-5) : null;
                        const nomeAjustado = c.Produto && !c.nome.includes(`(${c.Produto})`) ?
                            `${c.nome.replace(/\s\(UniTv\)|\(Duplecast\)/g, '').trim()} (${c.Produto})` : c.nome;
                        return {
                            id: id,
                            data: c.data,
                            nome: nomeAjustado,
                            telefone: telefoneLimpo,
                            avisado: c.avisado || false,
                            debito: c.debito || false,
                            Produto: c.Produto || "N√£o informado",
                            arquivado: c.arquivado || false,
                            oculto: c.oculto || false,
                            reexibirEm: c.reexibirEm || null,
                            desativado: c.desativado || false,
                            dola_sent: c.dola_sent || false,
                            clicado: c.clicado || false
                        };
                    });

                    let novosClientesAdicionados = 0,
                        clientesAtualizados = 0,
                        clientesIgnorados = 0;

                    for (const clienteImportado of clientesProcessados) {
                        if (!clienteImportado.id) {
                            clientesIgnorados++;
                            continue;
                        }
                        const indexClienteExistente = clientes.findIndex(c => c.id === clienteImportado.id);
                        if (indexClienteExistente !== -1) {
                            clientes[indexClienteExistente] = { ...clientes[indexClienteExistente],
                                ...clienteImportado
                            };
                            clientesAtualizados++;
                        } else {
                            clientes.push(clienteImportado);
                            novosClientesAdicionados++;
                        }
                    }

                    saveClientsToLocalStorage();
                    chamarFiltroAtual();
                    atualizarContadores();
                    prepararClientesVencidosParaMensagem();
                    exibirAlerta(`Importa√ß√£o conclu√≠da: ${novosClientesAdicionados} novos, ${clientesAtualizados} atualizados, ${clientesIgnorados} ignorados.`);
                    atualizarUltimaAtualizacao("clientes importados/atualizados");

                    await salvarClientes();
                } catch (error) {
                    exibirAlerta("Erro ao importar JSON. Verifique o arquivo.");
                    console.error("Erro ao importar:", error);
                } finally {
                    esconderCarregando();
                }
            };
            reader.readAsText(fileToImport);
        }

        function filtrarHoje() {
            filtroAtual = "hoje";
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
        }

        function filtrarAmanha() {
            filtroAtual = "amanha";
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
        }

        function filtrarVencidos() {
            filtroAtual = "vencidos";
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
        }

        function filtrarDebito() {
            filtroAtual = "debito";
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
        }

        function chamarFiltroAtual() {
            const filtros = {
                "hojeEVencidos": filtrarHojeEVencidos,
                "hoje": filtrarHoje,
                "amanha": filtrarAmanha,
                "vencidos": filtrarVencidos,
                "debito": filtrarDebito,
                "verDepois": filtrarVerDepois,
                "arquivados": filtrarArquivados,
                "desativados": filtrarDesativados,
                "todos": exibirTodos
            };
            if (filtros[filtroAtual]) {
                filtros[filtroAtual]();
            } else if (filtroAtual.startsWith("produto:")) {
                filtrarPorProduto(filtroAtual.split(":")[1]);
            } else {
                filtrarHojeEVencidos();
            }
        }

        function exibirTodos() {
            filtroAtual = "todos";
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
        }

        function confirmarLimparTodos() {
            exibirConfirmacaoGenerica("Limpar Todos os Clientes", "Tem certeza que deseja limpar **TODOS** os clientes? Essa a√ß√£o n√£o pode ser desfeita!", limparTodos, true);
        }

        function confirmarDesfazer() {
            if (historicoClientes.length <= 1) {
                exibirAlerta("N√£o h√° a√ß√µes para desfazer.");
                return;
            }
            exibirConfirmacaoGenerica("Desfazer √öltima A√ß√£o", "Tem certeza que deseja desfazer a √∫ltima altera√ß√£o?", desfazer, false);
        }

        function confirmarRefazer() {
            if (redoHistory.length === 0) {
                exibirAlerta("N√£o h√° a√ß√µes para refazer.");
                return;
            }
            exibirConfirmacaoGenerica("Refazer √öltima A√ß√£o", "Tem certeza que deseja refazer a √∫ltima a√ß√£o desfeita?", refazer, false);
        }

        async function limparTodos() {
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            clientes = [];
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("lista limpa", "");
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (e) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao limpar clientes no Google Sheets: ${e.message}. A√ß√£o desfeita localmente.`);
            }
        }

        async function desfazer() {
            if (historicoClientes.length <= 1) return;
            redoHistory.push(JSON.parse(JSON.stringify(clientes)));
            historicoClientes.pop();
            clientes = JSON.parse(JSON.stringify(historicoClientes[historicoClientes.length - 1]));
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            prepararClientesVencidosParaMensagem();
            atualizarUltimaAtualizacao("a√ß√£o desfeita");
            await salvarClientes();
        }

        async function refazer() {
            if (redoHistory.length === 0) return;
            historicoClientes.push(JSON.parse(JSON.stringify(clientes)));
            clientes = redoHistory.pop();
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            prepararClientesVencidosParaMensagem();
            atualizarUltimaAtualizacao("a√ß√£o refeita");
            await salvarClientes();
        }

        function editar(index) {
            let cliente = clientesExibidos[index];
            const modalEdicao = document.getElementById("modalEdicao");
            modalEdicao.style.display = "flex";
            const nomeLimpo = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');
            modalEdicao.innerHTML = `
                <div class="modal-content">
                    <h3>Editar Cliente</h3>
                    <input type="text" id="novoNome" value="${nomeLimpo}" placeholder="Nome"><br><br>
                    <input type="tel" id="novoTelefone" value="${cliente.telefone}" placeholder="Telefone"><br><br>
                    <input type="date" id="novaData" value="${formatarParaInputDate(cliente.data)}"><br><br>
                    <div>
                        <label><input type="radio" name="editarProduto" value="UniTv" ${cliente.Produto === "UniTv" ? "checked" : ""}> UniTv</label>
                        <label><input type="radio" name="editarProduto" value="Duplecast" ${cliente.Produto === "Duplecast" ? "checked" : ""}> Duplecast</label>
                    </div><br>
                    <button id="salvarBtn" class="btn-success icon-btn" title="Salvar">üíæ</button>
                    <button onclick="fecharModal()" class="btn-secondary icon-btn" title="Cancelar">‚ùå</button>
                </div>
            `;
            document.getElementById("salvarBtn").onclick = () => salvarEdicao(cliente.id);

            const novoNomeInput = document.getElementById('novoNome');
            const novoTelefoneInput = document.getElementById('novoTelefone');
            const novaDataInput = document.getElementById('novaData');

            novoNomeInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    novoTelefoneInput.focus();
                }
            });
            novoTelefoneInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    novaDataInput.focus();
                }
            });
            novaDataInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    salvarEdicao(cliente.id);
                }
            });

            document.addEventListener("keydown", fecharComEsc);
        }

        async function salvarEdicao(clientId) {
            const originalClienteIndex = clientes.findIndex(c => c.id === clientId);
            if (originalClienteIndex === -1) return;
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            let novoNome = document.getElementById("novoNome").value.trim();
            let novoTelefone = document.getElementById("novoTelefone").value.trim();
            let novaData = document.getElementById("novaData").value.trim();
            let novoProduto = document.querySelector('input[name="editarProduto"]:checked').value;
            if (!novoNome || !novaData) {
                exibirAlerta("Nome e data s√£o obrigat√≥rios!");
                return;
            }
            const telefoneLimpoEditado = novoTelefone.replace(/[^\d]/g, '');
            if (telefoneLimpoEditado.length < 5) {
                exibirAlerta("O telefone deve ter pelo menos 5 d√≠gitos.");
                return;
            }
            const novoId = telefoneLimpoEditado.slice(-5);
            if (novoId !== clientId && clientes.some(c => c.id === novoId)) {
                exibirAlerta(`O novo telefone final (${novoId}) j√° est√° em uso.`);
                return;
            }
            let nomeComNovoProduto = `${novoNome.replace(/\s\(UniTv\)|\(Duplecast\)/g, '').trim()} (${novoProduto})`;
            clientes[originalClienteIndex] = {
                ...clientes[originalClienteIndex],
                id: novoId,
                nome: nomeComNovoProduto,
                telefone: telefoneLimpoEditado,
                data: novaData.split("-").reverse().join("/"),
                Produto: novoProduto,
                dola_sent: false,
                clicado: false
            };
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            fecharModal();
            atualizarUltimaAtualizacao("editado", nomeComNovoProduto);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao salvar edi√ß√£o: ${error.message}. A√ß√£o desfeita localmente.`);
            }
        }

        function formatarParaInputDate(data) {
            let [dia, mes, ano] = data.split("/");
            return `${ano}-${mes}-${dia}`;
        }

        function excluir(index) {
            const cliente = clientesExibidos[index];
            clienteIndexParaExcluir = clientes.findIndex(c => c.id === cliente.id);
            if (clienteIndexParaExcluir !== -1) {
                document.getElementById("modalExclusao").style.display = "flex";
            }
        }

        async function confirmarExclusao() {
            if (clienteIndexParaExcluir === null) return;
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const nomeClienteExcluido = clientes[clienteIndexParaExcluir].nome;
            clientes.splice(clienteIndexParaExcluir, 1);
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            fecharModal();
            clienteIndexParaExcluir = null;
            atualizarUltimaAtualizacao("exclu√≠do", nomeClienteExcluido);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (e) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao excluir cliente no Google Sheets: ${e.message}. A√ß√£o desfeita localmente.`);
            }
        }

        function abrirModalVerDepois(index) {
            const cliente = clientesExibidos[index];
            clienteIdParaVerDepois = cliente.id;
            const amanha = new Date();
            amanha.setDate(amanha.getDate() + 1);
            document.getElementById('dataReexibicaoInput').value = amanha.toISOString().split('T')[0];
            document.getElementById('modalVerDepois').style.display = 'flex';
            document.getElementById('btnConfirmarVerDepois').onclick = confirmarVerDepois;
        }

        async function confirmarVerDepois() {
            if (!clienteIdParaVerDepois) return;
            const dataReexibicao = document.getElementById('dataReexibicaoInput').value;
            if (!dataReexibicao) {
                exibirAlerta("Por favor, selecione uma data.");
                return;
            }
            const clienteOriginalIndex = clientes.findIndex(c => c.id === clienteIdParaVerDepois);
            if (clienteOriginalIndex === -1) return;

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const nomeCliente = clientes[clienteOriginalIndex].nome;
            clientes[clienteOriginalIndex].reexibirEm = dataReexibicao;
            clientes[clienteOriginalIndex].oculto = false;
            clientes[clienteOriginalIndex].arquivado = false;
            clientes[clienteOriginalIndex].desativado = false;
            clientes[clienteOriginalIndex].clicado = false;
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            fecharModal();
            atualizarUltimaAtualizacao(`agendado para ${dataReexibicao.split('-').reverse().join('/')}`, nomeCliente);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao agendar cliente: ${error.message}. A√ß√£o desfeita localmente.`);
            }
        }

        async function desmarcarVerDepois(index) {
            const cliente = clientesExibidos[index];
            const clienteOriginalIndex = clientes.findIndex(c => c.id === cliente.id);
            if (clienteOriginalIndex === -1) return;
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const nomeCliente = clientes[clienteOriginalIndex].nome;
            clientes[clienteOriginalIndex].reexibirEm = null;
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("reexibido (agendamento removido)", nomeCliente);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao desmarcar cliente: ${error.message}. A√ß√£o desfeita localmente.`);
            }
        }

        async function toggleDesativado(index) {
            const cliente = clientesExibidos[index];
            const clienteOriginalIndex = clientes.findIndex(c => c.id === cliente.id);
            if (clienteOriginalIndex === -1) return;
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            clientes[clienteOriginalIndex].desativado = !clientes[clienteOriginalIndex].desativado;
            if (clientes[clienteOriginalIndex].desativado) {
                clientes[clienteOriginalIndex].avisado = false;
                clientes[clienteOriginalIndex].debito = false;
                clientes[clienteOriginalIndex].oculto = false;
                clientes[clienteOriginalIndex].reexibirEm = null;
                clientes[clienteOriginalIndex].arquivado = false;
                clientes[clienteOriginalIndex].clicado = false;
            }
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao(`status desativado: ${clientes[clienteOriginalIndex].desativado ? 'sim' : 'n√£o'}`, cliente.nome);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao alterar status desativado: ${error.message}. A√ß√£o desfeita localmente.`);
            }
        }

        function abrirModalAlterarProduto(index) {
            clienteIndexParaAlterarProduto = index;
            document.getElementById('modalEscolherProduto').style.display = 'flex';
        }

        async function alterarProdutoClienteConfirm(novoProduto) {
            if (clienteIndexParaAlterarProduto === null) return;
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const clienteParaAtualizar = clientesExibidos[clienteIndexParaAlterarProduto];
            let clienteOriginalIndex = clientes.findIndex(c => c.id === clienteParaAtualizar.id);
            const clienteNome = clienteParaAtualizar.nome;
            if (clienteOriginalIndex !== -1) {
                let nomeSemProduto = clientes[clienteOriginalIndex].nome.replace(/\s\(UniTv\)|\(Duplecast\)/g, '').trim();
                clientes[clienteOriginalIndex].Produto = novoProduto;
                clientes[clienteOriginalIndex].nome = `${nomeSemProduto} (${novoProduto})`;
                clientes[clienteOriginalIndex].clicado = false;
            }
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            fecharModal();
            clienteIndexParaAlterarProduto = null;
            exibirAlerta(`Produto do cliente alterado para ${novoProduto}!`);
            atualizarUltimaAtualizacao(`produto alterado para ${novoProduto}`, clienteNome);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao alterar produto: ${error.message}. A√ß√£o desfeita localmente.`);
            }
        }

        async function salvarClientes() {
            try {
                const response = await sendRequestToBackend('bulk_update_clients', {
                    clients: clientes
                });
                if (response.status !== 'success') {
                    throw new Error(response.message || 'Erro ao sincronizar com backend.');
                }
            } catch (e) {
                console.error("Erro ao salvar clientes no Google Sheets:", e);
                throw e;
            }
        }

        async function loadClientes() {
            mostrarCarregando();
            try {
                const response = await sendRequestToBackend('get_all_clients');
                if (Array.isArray(response)) {
                    clientes = response.map(c => {
                        const telefoneLimpo = String(c.telefone || '').replace(/[^\d]/g, '');
                        const clienteId = telefoneLimpo.length >= 5 ? telefoneLimpo.slice(-5) : null;
                        let dataClienteFormatada = c.data;
                        if (c.data && typeof c.data === 'string') {
                            let datePart = c.data.split('T')[0];
                            const parts = datePart.split('-');
                            if (parts.length === 3) {
                                dataClienteFormatada = `${parts[2]}/${parts[1]}/${parts[0]}`;
                            }
                        }
                        return {
                            id: c.id || clienteId,
                            data: dataClienteFormatada,
                            nome: c.nome,
                            telefone: telefoneLimpo,
                            avisado: c.avisado || false,
                            debito: c.debito || false,
                            Produto: c.Produto || "N√£o informado",
                            arquivado: c.arquivado || false,
                            oculto: c.oculto || false,
                            reexibirEm: c.reexibirEm || null,
                            desativado: c.desativado || false,
                            dola_sent: c.dola_sent || false,
                            clicado: c.clicado || false
                        };
                    }).filter(c => c.id !== null);
                    saveClientsToLocalStorage();
                } else {
                    throw new Error("Formato de dados inv√°lido.");
                }
            } catch (e) {
                console.error("Erro ao carregar do Sheets:", e);
                const cache = localStorage.getItem('clientesCache');
                if (cache) {
                    try {
                        clientes = JSON.parse(cache);
                        exibirAlerta("Erro ao carregar dados. Carregando do cache local.");
                    } catch (parseError) {
                        clientes = [];
                        exibirAlerta("Erro no Sheets e cache corrompido.");
                    }
                } else {
                    clientes = [];
                    exibirAlerta("Erro ao carregar e sem cache local.");
                }
            } finally {
                esconderCarregando();
                loadConfiguracaoBotoes();
                filtrarHojeEVencidos();
                prepararClientesVencidosParaMensagem();
                saveStateToHistory();
                loadSettings();
            }
            document.getElementById('ultimaAtualizacaoInfo').textContent = localStorage.getItem('ultimaAtualizacaoCliente') || '√öltima Altera√ß√£o: Nunca';
        }

        function debouncePesquisa() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                exibirTabela();
            }, 300);
        }

        function limparPesquisa() {
            document.getElementById("searchInput").value = "";
            exibirTodos();
        }

        const SETTINGS_KEY = 'interfaceSettings';
        const DEFAULT_SETTINGS = {
            width: 16,
            roundButtons: false,
            transparentButtons: false,
            buttonSpacing: 5,
            clientNameColor: '#007bff',
            avisadoColor: '#e0f7fa',
            debitoColor: '#fff3e0',
            vencendoHojeColor: '#fff9c4',
            vencidoColor: '#ffcdd2'
        };

        function toggleSettingsArea() {
            const settingsArea = document.getElementById('settingsArea');
            settingsArea.style.display = (settingsArea.style.display === 'block') ? 'none' : 'block';
        }
        
        function applyButtonStyles() {
            const round = document.getElementById('roundButtonsCheckbox').checked;
            const transparent = document.getElementById('transparentButtonsCheckbox').checked;
            document.body.classList.toggle('round-buttons', round);
            document.body.classList.toggle('transparent-buttons', transparent);
        }
        
        function updateButtonSpacing(value) {
            document.getElementById('buttonSpacingValue').textContent = value;
            document.documentElement.style.setProperty('--button-gap', `${value}px`);
        }
        
        function updateCssVariable(variable, value) {
            document.documentElement.style.setProperty(variable, value);
        }

        function updateInputWidth(value) {
            document.getElementById('inputWidthValue').textContent = value;
            document.querySelectorAll('.configurable-input').forEach(input => {
                input.style.flexBasis = `${value}%`;
                input.style.maxWidth = `${value}%`;
            });
        }

        function saveSettings() {
            const settings = {
                width: document.getElementById('inputWidth').value,
                roundButtons: document.getElementById('roundButtonsCheckbox').checked,
                transparentButtons: document.getElementById('transparentButtonsCheckbox').checked,
                buttonSpacing: document.getElementById('buttonSpacingSlider').value,
                clientNameColor: document.getElementById('clientNameColorPicker').value,
                avisadoColor: document.getElementById('avisadoColorPicker').value,
                debitoColor: document.getElementById('debitoColorPicker').value,
                vencendoHojeColor: document.getElementById('vencendoHojeColorPicker').value,
                vencidoColor: document.getElementById('vencidoColorPicker').value
            };
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            exibirAlerta("Ajustes salvos!");
            toggleSettingsArea();
        }

        function loadSettings() {
            let settings = { ...DEFAULT_SETTINGS };
            const savedSettings = localStorage.getItem(SETTINGS_KEY);
            if (savedSettings) {
                try {
                    settings = { ...settings, ...JSON.parse(savedSettings) };
                } catch (e) {
                    localStorage.removeItem(SETTINGS_KEY);
                }
            }
            
            // Aplicar Input Width
            document.getElementById('inputWidth').value = settings.width;
            updateInputWidth(settings.width);

            // Aplicar Estilos de Bot√£o
            document.getElementById('roundButtonsCheckbox').checked = settings.roundButtons;
            document.getElementById('transparentButtonsCheckbox').checked = settings.transparentButtons;
            applyButtonStyles();
            
            // Aplicar Espa√ßamento de Bot√£o
            document.getElementById('buttonSpacingSlider').value = settings.buttonSpacing;
            updateButtonSpacing(settings.buttonSpacing);

            // Aplicar Cor do Nome do Cliente
            document.getElementById('clientNameColorPicker').value = settings.clientNameColor;
            updateCssVariable('--client-name-color', settings.clientNameColor);

            // Aplicar Cores de Status
            document.getElementById('avisadoColorPicker').value = settings.avisadoColor;
            updateCssVariable('--avisado-color', settings.avisadoColor);

            document.getElementById('debitoColorPicker').value = settings.debitoColor;
            updateCssVariable('--debito-color', settings.debitoColor);

            document.getElementById('vencendoHojeColorPicker').value = settings.vencendoHojeColor;
            updateCssVariable('--vencendo-hoje-color', settings.vencendoHojeColor);
            
            document.getElementById('vencidoColorPicker').value = settings.vencidoColor;
            updateCssVariable('--vencido-color', settings.vencidoColor);
        }

        function resetSettings() {
            localStorage.removeItem(SETTINGS_KEY);
            exibirAlerta("Ajustes redefinidos para o padr√£o!");
            loadSettings();
        }
        
        function loadConfiguracaoBotoes() {
            const configSalva = localStorage.getItem('acaoBotoesConfig');
            if (configSalva) {
                try {
                    const parsedConfig = JSON.parse(configSalva);
                    acaoBotoesConfig = { ...defaultAcaoBotoesConfig
                    };
                    for (const key in parsedConfig) {
                        if (acaoBotoesConfig.hasOwnProperty(key)) {
                            acaoBotoesConfig[key].visivel = parsedConfig[key].visivel;
                        }
                    }
                } catch (e) {
                    console.error("Erro ao carregar configura√ß√£o de bot√µes, usando padr√£o.", e);
                    acaoBotoesConfig = JSON.parse(JSON.stringify(defaultAcaoBotoesConfig));
                }
            } else {
                acaoBotoesConfig = JSON.parse(JSON.stringify(defaultAcaoBotoesConfig));
            }
        }

        function abrirModalConfigurarBotoes() {
            const listContainer = document.getElementById('botoesConfigList');
            listContainer.innerHTML = '';
            for (const key in acaoBotoesConfig) {
                const config = acaoBotoesConfig[key];
                const checkboxId = `chk-btn-${key}`;
                const itemHtml = `
                    <div style="margin-bottom: 5px;">
                        <input type="checkbox" id="${checkboxId}" data-key="${key}" ${config.visivel ? 'checked' : ''}>
                        <label for="${checkboxId}">${config.label}</label>
                    </div>
                `;
                listContainer.innerHTML += itemHtml;
            }
            document.getElementById('modalConfigurarBotoes').style.display = 'flex';
        }

        function salvarConfiguracaoBotoes() {
            const checkboxes = document.querySelectorAll('#botoesConfigList input[type="checkbox"]');
            checkboxes.forEach(chk => {
                const key = chk.dataset.key;
                if (acaoBotoesConfig[key]) {
                    acaoBotoesConfig[key].visivel = chk.checked;
                }
            });
            localStorage.setItem('acaoBotoesConfig', JSON.stringify(acaoBotoesConfig));
            fecharModal();
            chamarFiltroAtual();
            exibirAlerta("Configura√ß√£o de bot√µes salva!");
        }

        function atualizarContadores() {
            const hoje = new Date();
            const hojeFormatada = hoje.toLocaleDateString('pt-BR');
            const hojeStr = new Date().toISOString().split('T')[0];

            const clientesVisiveis = clientes.filter(c => !c.arquivado && !c.oculto && !c.desativado && (!c.reexibirEm || c.reexibirEm <= hojeStr));
            const countHoje = clientesVisiveis.filter(c => c.data === hojeFormatada && !c.avisado).length;
            const countAmanha = clientesVisiveis.filter(c => {
                const amanha = new Date();
                amanha.setDate(amanha.getDate() + 1);
                return c.data === amanha.toLocaleDateString('pt-BR');
            }).length;
            const countVencidos = clientesVisiveis.filter(c => {
                const [dia, mes, ano] = c.data.split('/').map(Number);
                const dataCliente = new Date(ano, mes - 1, dia);
                const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                return dataCliente < hojeSemHora && !c.avisado;
            }).length;

            updateBadge('badgeHojeEVencidos', countHoje + countVencidos);
            updateBadge('badgeHoje', countHoje);
            updateBadge('badgeAmanha', countAmanha);
            updateBadge('badgeVencidos', countVencidos);
            updateBadge('badgeDebito', clientesVisiveis.filter(c => c.debito).length);
            updateBadge('badgeArquivados', clientes.filter(c => c.arquivado).length);
            updateBadge('badgeDesativados', clientes.filter(c => c.desativado).length);
            updateBadge('badgeVerDepois', clientes.filter(c => c.reexibirEm && c.reexibirEm > hojeStr).length);
            updateBadge('badgeOcultos', clientes.filter(c => c.oculto && !c.arquivado && !c.reexibirEm && !c.desativado).length);
            updateBadge('badgeCentralMessage', clientesVencidosParaMensagem.length);
        }

        function updateBadge(badgeId, count) {
            const badge = document.getElementById(badgeId);
            if (badge) {
                badge.style.display = count > 0 ? 'inline-block' : 'none';
                badge.textContent = count;
            }
        }

        function mostrarContagemProdutos() {
            const clientesAtivos = clientes.filter(c => !c.arquivado && !c.oculto && !c.desativado);
            document.getElementById('countUniTv').textContent = clientesAtivos.filter(c => c.Produto === 'UniTv').length;
            document.getElementById('countDuplecast').textContent = clientesAtivos.filter(c => c.Produto === 'Duplecast').length;
            document.getElementById('modalContagemProdutos').style.display = 'flex';
        }

        function prepararClientesVencidosParaMensagem() {
            const hoje = new Date();
            const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
            const hojeStr = hoje.toISOString().split('T')[0];
            clientesVencidosParaMensagem = clientes.filter(c => {
                const [dia, mes, ano] = c.data.split("/").map(Number);
                const dataCliente = new Date(ano, mes - 1, dia);
                const isVencidoOuHoje = dataCliente.getTime() <= hojeSemHora.getTime();
                const isVisivel = !c.reexibirEm || c.reexibirEm <= hojeStr;
                return isVencidoOuHoje && isVisivel && !c.avisado && !c.arquivado && !c.oculto && !c.desativado;
            });
            atualizarContadores();
        }

        function enviarProximoClienteVencido() {
            prepararClientesVencidosParaMensagem();
            if (clientesVencidosParaMensagem.length === 0) {
                exibirAlerta("N√£o h√° clientes vencidos para enviar mensagem.");
                return;
            }
            const cliente = clientesVencidosParaMensagem[0];
            const nomeExibicaoBase = cliente.nome.replace(/\s\(UniTv\)|\(Duplecast\)/g, '').trim();
            const originalClientesExibidos = clientesExibidos;
            clientesExibidos = [cliente];
            enviarMensagemWhatsApp(nomeExibicaoBase, cliente.telefone, 0);
            clientesExibidos = originalClientesExibidos;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById('dataInput').value = today.toISOString().split('T')[0];
            document.getElementById('dataAtual').innerText = today.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit'
            });

            document.getElementById('dataInput').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    document.getElementById('nomeInput').focus();
                }
            });
            document.getElementById('nomeInput').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    document.getElementById('telefoneInput').focus();
                }
            });
            document.getElementById('telefoneInput').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    adicionarCliente();
                }
            });

            loadClientes();
        });
    </script>
</body>
</html>

