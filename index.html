
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Clientes</title>
    <style>
        /* Estilos gerais */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --white-color: #fff;
            --font-family: 'Segoe UI', Arial, sans-serif;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --button-gap: 5px;
            --client-name-color: #007bff;
            --avisado-color: #e0f7fa;
            --debito-color: #fff3e0;
            --vencendo-hoje-color: #fff9c4;
            --vencido-color: #ffcdd2;
        }

        body {
            font-family: var(--font-family);
            padding: 20px;
            padding-top: 20px;
            background-color: #f4f7f9;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 2000px;
            margin: auto;
            background: var(--white-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        h1, h3 {
            text-align: center;
            color: var(--primary-color);
        }

        /* Estilos para Inputs e R√°dios */
        input[type="text"],
        input[type="tel"],
        input[type="date"],
        textarea {
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
            width: 100%;
        }

        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="date"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        .input-group-horizontal {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group-horizontal .input-wrapper {
            flex: 1;
            min-width: 150px;
        }
        
        div > label {
            margin-right: 15px;
            font-weight: 500;
        }

        /* --- NOVOS ESTILOS DE BOT√ÉO --- */
        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: var(--font-family);
            font-weight: bold;
            font-size: 1em;
            color: var(--white-color);
            background-color: var(--primary-color);
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            min-width: 44px;
            min-height: 44px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        button.icon-btn {
            padding: 0;
            width: 44px;
            height: 44px;
            font-size: 1.2em;
        }
        
        .pulsing-btn {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
        }

        /* Varia√ß√µes de Cor dos Bot√µes */
        button.btn-secondary { background-color: var(--secondary-color); }
        button.btn-success { background-color: var(--success-color); }
        button.btn-danger { background-color: var(--danger-color); }
        button.btn-warning { background-color: var(--warning-color); color: var(--dark-color); }
        button.btn-info { background-color: var(--info-color); }

        .btn-debito-segurar { background-color: var(--warning-color); color: var(--dark-color); }
        .btn-renovar-data-atual { background-color: var(--warning-color); color: var(--dark-color); }
        .modal-confirm-danger { background-color: var(--danger-color); }
        .btn-dola { background-color: #ff9800; }
        .btn-dola-sent { background-color: var(--success-color); }
        
        #centralMessageButton {
            padding: 15px 30px;
            font-size: 1.2em;
            background-color: var(--success-color);
            border-radius: 10px;
        }

        /* Estilos da Tabela */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            display: none;
        }

        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
            vertical-align: middle;
        }

        td {
            display: flex;
            align-items: center;
            flex-wrap: wrap; 
            gap: var(--button-gap);
        }
        
        td button {
            padding: 8px;
            font-size: 1.2em;
            margin: 2px;
            width: 40px;
            height: 40px;
            line-height: 1;
        }
        
        td a {
            font-weight: bold;
            color: var(--client-name-color);
            text-decoration: none;
            transition: color 0.2s;
            margin-right: 15px;
        }
        td a:hover {
            filter: brightness(85%);
        }

        tr.avisado { background-color: var(--avisado-color) !important; }
        tr.debito { background-color: var(--debito-color) !important; }
        tr.vencendo-hoje { background-color: var(--vencendo-hoje-color) !important; }
        tr.vencido { background-color: var(--vencido-color) !important; }

        .center { text-align: center; }

        a.cliente-clicado, a.cliente-clicado:link, a.cliente-clicado:visited, a.cliente-clicado:hover, a.cliente-clicado:active {
            color: var(--success-color) !important;
            font-style: italic;
        }
        
        body.round-buttons td button,
        body.round-buttons .icon-btn {
            border-radius: 50%;
        }

        body.transparent-buttons td button {
            background-color: transparent;
            color: var(--dark-color);
            box-shadow: none;
            border: 1px solid transparent;
        }
        body.transparent-buttons td button:hover {
            background-color: rgba(0, 0, 0, 0.05);
            border-color: #ddd;
        }
        body.transparent-buttons td button.btn-danger { color: var(--danger-color); }
        body.transparent-buttons td button.btn-success { color: var(--success-color); }
        body.transparent-buttons td button.btn-info { color: var(--info-color); }
        body.transparent-buttons td button.btn-warning { color: #c69500; }
        body.transparent-buttons td button.btn-dola { color: #ff9800; }
        body.transparent-buttons td button.btn-dola-sent { color: var(--success-color); }

        /* Estilos de Modal */
                .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            /* Responsivo: garante espa√ßo nas bordas e evita ‚Äúcortar‚Äù o conte√∫do */
            padding: 16px;
            box-sizing: border-box;
        }

                .modal-content {
            background-color: var(--white-color);
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            width: 90%;
            max-width: 450px;
            box-shadow: var(--box-shadow);

            /* Responsivo: rolagem interna quando o conte√∫do √© grande */
            max-height: calc(100vh - 32px);
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal .modal-content button {
            margin-top: 10px;
        }

        
        @media (max-width: 480px) {
            .modal-content {
                width: 100%;
                padding: 16px;
                border-radius: 14px;
            }
            #modalPopupVencendo .modal-content {
                max-width: 100%;
            }
        }
.settings-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            background-color: var(--primary-color);
            color: var(--white-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--box-shadow);
            z-index: 999;
            transition: all 0.3s;
        }

        .settings-icon:hover {
            background-color: #0056b3;
            transform: rotate(45deg);
        }

        #settingsArea {
            display: none;
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 30px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        #settingsArea label { display: block; margin-bottom: 10px; font-weight: bold; }
        #settingsArea input[type="range"] { width: 100%; margin-bottom: 15px; }
        #settingsArea h4 { margin-top: 20px; color: var(--secondary-color); border-bottom: 1px solid #ddd; padding-bottom: 5px;}
        #settingsArea .color-picker-label { display: flex; align-items: center; gap: 10px;}

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--danger-color);
            color: var(--white-color);
            border-radius: 50%;
            padding: 4px 7px;
            font-size: 0.75em;
            min-width: 18px;
            text-align: center;
            line-height: 1;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    
        .bulk-bar {
            position: sticky;
            top: 0;
            z-index: 1500;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(6px);
            border: 1px solid #e6e6e6;
            border-radius: var(--border-radius);
            padding: 10px;
            margin: 10px 0 15px;
            display: none;
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
        }
        .bulk-bar .bulk-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }
        .bulk-bar .bulk-count {
            font-weight: 700;
            color: var(--dark-color);
            margin-right: 6px;
        }
        .bulk-bar .bulk-hint {
            color: #666;
            font-size: 0.9em;
            margin-left: 6px;
        }
        .select-cliente {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            accent-color: var(--primary-color);
            cursor: pointer;
        }
        .row-selected {
            outline: 2px solid rgba(0,123,255,0.25);
            outline-offset: -2px;
        }
    
        .section-header {
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
            flex-wrap:wrap;
            margin-top: 10px;
        }
        .collapse-btn {
            background: var(--secondary-color);
            color: var(--white-color);
            padding: 8px 14px;
            border-radius: var(--border-radius);
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .collapse-btn:hover { filter: brightness(0.95); }
        .collapsed { display: none !important; }

        /* === POP-UP: Clientes com 3 dias para vencer === */
        #modalPopupVencendo .modal-content { max-width: 900px; }
        #popupVencendoLista { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
        .popup-card {
            border: 1px solid #e6e6e6;
            border-radius: 10px;
            padding: 12px;
            background: #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            display:flex;
            flex-direction:column;
            gap:8px;
        }
        .popup-card .top {
            display:flex;
            flex-wrap:wrap;
            gap:10px;
            align-items:center;
            justify-content:space-between;
        }
        .popup-card .meta {
            display:flex;
            flex-wrap:wrap;
            gap:10px;
            color:#555;
            font-size:0.95em;
        }
        .popup-card .actions {
            display:flex;
            flex-wrap:wrap;
            gap: var(--button-gap);
        }
        .popup-muted { color:#777; font-size:0.95em; }
        #popupConfigLista { max-height: 50vh; overflow:auto; border:1px solid #eee; border-radius:10px; padding:10px; }
        .popup-config-row {
            display:flex;
            gap:10px;
            align-items:flex-start;
            padding:8px;
            border-bottom:1px solid #f0f0f0;
        }
        .popup-config-row:last-child { border-bottom:none; }
        .popup-config-row label { cursor:pointer; }
        .popup-config-row .info { flex:1; }

        /* ===== Painel de Logs ===== */
        #debugLogPanel{
            position: fixed;
            right: 14px;
            bottom: 14px;
            width: min(780px, calc(100vw - 28px));
            max-height: min(70vh, 520px);
            z-index: 2500;
            background: rgba(255,255,255,0.97);
            border: 1px solid rgba(0,0,0,0.10);
            border-radius: 14px;
            box-shadow: 0 18px 40px rgba(0,0,0,0.18);
            display: none;
            overflow: hidden;
        }
        #debugLogPanel.open{ display: flex; flex-direction: column; }
        #debugLogPanel .log-head{
            display:flex;
            align-items:center;
            justify-content: space-between;
            gap:10px;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }
        #debugLogPanel .log-head b{ font-size: 14px; }
        #debugLogPanel .log-actions{
            display:flex;
            gap:8px;
            align-items:center;
            flex-wrap: wrap;
        }
        #debugLogPanel .log-body{
            padding: 10px 12px;
            overflow: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            line-height: 1.35;
            white-space: pre-wrap;
        }
        #debugLogPanel .log-body .err{ color: #b40000; font-weight: 700; }
        #debugLogPanel .log-body .warn{ color: #8a5a00; font-weight: 700; }
        #debugLogPanel .log-body .ok{ color: #006b2e; font-weight: 700; }
        
        /* Toast Notification */
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 16px;
            position: fixed;
            z-index: 2100;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
        }
        .toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
        
        /* Ajuste para topbar */
        .topQuickBar-right {
            position: absolute;
            top: 5px;
            right: 15px;
        }
        .topQuickBar-status {
            font-size: 0.85em;
            color: #666;
            background: rgba(255,255,255,0.8);
            padding: 3px 8px;
            border-radius: 4px;
        }

    </style>
</head>
<body>

    <div class="topQuickBar-right">
        <span id="topQuickBarStatus" class="topQuickBar-status">Status: pronto</span>
    </div>

    <div id="ultimaAtualizacaoInfo" style="position: static; margin: 10px 0; font-size: 0.9em; color: #555; background-color: #f9f9f9; padding: 5px 10px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        √öltima Altera√ß√£o: Nunca
    </div>
    <div class="container">
        <h1>Controle de Clientes</h1>

        <!-- Barra de a√ß√µes em lote -->
        <div id="bulkBar" class="bulk-bar" aria-live="polite">
            <div class="bulk-row">
                <span class="bulk-count" id="bulkCount">0 selecionados</span>
                <button onclick="selecionarTodosVisiveis()" class="btn-info">Selecionar todos (filtro atual)</button>
                <button onclick="limparSelecao()" class="btn-secondary">Limpar sele√ß√£o</button>
                <span class="bulk-hint">A√ß√µes em lote:</span>
                <button onclick="acaoEmLote('arquivar')" class="btn-secondary">Arquivar</button>
                <button onclick="acaoEmLote('desarquivar')" class="btn-success">Desarquivar</button>
                <button onclick="acaoEmLote('desativar')" class="btn-secondary">Desativar</button>
                <button onclick="acaoEmLote('reativar')" class="btn-success">Reativar</button>
                <button onclick="acaoEmLote('avisado')" class="btn-info">Marcar Avisado</button>
                <button onclick="acaoEmLote('desavisar')" class="btn-secondary">Desmarcar Avisado</button>
                <button onclick="abrirModalVerDepoisLote()" class="btn-warning">Ver Depois (data)</button>
                <button onclick="exportarSelecionados()" class="btn-secondary">Exportar Selecionados</button>
                <button onclick="acaoEmLote('renovarMes')" class="btn-success">Renovar Pr√≥x. M√™s</button>
                <button onclick="acaoEmLote('renovarHoje')" class="btn-warning">Renovar HOJE</button>
                <button onclick="acaoEmLote('debitoOn')" class="btn-warning">Marcar D√©bito</button>
                <button onclick="acaoEmLote('debitoOff')" class="btn-secondary">Remover D√©bito</button>
                <button onclick="abrirModalProdutoLote()" class="btn-info">Trocar Produto</button>
                <button onclick="abrirModalCobrancaLote()" class="btn-info">Definir Cobran√ßa</button>
            </div>
        </div>

        <button id="centralMessageButton" onclick="enviarProximoClienteVencido()">
            Enviar Mensagem para Pr√≥ximo Vencido
            <span id="badgeCentralMessage" class="notification-badge" style="display:none;"></span>
        </button>
        <button onclick="importarClientes()" class="btn-info icon-btn" title="Importar Clientes (JSON)">üì•</button>
        <button onclick="exportarClientes()" class="btn-secondary icon-btn" title="Exportar Clientes (JSON)">üì§</button>

        <div class="section-header">
            <h3 style="margin:0;">Adicionar Cliente</h3>
            <button id="toggleAddSectionBtn" type="button" class="collapse-btn" onclick="toggleAddSection()">Recolher ‚ñ≤</button>
        </div>

        <div id="addClientSection">
            <div class="input-group-horizontal">
                <div class="input-wrapper"><input type="date" id="dataInput" required title="Data de Vencimento"></div>
                <div class="input-wrapper"><input type="text" id="nomeInput" placeholder="Nome do Cliente" required></div>
                <div class="input-wrapper"><input type="tel" id="telefoneInput" placeholder="Telefone (ex: 11999999999)" required></div>
                <div class="input-wrapper"><input type="date" id="dataCobrancaInput" title="Data de Cobran√ßa (Opcional)"></div>
            </div>
            <textarea id="observacaoInput" placeholder="Observa√ß√£o (Opcional)"></textarea>
            <div>
                <label>
                    <input type="radio" name="produto" value="UniTv" checked> UniTv
                </label>
                <label>
                    <input type="radio" name="produto" value="Duplecast"> Duplecast
                </label>
            </div>
            <div class="add-client-actions" style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:10px;">
                <button onclick="adicionarCliente()" class="btn-success">‚ûï Adicionar Cliente</button>
                <button onclick="abrirModalGerenciarPopup()" class="btn-info">‚öôÔ∏è Gerenciar Pop-up</button>
                <button onclick="abrirModalPopupConfig()" class="btn-secondary">üë• Importar P/ Pop-up</button>
            </div>
        </div>

        <h3>Filtros e A√ß√µes</h3>
        <button onclick="filtrarHojeEVencidos()">Vencendo Hoje + Vencidos <span id="badgeHojeEVencidos" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarCobrancaHoje()" class="btn-info">Cobran√ßa Hoje <span id="badgeCobrancaHoje" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarHoje()">Clientes Vencendo Hoje <span id="badgeHoje" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarAmanha()">Clientes Vencendo Amanh√£ <span id="badgeAmanha" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarVencidos()">Clientes Vencidos <span id="badgeVencidos" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarDebito()" class="btn-warning">Clientes com D√©bito <span id="badgeDebito" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarVerDepois()" class="btn-secondary">Ver Depois <span id="badgeVerDepois" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarArquivados()" class="btn-secondary">Arquivados <span id="badgeArquivados" class="notification-badge" style="display:none;"></span></button>
        <button onclick="filtrarDesativados()" class="btn-secondary">Clientes Desativados <span id="badgeDesativados" class="notification-badge" style="display:none;"></span></button>
        <button onclick="mostrarContagemProdutos()" class="btn-info">Produtos</button>
        <button onclick="exibirTodos()">Reexibir Todos</button>
        <button onclick="confirmarLimparTodos()" class="btn-danger icon-btn" title="Limpar Todos">üóëÔ∏è</button>
        <button onclick="confirmarDesfazer()" class="btn-secondary icon-btn" title="Desfazer">‚Ü©Ô∏è</button>
        <button onclick="confirmarRefazer()" class="btn-secondary icon-btn" title="Refazer">‚Ü™Ô∏è</button>

        <h3>Pesquisa de Clientes</h3>
        <input type="text" id="searchInput" placeholder="Pesquisar por nome ou telefone" oninput="debouncePesquisa()">
        <button onclick="limparPesquisa()" class="btn-secondary icon-btn" title="Limpar Pesquisa">‚ùå</button>

        <table>
            <thead>
                <tr>
                    <th>Cliente e A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="tabelaClientes"></tbody>
        </table>

        <hr>
        <h3>Data Atual</h3>
        <p id="dataAtual"></p>

        <div class="settings-icon" onclick="toggleSettingsArea()" title="Ajustes">‚öôÔ∏è</div>
        <div id="settingsArea">
            <h3>Ajustes de Interface</h3>
            
            <h4>Layout e Cores</h4>
            <label for="inputWidth">Largura dos Inputs (%): <span id="inputWidthValue"></span></label>
            <input type="range" id="inputWidth" min="10" max="100" value="16" oninput="updateInputWidth(this.value)">
            <label class="color-picker-label">
                Cor do Nome do Cliente
                <input type="color" id="clientNameColorPicker" oninput="updateCssVariable('--client-name-color', this.value)">
            </label>
             <label class="color-picker-label">
                Fundo "Avisado"
                <input type="color" id="avisadoColorPicker" oninput="updateCssVariable('--avisado-color', this.value)">
            </label>
            <label class="color-picker-label">
                Fundo "D√©bito"
                <input type="color" id="debitoColorPicker" oninput="updateCssVariable('--debito-color', this.value)">
            </label>
            <label class="color-picker-label">
                Fundo "Vencendo Hoje"
                <input type="color" id="vencendoHojeColorPicker" oninput="updateCssVariable('--vencendo-hoje-color', this.value)">
            </label>
            <label class="color-picker-label">
                Fundo "Vencido"
                <input type="color" id="vencidoColorPicker" oninput="updateCssVariable('--vencido-color', this.value)">
            </label>

            <h4>Bot√µes de A√ß√£o</h4>
            <label>
                <input type="checkbox" id="roundButtonsCheckbox" onchange="applyButtonStyles()"> Bot√µes Redondos
            </label>
            <label>
                <input type="checkbox" id="transparentButtonsCheckbox" onchange="applyButtonStyles()"> Fundo Transparente
            </label>
            <label for="buttonSpacingSlider">Espa√ßamento (px): <span id="buttonSpacingValue">5</span></label>
            <input type="range" id="buttonSpacingSlider" min="0" max="20" value="5" oninput="updateButtonSpacing(this.value)">

            <button onclick="abrirModalConfigurarBotoes()">Configurar Bot√µes Vis√≠veis</button>
            <button onclick="saveSettings()" class="btn-success icon-btn" title="Salvar Ajustes">üíæ</button>
            <button onclick="resetSettings()" class="btn-secondary icon-btn" title="Redefinir Padr√£o">üîÑ</button>
            <hr>
        </div>

        <!-- Modais -->
        <div id="modalConfirmacao" class="modal">
            <div class="modal-content">
                <h3>Confirmar Duplica√ß√£o</h3>
                <p>Voc√™ tem certeza que deseja duplicar este cliente?</p>
                <button onclick="confirmarDuplicacao()" class="btn-success">Confirmar</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>
        <div id="modalExclusao" class="modal">
            <div class="modal-content">
                <h3>Confirmar Exclus√£o</h3>
                <p>Voc√™ tem certeza que deseja excluir este cliente?</p>
                <button onclick="confirmarExclusao()" class="btn-danger">Confirmar</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>
        <div id="modalRenovarComDebito" class="modal">
            <div class="modal-content">
                <h3>Renovar com D√©bito?</h3>
                <p>Tem certeza que deseja renovar este cliente e marc√°-lo como D√©bito?</p>
                <button id="btnConfirmarRenovacaoDebito" class="btn-warning">Confirmar</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>
        <div id="modalConfirmacaoGenerica" class="modal">
            <div class="modal-content">
                <h3 id="modalConfirmacaoGenericaTitulo">Confirma√ß√£o</h3>
                <p id="modalConfirmacaoGenericaMensagem">Tem certeza?</p>
                <button id="btnConfirmacaoGenericaConfirmar">Confirmar</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>
        <div id="modalEdicao" class="modal" style="display: none;"></div>
        <div id="modalAlerta" class="modal" style="display: none;"></div>
        <div id="modalContagemProdutos" class="modal">
            <div class="modal-content">
                <h3>Contagem de Produtos</h3>
                <p>UniTv: <span id="countUniTv">0</span> clientes <button onclick="filtrarPorProduto('UniTv')">Detalhes</button></p>
                <p>Duplecast: <span id="countDuplecast">0</span> clientes <button onclick="filtrarPorProduto('Duplecast')">Detalhes</button></p>
                <button onclick="fecharModal()" class="btn-secondary">Fechar</button>
            </div>
        </div>
        <div id="modalEscolherProduto" class="modal">
            <div class="modal-content">
                <h3>Escolher Tipo de Produto</h3>
                <p>Selecione o tipo de produto para o cliente:</p>
                <button onclick="alterarProdutoClienteConfirm('UniTv')">UniTv</button>
                <button onclick="alterarProdutoClienteConfirm('Duplecast')">Duplecast</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>
        <div id="modalConflitoIdNome" class="modal" style="display: none;">
            <div class="modal-content">
                <h3>Conflito de Cliente por ID</h3>
                <p>O cliente importado possui o mesmo ID final de telefone (<span id="conflitoId"></span>) que um cliente existente, mas os nomes s√£o diferentes.</p>
                <p><b>Cliente Existente:</b> <span id="conflitoNomeExistente"></span></p>
                <p><b>Cliente Importado:</b> <span id="conflitoNomeImportado"></span></p>
                <p>O que deseja fazer?</p>
                <button id="btnConflitoManterExistente">Manter o Existente</button>
                <button id="btnConflitoUsarImportado" class="btn-warning">Atualizar Cliente Existente</button>
                <button id="btnConflitoManterAmbos" class="btn-info">Manter Ambos (Criar Novo Cliente)</button>
                <button onclick="cancelarConflitoIdNome()" class="btn-secondary">Cancelar Importa√ß√£o Deste</button>
            </div>
        </div>
        
        <div id="modalVerDepois" class="modal">
            <div class="modal-content">
                <h3>Agendar Reexibi√ß√£o</h3>
                <p>Escolha a data em que este cliente deve voltar a aparecer na lista principal.</p>

                <form id="formVerDepois">
                    <input type="date" id="dataReexibicaoInput" required style="width: 90%; padding: 10px; margin: 10px 0;">
                    
                    <div style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin: 6px 0 12px;">
                        <button type="button" onclick="setDatePlusDays('dataReexibicaoInput', 1)" class="btn-secondary">+1d</button>
                        <button type="button" onclick="setDatePlusDays('dataReexibicaoInput', 3)" class="btn-secondary">+3d</button>
                        <button type="button" onclick="setDatePlusDays('dataReexibicaoInput', 7)" class="btn-secondary">+7d</button>
                        <button type="button" onclick="setDatePlusDays('dataReexibicaoInput', 15)" class="btn-secondary">+15d</button>
                        <button type="button" onclick="setDatePlusDays('dataReexibicaoInput', 30)" class="btn-secondary">+30d</button>
                    </div>
                    <button id="btnConfirmarVerDepois" class="btn-success" type="submit">Confirmar</button>
                    <button type="button" onclick="fecharModal()" class="btn-secondary">Cancelar</button>
                </form>
            </div>
        </div>
        
        <!-- NOVO MODAL PARA CONFIGURAR BOT√ïES -->
        <div id="modalConfigurarBotoes" class="modal">
            <div class="modal-content">
                <h3>Configurar Bot√µes de A√ß√£o</h3>
                <p>Marque os bot√µes que deseja exibir na lista de clientes.</p>
                <div id="botoesConfigList" style="text-align: left; max-height: 300px; overflow-y: auto; margin: 15px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    <!-- Checkboxes ser√£o inseridos aqui pelo JS -->
                </div>
                <button onclick="salvarConfiguracaoBotoes()" class="btn-success">Salvar</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>

        <!-- Modal: Trocar Produto em lote -->
        <div id="modalProdutoLote" class="modal">
            <div class="modal-content">
                <h3>Trocar Produto (em lote)</h3>
                <p>Escolha o produto para aplicar em <b><span id="bulkCountInline2">0</span></b> clientes selecionados.</p>
                <button onclick="confirmarProdutoLote('UniTv')">UniTv</button>
                <button onclick="confirmarProdutoLote('Duplecast')">Duplecast</button>
                <button onclick="fecharModal()" class="btn-secondary">Cancelar</button>
            </div>
        </div>

        <!-- Modal: Definir Cobran√ßa em lote -->
        <div id="modalCobrancaLote" class="modal">
            <div class="modal-content">
                <h3>Definir Data de Cobran√ßa (em lote)</h3>
                <p>Defina a data de cobran√ßa para <b><span id="bulkCountInline3">0</span></b> clientes selecionados.</p>
                <form id="formCobrancaLote">
                    <input type="date" id="dataCobrancaLoteInput" required style="width: 90%; padding: 10px; margin: 10px 0;">
                    <button class="btn-success" type="submit">Confirmar</button>
                    <button type="button" onclick="fecharModal()" class="btn-secondary">Cancelar</button>
                </form>
            </div>
        </div>

        <!-- Modal: Hist√≥rico do Cliente -->
        <div id="modalHistorico" class="modal">
            <div class="modal-content">
                <h3>Hist√≥rico do Cliente</h3>
                <div id="historicoConteudo" style="text-align:left; max-height: 320px; overflow-y:auto; padding:10px; border:1px solid #ddd; border-radius:6px; background:#fff;"></div>
                <button onclick="fecharModal()" class="btn-secondary">Fechar</button>
            </div>
        </div>

        <!-- Modal: Modo Cobran√ßa (fluxo guiado) -->
        <div id="modalCobranca" class="modal">
            <div class="modal-content">
                <h3>Modo Cobran√ßa</h3>
                <p id="cobrancaInfo" style="margin-bottom:10px;"></p>
                <div id="cobrancaCliente" style="text-align:left; border:1px solid #ddd; border-radius:6px; padding:10px; margin-bottom:10px;"></div>
                <div style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center;">
                    <button onclick="cobrancaEnviarWhats()" class="btn-success">Abrir WhatsApp</button>
                    <button onclick="cobrancaMarcarAvisado()" class="btn-info">Marcar Avisado</button>
                    <button onclick="cobrancaVerDepois(7)" class="btn-warning">Ver Depois 7d</button>
                    <button onclick="cobrancaProximo()" class="btn-secondary">Pr√≥ximo</button>
                    <button onclick="fecharModal()" class="btn-secondary">Sair</button>
                </div>
            </div>
        </div>

        <!-- Modal: Ver Depois em lote -->
        <div id="modalVerDepoisLote" class="modal">
            <div class="modal-content">
                <h3>Agendar Reexibi√ß√£o (em lote)</h3>
                <p>Defina a data para reexibir <b><span id="bulkCountInline">0</span></b> clientes selecionados.</p>
                <form id="formVerDepoisLote">
                    <input type="date" id="dataReexibicaoLoteInput" required style="width: 90%; padding: 10px; margin: 10px 0;">
                    <div style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin: 6px 0 12px;">
                        <button type="button" onclick="setDatePlusDays('dataReexibicaoLoteInput', 1)" class="btn-secondary">+1d</button>
                        <button type="button" onclick="setDatePlusDays('dataReexibicaoLoteInput', 3)" class="btn-secondary">+3d</button>
                        <button type="button" onclick="setDatePlusDays('dataReexibicaoLoteInput', 7)" class="btn-secondary">+7d</button>
                        <button type="button" onclick="setDatePlusDays('dataReexibicaoLoteInput', 15)" class="btn-secondary">+15d</button>
                        <button type="button" onclick="setDatePlusDays('dataReexibicaoLoteInput', 30)" class="btn-secondary">+30d</button>
                    </div>
                    <button class="btn-success" type="submit">Confirmar</button>
                    <button type="button" onclick="fecharModal()" class="btn-secondary">Cancelar</button>
                </form>
            </div>
        </div>

    </div>
        
    <!-- POP-UP: Vencendo em at√© 3 dias -->
    <div id="modalPopupVencendo" class="modal" style="display:none;" onclick="if(event.target===this) fecharPopupVencendo()">
        <div class="modal-content" style="max-width: 950px; width: min(950px, 96vw);">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                <h3 style="margin:0;">Clientes vencendo em at√© 3 dias</h3>
                <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                    <button class="btn-info" onclick="abrirModalGerenciarPopup()">üë• Gerenciar / Novo</button>
                    <button class="btn-secondary" onclick="fecharPopupVencendo()">Fechar</button>
                </div>
            </div>

            <div class="popup-muted" style="margin-top:6px;">
                Mostra somente os clientes escolhidos na configura√ß√£o e que est√£o com vencimento em 3, 2, 1 dia ou hoje.
            </div>

            <div id="popupVencendoLista"></div>
        </div>
    </div>

    <!-- MODAL: Configurar clientes do pop-up (Checklist) -->
    <div id="modalPopupConfig" class="modal" style="display:none;" onclick="if(event.target===this) fecharModalPopupConfig()">
        <div class="modal-content" style="max-width: 900px; width: min(900px, 96vw);">
            <h3>Importar Clientes Existentes</h3>
            <p style="margin-top: 0;">
                Selecione os clientes da lista principal para criar uma c√≥pia no Pop-up.
            </p>

            <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 8px 0 10px;">
                <input
                    type="text"
                    id="popupConfigBusca"
                    placeholder="Buscar por nome, telefone ou ID‚Ä¶"
                    oninput="popupConfigRenderAtual()"
                    style="width: min(520px, 92%); padding: 12px; border-radius: var(--border-radius); border: 1px solid #ccc;"
                >
                <button class="btn-secondary" type="button" onclick="(function(){ const el=document.getElementById('popupConfigBusca'); if(el) el.value=''; popupConfigRenderAtual(); })()">Limpar</button>
            </div>

            <div id="popupConfigLista"></div>

            <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top: 12px;">
                <button class="btn-success" onclick="salvarPopupConfig()">Salvar Importa√ß√£o</button>
                <button class="btn-secondary" onclick="fecharModalPopupConfig()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- NOVO MODAL: Gerenciar Clientes do Pop-up (Lista + Cadastro Manual) -->
    <div id="modalGerenciarPopup" class="modal" style="display:none;" onclick="if(event.target===this) fecharModalGerenciarPopup()">
        <div class="modal-content" style="max-width: 800px; width: min(800px, 96vw);">
            <h3>Gerenciar Clientes do Pop-up</h3>
            
            <!-- Form de Cadastro Manual -->
            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #eee; text-align:left;">
                <h4 style="margin-top:0; color:var(--primary-color);">‚ûï Cadastrar Novo (Exclusivo Pop-up)</h4>
                <div class="input-group-horizontal">
                    <div class="input-wrapper"><label>Nome</label><input type="text" id="popNome" placeholder="Nome do Cliente"></div>
                    <div class="input-wrapper"><label>Telefone</label><input type="tel" id="popTel" placeholder="Telefone"></div>
                    <div class="input-wrapper"><label>Vencimento</label><input type="date" id="popData"></div>
                </div>
                <div style="display:flex; gap:15px; margin:10px 0;">
                    <label><input type="radio" name="popProd" value="UniTv" checked> UniTv</label>
                    <label><input type="radio" name="popProd" value="Duplecast"> Duplecast</label>
                </div>
                <button class="btn-success" onclick="adicionarClienteManualPopup()">Adicionar Manualmente</button>
            </div>

            <!-- Lista e A√ß√µes -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:10px;">
                <h4 style="margin:0;">Lista de Clientes (Pop-up)</h4>
                <button class="btn-info" onclick="abrirModalPopupConfig()">üìÇ Importar da Lista Principal</button>
            </div>
            
            <input type="text" id="buscaGerenciarPop" placeholder="Filtrar lista de clones..." oninput="renderListaGerenciarPopup()" style="width:100%; margin-bottom:10px;">
            
            <div id="listaGerenciarPop" style="max-height:300px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:10px; text-align:left;"></div>

            <div style="margin-top:15px;">
                <button class="btn-secondary" onclick="fecharModalGerenciarPopup()">Fechar</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <script>
        let clientes = [];
        let clientesFiltrados = [];
        let clienteIndexParaExcluir = null;
        let clienteIndexParaDuplicar = null;
        let clienteIndexParaRenovarDebito = null;
        let clienteIndexParaAlterarProduto = null;
        let modoExibicaoArquivados = false;
        let modoExibicaoOcultos = false;
        let modoExibicaoDesativados = false;
        let filtroProduto = null;
        let historicoClientes = [];
        let redoHistory = [];
        const MAX_HISTORY_STATES = 10;
        let confirmActionCallback = null;
        let clienteIdParaVerDepois = null;
        let clientesParaProcessarImportacao = [];
        let currentIndexImportacao = 0;
        let clientesVencidosParaMensagem = [];
        let clienteIdParaRenovarHoje = null;
        let debounceTimer;

        const selectedClientIds = new Set();

        function updateBulkBar() {
            const bulkBar = document.getElementById('bulkBar');
            const bulkCount = document.getElementById('bulkCount');
            const bulkCountInline = document.getElementById('bulkCountInline');
            const count = selectedClientIds.size;
            if (bulkCount) bulkCount.textContent = `${count} selecionados`;
            if (bulkCountInline) bulkCountInline.textContent = String(count);
            const b2=document.getElementById('bulkCountInline2'); if(b2) b2.textContent=String(count);
            const b3=document.getElementById('bulkCountInline3'); if(b3) b3.textContent=String(count);
            if (bulkBar) bulkBar.style.display = count > 0 ? 'block' : 'none';
        }

        function syncRowSelectionUI() {
            document.querySelectorAll('input.select-cliente').forEach(chk => {
                const id = chk.getAttribute('data-id');
                const isSel = selectedClientIds.has(id);
                chk.checked = isSel;
                const tr = chk.closest('tr');
                if (tr) tr.classList.toggle('row-selected', isSel);
            });
            updateBulkBar();
        }

        function toggleSelecaoCliente(clientId, checked) {
            if (!clientId) return;
            if (checked) selectedClientIds.add(clientId);
            else selectedClientIds.delete(clientId);
            syncRowSelectionUI();
        }

        function limparSelecao() {
            selectedClientIds.clear();
            syncRowSelectionUI();
        }

        function selecionarTodosVisiveis() {
            (clientesExibidos || []).forEach(c => c && c.id && selectedClientIds.add(String(c.id)));
            syncRowSelectionUI();
        }

        function getSelectedClientsFromState() {
            const ids = new Set(Array.from(selectedClientIds).map(String));
            return clientes.filter(c => ids.has(String(c.id)));
        }

        function removerIdsInexistentesDaSelecao() {
            const idsExistentes = new Set(clientes.map(c => String(c.id)));
            Array.from(selectedClientIds).forEach(id => {
                if (!idsExistentes.has(String(id))) selectedClientIds.delete(String(id));
            });
        }

        async function acaoEmLote(acao) {
            if (selectedClientIds.size === 0) {
                exibirAlerta("Selecione pelo menos um cliente.");
                return;
            }

            const titulos = {
                arquivar: "Arquivar (em lote)",
                desarquivar: "Desarquivar (em lote)",
                desativar: "Desativar (em lote)",
                reativar: "Reativar (em lote)",
                avisado: "Marcar Avisado (em lote)",
                desavisar: "Desmarcar Avisado (em lote)"
            };
            const mensagens = {
                arquivar: `Arquivar <b>${selectedClientIds.size}</b> clientes selecionados?`,
                desarquivar: `Desarquivar <b>${selectedClientIds.size}</b> clientes selecionados?`,
                desativar: `Desativar <b>${selectedClientIds.size}</b> clientes selecionados?`,
                reativar: `Reativar <b>${selectedClientIds.size}</b> clientes selecionados?`,
                avisado: `Marcar como <b>Avisado</b> <b>${selectedClientIds.size}</b> clientes selecionados?`,
                desavisar: `Desmarcar <b>Avisado</b> de <b>${selectedClientIds.size}</b> clientes selecionados?`
            };

            exibirConfirmacaoGenerica(
                titulos[acao] || "Confirmar A√ß√£o",
                mensagens[acao] || "Confirma a a√ß√£o em lote?",
                async () => {
                    saveStateToHistory();
                    const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));

                    try {
                        const ids = new Set(Array.from(selectedClientIds).map(String));
                        clientes.forEach(c => {
                            if (!ids.has(String(c.id))) return;

                            if (acao === 'arquivar') {
                                c.arquivado = true; c.oculto = false; c.reexibirEm = null; c.desativado = false; c.clicado = false;
                            } else if (acao === 'desarquivar') {
                                c.arquivado = false; c.reexibirEm = null;
                            } else if (acao === 'desativar') {
                                c.desativado = true;
                                c.avisado = false; c.debito = false; c.oculto = false; c.reexibirEm = null; c.arquivado = false; c.clicado = false;
                            } else if (acao === 'reativar') {
                                c.desativado = false;
                            } else if (acao === 'avisado') {
                                c.avisado = true; c.oculto = false; c.clicado = true;
                            } else if (acao === 'desavisar') {
                                c.avisado = false; c.clicado = false;
                            }
                        });

                        saveClientsToLocalStorage();
                        removerIdsInexistentesDaSelecao();
                        chamarFiltroAtual();
                        atualizarContadores();
                        prepararClientesVencidosParaMensagem();
                        updateBulkBar();

                        await salvarClientes();
                        exibirAlerta("A√ß√£o em lote conclu√≠da!");
                    } catch (error) {
                        clientes = estadoAnteriorClientes;
                        saveClientsToLocalStorage();
                        chamarFiltroAtual();
                        atualizarContadores();
                        exibirAlerta(`Erro na a√ß√£o em lote: ${error.message}. A√ß√£o desfeita localmente.`);
                    }
                },
                (acao === 'desativar')
            );
        }

        function abrirModalVerDepoisLote() {
            if (selectedClientIds.size === 0) {
                exibirAlerta("Selecione pelo menos um cliente.");
                return;
            }
            const amanha = new Date();
            amanha.setDate(amanha.getDate() + 1);
            const inp = document.getElementById('dataReexibicaoLoteInput');
            if (inp) inp.value = amanha.toISOString().split('T')[0];
            document.getElementById('modalVerDepoisLote').style.display = 'flex';
            updateBulkBar();
            setTimeout(() => inp && inp.focus(), 0);
            document.addEventListener("keydown", fecharComEsc);
        }

        async function confirmarVerDepoisLote() {
            if (selectedClientIds.size === 0) return;
            const dataReexibicao = document.getElementById('dataReexibicaoLoteInput').value;
            if (!dataReexibicao) {
                exibirAlerta("Por favor, selecione uma data.");
                return;
            }

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));

            try {
                const ids = new Set(Array.from(selectedClientIds).map(String));
                clientes.forEach(c => {
                    if (!ids.has(String(c.id))) return;
                    c.reexibirEm = dataReexibicao;
                    c.oculto = false;
                    c.arquivado = false;
                    c.desativado = false;
                    c.clicado = false;
                });

                saveClientsToLocalStorage();
                fecharModal();
                chamarFiltroAtual();
                atualizarContadores();
                prepararClientesVencidosParaMensagem();
                updateBulkBar();

                await salvarClientes();
                exibirAlerta("Agendamento em lote conclu√≠do!");
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao agendar em lote: ${error.message}. A√ß√£o desfeita localmente.`);
            }
        }
        
        function setDatePlusDays(inputId, days) {
            const inp = document.getElementById(inputId);
            if (!inp) return;
            const base = new Date();
            base.setDate(base.getDate() + days);
            inp.value = base.toISOString().split('T')[0];
        }

        async function copiarPix() {
            const msg = `PIX: ${PIX_KEY} (${PIX_NOME})`;
            try {
                await navigator.clipboard.writeText(msg);
                showToast("PIX copiado!");
            } catch (e) {
                exibirAlerta("N√£o consegui copiar automaticamente. PIX: " + msg);
            }
        }

        function abrirModalProdutoLote() {
            if (selectedClientIds.size === 0) return exibirAlerta("Selecione pelo menos um cliente.");
            document.getElementById('bulkCountInline2').textContent = String(selectedClientIds.size);
            document.getElementById('modalProdutoLote').style.display = 'flex';
            document.addEventListener("keydown", fecharComEsc);
        }

        function confirmarProdutoLote(novoProduto) {
            if (selectedClientIds.size === 0) return;
            acaoEmLote('produto:' + novoProduto);
            fecharModal();
        }

        function abrirModalCobrancaLote() {
            if (selectedClientIds.size === 0) return exibirAlerta("Selecione pelo menos um cliente.");
            document.getElementById('bulkCountInline3').textContent = String(selectedClientIds.size);
            const inp = document.getElementById('dataCobrancaLoteInput');
            const today = new Date();
            inp.value = today.toISOString().split('T')[0];
            document.getElementById('modalCobrancaLote').style.display = 'flex';
            setTimeout(() => inp.focus(), 0);
            document.addEventListener("keydown", fecharComEsc);
        }

        async function confirmarCobrancaLote() {
            if (selectedClientIds.size === 0) return;
            const val = document.getElementById('dataCobrancaLoteInput').value;
            if (!val) return exibirAlerta("Selecione uma data.");
            saveStateToHistory();
            const backup = JSON.parse(JSON.stringify(clientes));
            try {
                const ids = new Set(Array.from(selectedClientIds).map(String));
                const ddmmyyyy = val.split("-").reverse().join("/");
                clientes.forEach(c => {
                    if (!ids.has(String(c.id))) return;
                    c.dataCobranca = ddmmyyyy;
                    pushLog(c, "cobran√ßa definida", ddmmyyyy);
                });
                saveClientsToLocalStorage();
                fecharModal();
                chamarFiltroAtual();
                atualizarContadores();
                prepararClientesVencidosParaMensagem();
                await salvarClientes();
                exibirAlerta("Cobran√ßa definida em lote!");
            } catch (e) {
                clientes = backup;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta("Erro ao definir cobran√ßa em lote: " + e.message);
            }
        }

        function mostrarHistorico(index) {
            const cliente = clientesExibidos[index];
            if (!cliente) return;
            const original = clientes.find(c => c.id === cliente.id) || cliente;
            const logs = Array.isArray(original.logs) ? original.logs : [];
            const box = document.getElementById('historicoConteudo');
            if (logs.length === 0) {
                box.innerHTML = "<i>Sem hist√≥rico ainda.</i>";
            } else {
                box.innerHTML = logs.slice().reverse().map(l => `<div style="margin-bottom:8px;"><b>${l.t}</b> ‚Äî ${l.a}${l.e ? ` <span style="color:#555">(${l.e})</span>` : ""}</div>`).join("");
            }
            document.getElementById('modalHistorico').style.display = 'flex';
            document.addEventListener("keydown", fecharComEsc);
        }

        // === Modo Cobran√ßa (fluxo guiado) ===
        let filaCobranca = [];
        let cobrancaIndex = 0;

        function iniciarModoCobranca() {
            prepararClientesVencidosParaMensagem();
            filaCobranca = clientesVencidosParaMensagem.slice();
            cobrancaIndex = 0;
            if (filaCobranca.length === 0) return exibirAlerta("N√£o h√° clientes vencidos/hoje para cobrar.");
            document.getElementById('modalCobranca').style.display = 'flex';
            renderCobranca();
            document.addEventListener("keydown", fecharComEsc);
        }

        function renderCobranca() {
            const info = document.getElementById('cobrancaInfo');
            const box = document.getElementById('cobrancaCliente');
            const total = filaCobranca.length;
            const c = filaCobranca[cobrancaIndex];
            info.innerHTML = `Cliente ${cobrancaIndex+1} de ${total}`;
            const nome = (c.nome || "").replace(/\s\(UniTv\)|\s\(Duplecast\)/g, "").trim();
            box.innerHTML = `
                <div><b>${nome}</b> (${c.Produto || "N/I"})</div>
                <div>üìû ${c.telefone}</div>
                <div>üìÖ Venc: ${c.data || "-"}</div>
                ${c.dataCobranca ? `<div style="color:var(--success-color); font-weight:700;">üí≤ Cobran√ßa: ${c.dataCobranca}</div>` : ""}
                ${c.observacao ? `<div style="margin-top:8px; padding:8px; background:#f7f7f7; border-radius:6px;"><b>Obs:</b> ${c.observacao}</div>` : ""}
            `;
        }

        function cobrancaEnviarWhats() {
            const c = filaCobranca[cobrancaIndex];
            if (!c) return;
            const nome = (c.nome || "").replace(/\s\(UniTv\)|\s\(Duplecast\)/g, "").trim();
            const originalClientesExibidos = clientesExibidos;
            clientesExibidos = [c];
            enviarMensagemWhatsApp(nome, c.telefone, 0);
            clientesExibidos = originalClientesExibidos;
        }

        async function cobrancaMarcarAvisado() {
            const c = filaCobranca[cobrancaIndex];
            if (!c) return;
            const idx = clientes.findIndex(x => x.id === c.id);
            if (idx === -1) return;
            saveStateToHistory();
            const backup = JSON.parse(JSON.stringify(clientes));
            try{
                clientes[idx].avisado = true;
                clientes[idx].clicado = true;
                pushLog(clientes[idx], "marcado avisado", "");
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                prepararClientesVencidosParaMensagem();
                await salvarClientes();
                showToast("Marcado como avisado!");
                cobrancaProximo();
            } catch(e){
                clientes = backup;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                exibirAlerta("Erro: " + e.message);
            }
        }

        function cobrancaVerDepois(dias) {
            const c = filaCobranca[cobrancaIndex];
            if (!c) return;
            const idx = clientes.findIndex(x => x.id === c.id);
            if (idx === -1) return;
            const d = new Date(); d.setDate(d.getDate()+dias);
            const iso = d.toISOString().split('T')[0];
            saveStateToHistory();
            const backup = JSON.parse(JSON.stringify(clientes));
            (async () => {
                try{
                    clientes[idx].reexibirEm = iso;
                    clientes[idx].clicado = false;
                    pushLog(clientes[idx], "ver depois", iso.split('-').reverse().join('/'));
                    saveClientsToLocalStorage();
                    fecharModal();
                    chamarFiltroAtual();
                    prepararClientesVencidosParaMensagem();
                    await salvarClientes();
                    showToast("Agendado ver depois!");
                    document.getElementById('modalCobranca').style.display = 'flex';
                    cobrancaProximo();
                } catch(e){
                    clientes = backup;
                    saveClientsToLocalStorage();
                    chamarFiltroAtual();
                    exibirAlerta("Erro: " + e.message);
                }
            })();
        }

        function cobrancaProximo() {
            if (filaCobranca.length === 0) return;
            cobrancaIndex++;
            if (cobrancaIndex >= filaCobranca.length) {
                fecharModal();
                exibirAlerta("Fim da fila de cobran√ßa üéâ");
                return;
            }
            renderCobranca();
        }

        function exportarSelecionados() {
            if (selectedClientIds.size === 0) {
                exibirAlerta("Selecione pelo menos um cliente.");
                return;
            }
            const ids = new Set(Array.from(selectedClientIds).map(String));
            const clientesParaExportar = clientes
              .filter(c => ids.has(String(c.id)))
              .map(c => ({
                id: c.id, data: c.data, nome: c.nome, telefone: c.telefone,
                avisado: c.avisado || false, debito: c.debito || false, Produto: c.Produto || "N√£o informado",
                arquivado: c.arquivado || false, oculto: c.oculto || false, reexibirEm: c.reexibirEm || null,
                desativado: c.desativado || false, dola_sent: c.dola_sent || false, clicado: c.clicado || false,
                dataCobranca: c.dataCobranca || null, observacao: c.observacao || null,
                logs: c.logs || []
              }));
            const blob = new Blob([JSON.stringify(clientesParaExportar, null, 4)], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "clientes_selecionados.json";
            link.click();
            showToast('Exportado!'); atualizarUltimaAtualizacao("clientes selecionados exportados");
        }

        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwoeQZB6yl-RBXQ8gn7PUOz-QsyYJfeWW8UgDgNf8WUYPCH7DczuoXLb_5PkipxD6OY/exec';
        const PIX_KEY = "11947406124";
        const PIX_NOME = "Waldemar Jose Luiz";
        const TOAST_MS = 2200;

        function nowBR() {
            const d = new Date();
            return d.toLocaleString('pt-BR', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false });
        }

        function pushLog(clienteObj, acao, extra="") {
            if (!clienteObj) return;
            if (!Array.isArray(clienteObj.logs)) clienteObj.logs = [];
            clienteObj.logs.push({ t: nowBR(), a: acao, e: extra || "" });
            if (clienteObj.logs.length > 50) clienteObj.logs = clienteObj.logs.slice(-50);
        }

        function setAddSectionCollapsed(isCollapsed) {
            const sec = document.getElementById('addClientSection');
            const btn = document.getElementById('toggleAddSectionBtn');
            if (!sec || !btn) return;
            sec.classList.toggle('collapsed', isCollapsed);
            btn.textContent = isCollapsed ? 'Exibir ‚ñº' : 'Recolher ‚ñ≤';
            try { localStorage.setItem('addSectionCollapsed', isCollapsed ? '1' : '0'); } catch(e) {}
        }

        function toggleAddSection() {
            const sec = document.getElementById('addClientSection');
            if (!sec) return;
            setAddSectionCollapsed(!sec.classList.contains('collapsed'));
        }

        function restoreAddSectionState() {
            try {
                let val = localStorage.getItem('addSectionCollapsed');
                if (val === null) {
                    val = '0';
                    localStorage.setItem('addSectionCollapsed', '0');
                }
                setAddSectionCollapsed(val === '1');
            } catch(e) {}
        }

        function showToast(msg) {
            const el = document.getElementById('toast');
            if (!el) return;
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), TOAST_MS);
        }

        let filtroAtual = "hojeEVencidos";
        let acaoBotoesConfig = {};
        const defaultAcaoBotoesConfig = {
            observacao: { label: 'üí¨ Observa√ß√£o', visivel: true },
            dola: { label: 'ü§ñ Dola', visivel: true },
            renovarAuto: { label: 'Renov. Auto (üîÅ)', visivel: true },
            debito: { label: 'D√âBITO', visivel: true },
            renovarHoje: { label: 'RENOVAR HOJE', visivel: true },
            verDepois: { label: 'Ver Depois', visivel: true },
            produto: { label: 'Produto', visivel: true },
            editar: { label: 'Edit', visivel: true },
            excluir: { label: 'Excluir (‚ùå)', visivel: true },
            arquivar: { label: 'Arquivar (üìÇ)', visivel: true },
            desativar: { label: 'Desativar', visivel: true },
            copiar: { label: 'üìã Copiar', visivel: true },
            copiarNumero: { label: 'üî¢ Copiar N√∫mero', visivel: true },
            duplicar: { label: '‚ûï Duplicar', visivel: true }
        };

        function mostrarCarregando() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function marcarClienteClicado(elemento) {
            document.querySelectorAll('a.cliente-clicado').forEach(el => el.classList.remove('cliente-clicado'));

            elemento.classList.add("cliente-clicado");
            const tr = elemento.closest("tr");
            if (tr) {
                const indexNaTabela = Array.from(tr.parentNode.children).indexOf(tr);
                const clienteClicado = clientesExibidos[indexNaTabela];
                if (clienteClicado) {
                    const indexOriginal = clientes.findIndex(c => c.id === clienteClicado.id);
                    if (indexOriginal !== -1) {
                        clientes[indexOriginal].clicado = true;
                        saveClientsToLocalStorage();
                    }
                }
            }
        }

        function esconderCarregando() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function saveClientsToLocalStorage() {
            try {
                localStorage.setItem('clientesCache', JSON.stringify(clientes));
            } catch (e) {
                console.error('Erro ao salvar clientes no localStorage:', e);
            }
        }

        const APP_LOG_KEY = 'appDebugLogs_v1';
        let appDebugLogs = [];

        function safeStringify(obj) {
            try { return JSON.stringify(obj); } catch(e) { return String(obj); }
        }

        function nowIso() {
            const d = new Date();
            const pad = (n)=>String(n).padStart(2,'0');
            return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }

        function setTopStatus(texto) {
            const el = document.getElementById('topQuickBarStatus');
            if (el) el.textContent = texto;
        }

        function addAppLog(level, step, detail = '') {
            const entry = {
                t: nowIso(),
                level: String(level || 'INFO').toUpperCase(),
                step: String(step || ''),
                detail: (typeof detail === 'string') ? detail : safeStringify(detail)
            };
            appDebugLogs.push(entry);
            if (appDebugLogs.length > 400) appDebugLogs = appDebugLogs.slice(-400);

            try { localStorage.setItem(APP_LOG_KEY, JSON.stringify(appDebugLogs)); } catch(e) {}
            renderDebugLogs();

            if (entry.level === 'ERROR') console.error('[LOG]', entry.step, entry.detail);
            else if (entry.level === 'WARN') console.warn('[LOG]', entry.step, entry.detail);
            else console.log('[LOG]', entry.step, entry.detail);
        }

        function loadDebugLogs() {
            try {
                const saved = localStorage.getItem(APP_LOG_KEY);
                if (saved) appDebugLogs = JSON.parse(saved) || [];
            } catch(e) {
                appDebugLogs = [];
            }
            renderDebugLogs();
        }

        function renderDebugLogs() {
            const box = document.getElementById('debugLogContent');
            if (!box) return;

            if (!appDebugLogs.length) {
                box.innerHTML = '<span style="color:#666">Sem logs ainda.</span>';
                return;
            }

            box.innerHTML = appDebugLogs.map(e => {
                const cls = e.level === 'ERROR' ? 'err' : (e.level === 'WARN' ? 'warn' : 'ok');
                const head = `<span class="${cls}">[${e.level}]</span>`;
                const step = e.step ? ` <b>${e.step}</b>` : '';
                const detail = e.detail ? ` ‚Äî ${String(e.detail).replace(/</g,'&lt;')}` : '';
                return `${e.t} ${head}${step}${detail}`;
            }).join('\n');
        }

        function toggleDebugLogPanel(forceOpen = null) {
            const panel = document.getElementById('debugLogPanel');
            if (!panel) return;
            const shouldOpen = (forceOpen === null) ? !panel.classList.contains('open') : !!forceOpen;
            panel.classList.toggle('open', shouldOpen);
            addAppLog('INFO', shouldOpen ? 'logs: abrir painel' : 'logs: fechar painel', '');
        }

        async function copyDebugLogs() {
            const txt = (appDebugLogs || []).map(e => `${e.t} [${e.level}] ${e.step}${e.detail ? ' ‚Äî ' + e.detail : ''}`).join('\n');
            try {
                await navigator.clipboard.writeText(txt);
                showToast('Logs copiados!');
            } catch(e) {
                exibirAlerta('N√£o consegui copiar automaticamente. Abra o painel e selecione manualmente.');
            }
        }

        function downloadDebugLogs() {
            const txt = (appDebugLogs || []).map(e => `${e.t} [${e.level}] ${e.step}${e.detail ? ' ‚Äî ' + e.detail : ''}`).join('\n');
            const blob = new Blob([txt], { type: 'text/plain;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `logs_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
            a.click();
            addAppLog('INFO', 'logs: baixar txt', a.download);
        }

        function clearDebugLogs() {
            appDebugLogs = [];
            try { localStorage.removeItem(APP_LOG_KEY); } catch(e) {}
            renderDebugLogs();
            addAppLog('WARN', 'logs: limpar', 'Logs apagados');
        }

        window.addEventListener('error', (ev) => {
            addAppLog('ERROR', 'window.error', ev?.message || 'Erro desconhecido');
        });
        window.addEventListener('unhandledrejection', (ev) => {
            addAppLog('ERROR', 'promise.unhandledrejection', ev?.reason?.message || safeStringify(ev?.reason) || 'Rejei√ß√£o sem motivo');
        });

        async function sendRequestToBackend(action, data = {}) {
            try {
                addAppLog('INFO', `backend:${action}:start`, data);
                setTopStatus(`Status: enviando (${action})...`);
                const url = `${WEB_APP_URL}?action=${action}`;
                const options = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify(data),
                    muteHttpExceptions: true
                };

                if (action === 'get_all_clients') {
                    options.method = 'GET';
                    delete options.body;
                }

                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro de rede ou servidor: ${response.status} - ${errorText}`);
                }
                const result = await response.json();
                if (result && result.status === 'error') {
                    throw new Error(result.message || 'Erro desconhecido do backend.');
                }
                addAppLog('OK', `backend:${action}:ok`, result);
                setTopStatus('Status: pronto');
                return result;
            } catch (error) {
                console.error('Erro na comunica√ß√£o com o backend:', error);
                addAppLog('ERROR', `backend:${action}:error`, error.message || error);
                setTopStatus('Status: erro (ver logs)');
                throw error;
            }
        }

        function atualizarUltimaAtualizacao(acao = "dados atualizados", clienteNome = "") {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            const formattedDateTime = now.toLocaleString('pt-BR', options);
            let fullMessage = `√öltima Altera√ß√£o: ${formattedDateTime}`;
            if (clienteNome) {
                const nomeLimpoParaMsg = clienteNome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');
                fullMessage += ` - ${nomeLimpoParaMsg} (${acao})`;
            } else {
                fullMessage += ` (${acao})`;
            }
            localStorage.setItem('ultimaAtualizacaoCliente', fullMessage);
            document.getElementById('ultimaAtualizacaoInfo').textContent = fullMessage;
        }

        function saveStateToHistory(clearRedo = true) {
            const estadoAtual = JSON.parse(JSON.stringify(clientes));
            historicoClientes.push(estadoAtual);
            if (historicoClientes.length > MAX_HISTORY_STATES) {
                historicoClientes.shift();
            }
            if (clearRedo) {
                redoHistory = [];
            }
        }

        function exibirConfirmacaoGenerica(titulo, mensagem, callback, isDanger = false) {
            const modal = document.getElementById("modalConfirmacaoGenerica");
            const btnConfirmar = document.getElementById("btnConfirmacaoGenericaConfirmar");
            document.getElementById("modalConfirmacaoGenericaTitulo").innerText = titulo;
            document.getElementById("modalConfirmacaoGenericaMensagem").innerHTML = mensagem;
            confirmActionCallback = callback;
            
            btnConfirmar.classList.remove("btn-danger", "btn-success");
            btnConfirmar.classList.add(isDanger ? "btn-danger" : "btn-success");
            
            btnConfirmar.onclick = () => {
                if (confirmActionCallback) {
                    confirmActionCallback();
                    confirmActionCallback = null;
                }
                fecharModal();
            };
            modal.style.display = "flex";
            document.addEventListener("keydown", fecharComEsc);
        }

        function fecharModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = "none";
            });
            const modalEdicao = document.getElementById("modalEdicao");
            if (modalEdicao) {
                modalEdicao.innerHTML = "";
            }
            const modalAlerta = document.getElementById("modalAlerta");
            if (modalAlerta) {
                modalAlerta.innerHTML = "";
            }
            // Remove listeners para evitar duplicidade
            document.removeEventListener("keydown", fecharComEsc);
            document.removeEventListener("keydown", fecharComEscOuEnter);
            clienteIdParaRenovarHoje = null;
        }

        function fecharComEsc(event) {
            if (event.key === "Escape") {
                fecharModal();
            }
        }

        function fecharComEscOuEnter(event) {
            if (event.key === "Enter" || event.key === "Escape") {
                fecharModal();
            }
        }

        function exibirAlerta(mensagem) {
            let modalAlerta = document.getElementById("modalAlerta");
            modalAlerta.style.display = "flex";
            modalAlerta.innerHTML = `<div class="modal-content"><h3>Aviso</h3><p>${mensagem}</p><button class="btn-primary" onclick="fecharModal()">OK</button></div>`;
            document.addEventListener("keydown", fecharComEscOuEnter);
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === "Enter" && document.getElementById("modalExclusao").style.display === "flex") {
                confirmarExclusao();
            }
        });

        async function adicionarCliente() {
            const dataInput = document.getElementById("dataInput").value.trim();
            const nomeInput = document.getElementById("nomeInput").value.trim();
            const telefoneInput = document.getElementById("telefoneInput").value.trim();
            const produtoSelecionado = document.querySelector('input[name="produto"]:checked').value;
            const dataCobrancaInput = document.getElementById("dataCobrancaInput").value.trim();
            const observacaoInput = document.getElementById("observacaoInput").value.trim();

            if (!dataInput || !nomeInput || !telefoneInput) {
                return exibirAlerta("Por favor, insira a data de vencimento, o nome e o telefone do cliente.");
            }
            const telefoneLimpo = telefoneInput.replace(/[^\d]/g, '');
            if (telefoneLimpo.length < 5) {
                return exibirAlerta("O telefone deve ter pelo menos 5 d√≠gitos para gerar o ID.");
            }
            const clienteId = telefoneLimpo.slice(-5);
            const clienteExistenteComMesmoId = clientes.find(c => c.id === clienteId);
            if (clienteExistenteComMesmoId) {
                return exibirAlerta(`J√° existe um cliente com o ID final de telefone ${clienteId} (Nome: ${clienteExistenteComMesmoId.nome}). Por favor, use um telefone final diferente ou edite o cliente existente.`);
            }

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const dataParts = dataInput.split("-");
            const dataFormatadaParaArmazenar = `${dataParts[2]}/${dataParts[1]}/${dataParts[0]}`;
            let nomeComProduto = `${nomeInput} (${produtoSelecionado})`;

            const novoClienteObj = {
                id: clienteId,
                data: dataFormatadaParaArmazenar,
                nome: nomeComProduto,
                telefone: telefoneLimpo,
                avisado: false,
                debito: false,
                Produto: produtoSelecionado,
                arquivado: false,
                oculto: false,
                reexibirEm: null,
                desativado: false,
                dola_sent: false,
                clicado: false,
                dataCobranca: dataCobrancaInput ? dataCobrancaInput.split("-").reverse().join("/") : null,
                observacao: observacaoInput || null,
                logs: []
            };

            clientes.push(novoClienteObj);
            saveClientsToLocalStorage();
            document.getElementById("nomeInput").value = "";
            document.getElementById("telefoneInput").value = "";
            document.getElementById("dataCobrancaInput").value = "";
            document.getElementById("observacaoInput").value = "";
            exibirTabela();
            atualizarContadores();
            pushLog(novoClienteObj, 'adicionado', ''); showToast('Cliente adicionado'); atualizarUltimaAtualizacao("adicionado", nomeInput);

            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                exibirTabela();
                atualizarContadores();
                exibirAlerta(`Erro ao adicionar cliente: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha na adi√ß√£o", nomeInput);
            }
        }

        async function arquivar(index) {
            const clienteParaArquivar = clientesExibidos[index];
            if (!clienteParaArquivar) return;

            const clienteOriginalIndex = clientes.findIndex(c => c.id === clienteParaArquivar.id);

            // 1) Clone do POP-UP
            if (clienteOriginalIndex === -1) {
                const cloneIndex = (popupClientClones || []).findIndex(c => String(c.id) === String(clienteParaArquivar.id));
                if (cloneIndex === -1) return;

                const clone = popupClientClones[cloneIndex];
                clone.arquivado = true;
                clone.oculto = false;
                clone.reexibirEm = null;
                clone.desativado = false;
                clone.clicado = false;

                if (typeof pushLog === 'function') pushLog(clone, 'arquivado', 'popup-clone');
                savePopupClientClones();
                showToast('Arquivado (clone)');
                atualizarUltimaAtualizacao("arquivado (clone)", clone.nome);

                try { checarEExibirPopupVencendo(); } catch (e) {}
                return;
            }

            // 2) Lista principal
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            clientes[clienteOriginalIndex].arquivado = true;
            clientes[clienteOriginalIndex].oculto = false;
            clientes[clienteOriginalIndex].reexibirEm = null;
            clientes[clienteOriginalIndex].desativado = false;
            clientes[clienteOriginalIndex].clicado = false;
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            pushLog(clientes[clienteOriginalIndex], 'arquivado', ''); showToast('Arquivado'); atualizarUltimaAtualizacao("arquivado", clienteParaArquivar.nome);
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao arquivar cliente: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha ao arquivar", clienteParaArquivar.nome);
            }
        }

        async function desarquivar(index) {
            const clienteParaDesarquivar = clientesExibidos[index];
            const clienteOriginalIndex = clientes.findIndex(c => c.id === clienteParaDesarquivar.id);
            if (clienteOriginalIndex === -1) return;

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            clientes[clienteOriginalIndex].arquivado = false;
            clientes[clienteOriginalIndex].reexibirEm = null;
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            pushLog(clientes[clienteOriginalIndex], 'desarquivado', ''); showToast('Desarquivado'); atualizarUltimaAtualizacao("desarquivado", clienteParaDesarquivar.nome);
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao desarquivar cliente: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha ao desarquivar", clienteParaDesarquivar.nome);
            }
        }

        function filtrarHojeEVencidos() {
            filtroAtual = "hojeEVencidos";
            exibirTabela();
            atualizarContadores();
        }

        function filtrarArquivados() {
            filtroAtual = "arquivados";
            document.getElementById("searchInput").value = "";
            exibirTabela();
        }

        function mostrarApenasOcultosPorFiltro() {
            filtroAtual = "ocultos";
            document.getElementById("searchInput").value = "";
            exibirTabela();
        }

        function filtrarVerDepois() {
            filtroAtual = "verDepois";
            document.getElementById("searchInput").value = "";
            exibirTabela();
        }

        function filtrarDesativados() {
            filtroAtual = "desativados";
            document.getElementById("searchInput").value = "";
            exibirTabela();
        }
        
        function filtrarCobrancaHoje() {
            filtroAtual = "cobrancaHoje";
            document.getElementById("searchInput").value = "";
            exibirTabela();
        }

        function filtrarPorProduto(produto) {
            filtroAtual = `produto:${produto}`;
            document.getElementById("searchInput").value = "";
            fecharModal();
            exibirTabela();
        }
        let clientesExibidos = [];

        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('/');
            if (parts.length === 3) {
                return `${parts[0]}/${parts[1]}`;
            }
            return dateString.substring(0, 5);
        }

        function exibirTabela() {
            const termoPesquisa = document.getElementById("searchInput").value.trim().toLowerCase();
            let clientesParaProcessar;
            const hojeStr = new Date().toISOString().split('T')[0];
            const hojeFormatada = new Date().toLocaleDateString('pt-BR').split('/').map(p => p.padStart(2,'0')).join('/');

            const isVisivelHoje = (cliente) => {
                return !cliente.reexibirEm || cliente.reexibirEm <= hojeStr;
            };

            if (termoPesquisa !== '') {
                clientesParaProcessar = clientes.filter(cliente =>
                    (cliente.nome.toLowerCase().includes(termoPesquisa) || cliente.telefone.includes(termoPesquisa))
                );
            } else if (filtroAtual === "verDepois") {
                clientesParaProcessar = clientes.filter(cliente => cliente.reexibirEm && cliente.reexibirEm > hojeStr);
            } else if (filtroAtual === "cobrancaHoje") {
                clientesParaProcessar = clientes.filter(c => c.dataCobranca === hojeFormatada && !c.arquivado && !c.oculto && !c.desativado && isVisivelHoje(c));
            } else if (filtroAtual === "hojeEVencidos") {
                const hoje = new Date();
                const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                
                clientesParaProcessar = clientes.filter(cliente => {
                    if (!cliente.data) return false;
                    const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));
                    const dataCliente = new Date(ano, mes - 1, dia);
                    const isVencendoHoje = cliente.data === hojeFormatada;
                    const isVencido = dataCliente < hojeSemHora;
                    return (isVencendoHoje || isVencido) && !cliente.arquivado && !cliente.oculto && !cliente.desativado && isVisivelHoje(cliente);
                });
            } else if (filtroAtual === "arquivados") {
                clientesParaProcessar = clientes.filter(cliente => cliente.arquivado);
            } else if (filtroAtual === "desativados") {
                clientesParaProcessar = clientes.filter(cliente => cliente.desativado);
            } else if (filtroAtual.startsWith("produto:")) {
                const produto = filtroAtual.split(":")[1];
                clientesParaProcessar = clientes.filter(cliente => cliente.Produto === produto && !cliente.arquivado && !cliente.oculto && !cliente.desativado && isVisivelHoje(cliente));
            } else if (filtroAtual === "hoje") {
                clientesParaProcessar = clientes.filter(cliente => cliente.data === hojeFormatada && !cliente.arquivado && !cliente.oculto && !cliente.desativado && !cliente.avisado && isVisivelHoje(cliente));
            } else if (filtroAtual === "amanha") {
                const amanha = new Date();
                amanha.setDate(amanha.getDate() + 1);
                const amanhaFormatada = amanha.toLocaleDateString('pt-BR').split('/').map(p => p.padStart(2,'0')).join('/');
                clientesParaProcessar = clientes.filter(cliente => cliente.data === amanhaFormatada && !cliente.arquivado && !cliente.oculto && !cliente.desativado && isVisivelHoje(cliente));
            } else if (filtroAtual === "vencidos") {
                const hoje = new Date();
                clientesParaProcessar = clientes.filter(cliente => {
                    if (!cliente.data) return false;
                    const [dia, mes, ano] = cliente.data.split("/").map(num => parseInt(num));
                    const dataCliente = new Date(ano, mes - 1, dia);
                    const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                    return dataCliente < hojeSemHora && !cliente.arquivado && !cliente.oculto && !cliente.desativado && !cliente.avisado && isVisivelHoje(cliente);
                });
            } else if (filtroAtual === "debito") {
                clientesParaProcessar = clientes.filter(cliente => cliente.debito && !cliente.arquivado && !cliente.oculto && !cliente.desativado && isVisivelHoje(cliente));
            } else if (filtroAtual === "todos") {
                clientesParaProcessar = clientes.filter(cliente => !cliente.arquivado && !cliente.oculto && !cliente.desativado && isVisivelHoje(cliente));
            } else {
                clientesParaProcessar = clientes.filter(cliente => !cliente.arquivado && !cliente.oculto && !cliente.desativado && isVisivelHoje(cliente));
            }

            clientesExibidos = clientesParaProcessar;

            if (clientesExibidos.length === 0) {
                document.querySelector("table").style.display = "none";
                document.getElementById("tabelaClientes").innerHTML = `<tr><td colspan="1" style="text-align: center; color: gray;">Nenhum cliente para exibir neste filtro.</td></tr>`;
                prepararClientesVencidosParaMensagem();
                atualizarContadores();
                return;
            }

            document.querySelector("table").style.display = "table";
            const tabela = document.getElementById("tabelaClientes");
            tabela.innerHTML = "";

            clientesExibidos.sort((a, b) => {
                if (!a.data || !b.data) return 0;
                const [diaA, mesA, anoA] = a.data.split("/").map(num => parseInt(num));
                const [diaB, mesB, anoB] = b.data.split("/").map(num => parseInt(num));
                const dataA = new Date(anoA, mesA - 1, diaA);
                const dataB = new Date(anoB, mesB - 1, diaB);
                return dataA - dataB;
            });

            const hoje = new Date();
            const hojeFormatadaDDMMYYYY = hoje.toLocaleDateString('pt-BR').split('/').map(p => p.padStart(2,'0')).join('/');

            clientesExibidos.forEach((cliente, index) => {
                const tr = document.createElement("tr");
                tr.classList.remove("avisado", "debito", "vencendo-hoje", "vencido");
                if (cliente.avisado) tr.classList.add("avisado");
                if (cliente.debito) tr.classList.add("debito");
                
                if(cliente.data) {
                    const [diaCliente, mesCliente, anoCliente] = cliente.data.split("/").map(num => parseInt(num));
                    const dataCliente = new Date(anoCliente, mesCliente - 1, diaCliente);
                    const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                    if (cliente.data === hojeFormatadaDDMMYYYY) {
                        tr.classList.add("vencendo-hoje");
                    } else if (dataCliente < hojeSemHora) {
                        tr.classList.add("vencido");
                    }
                }

                let botoesAcao = '';
                if (filtroAtual === "arquivados") {
                    botoesAcao = `
                        <button title="Desarquivar Cliente" onclick="desarquivar(${index})" class="btn-success">‚Ü©Ô∏è</button>
                        <button title="Excluir Cliente" onclick="excluir(${index})" class="btn-danger">‚ùå</button>
                    `;
                } else if (filtroAtual === "verDepois") {
                    const dataAgendada = new Date(cliente.reexibirEm + 'T00:00:00').toLocaleDateString('pt-BR');
                    botoesAcao = `
                        <span>Reexibir em: ${dataAgendada}</span>
                        <button title="Reexibir Agora" onclick="desmarcarVerDepois(${index})" class="btn-success">‚Ü©Ô∏è</button>
                        <button title="Editar Cliente" onclick="editar(${index})" class="btn-info">‚úèÔ∏è</button>
                        <button title="Excluir Cliente" onclick="excluir(${index})" class="btn-danger">‚ùå</button>
                    `;
                } else if (filtroAtual === "desativados") {
                    botoesAcao = `
                        <button title="Reativar Cliente" onclick="toggleDesativado(${index})" class="btn-success">‚ö°</button>
                        <button title="Excluir Cliente" onclick="excluir(${index})" class="btn-danger">‚ùå</button>
                    `;
                } else {
                    const dolaButtonClass = cliente.dola_sent ? 'btn-dola-sent' : 'btn-dola';
                    let botoesHtml = [];
                    if (cliente.observacao && acaoBotoesConfig.observacao.visivel) botoesHtml.push(`<button title="Ver Observa√ß√£o" class="btn-info pulsing-btn" onclick="mostrarObservacao(${index})">üí¨</button>`);
                    if (acaoBotoesConfig.dola.visivel) botoesHtml.push(`<button title="Enviar Lembrete Dola" class="${dolaButtonClass}" onclick="enviarMensagemWhatsAppDola(${index})">ü§ñ</button>`);
                    if (acaoBotoesConfig.renovarAuto.visivel) botoesHtml.push(`<button title="Renovar Autom√°tico" onclick="renovarAutomatico(${index})">üîÅ</button>`);
                    if (acaoBotoesConfig.debito.visivel) botoesHtml.push(`<button title="Renovar com D√©bito" class="btn-debito-segurar" onclick="pedirConfirmacaoRenovacaoDebito(${index})">üí∞</button>`);
                    if (acaoBotoesConfig.renovarHoje.visivel) botoesHtml.push(`<button title="Renovar a Partir de Hoje" class="btn-renovar-data-atual" onclick="pedirConfirmacaoRenovarHoje(${index})">üìÖ</button>`);
                    if (acaoBotoesConfig.verDepois.visivel) botoesHtml.push(`<button title="Agendar Reexibi√ß√£o" onclick="abrirModalVerDepois(${index})">‚è∞</button>`);
                    if (acaoBotoesConfig.produto.visivel) botoesHtml.push(`<button title="Alterar Produto" onclick="abrirModalAlterarProduto(${index})">üì¶</button>`);
                    if (acaoBotoesConfig.editar.visivel) botoesHtml.push(`<button title="Editar Cliente" onclick="editar(${index})">‚úèÔ∏è</button>`);
                    if (acaoBotoesConfig.excluir.visivel) botoesHtml.push(`<button title="Excluir Cliente" onclick="excluir(${index})" class="btn-danger">‚ùå</button>`);
                    if (acaoBotoesConfig.arquivar.visivel) botoesHtml.push(`<button title="Arquivar Cliente" onclick="arquivar(${index})">üìÇ</button>`);
                    if (acaoBotoesConfig.desativar.visivel) botoesHtml.push(`<button title="Desativar Cliente" onclick="toggleDesativado(${index})" class="btn-secondary">üîå</button>`);
                    if (acaoBotoesConfig.copiar.visivel) botoesHtml.push(`<button title="Copiar Mensagem WhatsApp" onclick="copiarMensagemWhatsApp(${index})">üìã</button>`);
                    if (acaoBotoesConfig.copiarNumero.visivel) botoesHtml.push(`<button title=\"Copiar N√∫mero do Cliente\" onclick=\"copiarNumeroCliente(${index})\">üî¢</button>`);
                    if (acaoBotoesConfig.duplicar.visivel) botoesHtml.push(`<button title="Duplicar Cliente" onclick="duplicarCliente(${index})">‚ûï</button>`);
                    botoesAcao = botoesHtml.join('');
                }

                const nomeExibicaoBase = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');
                const classeDinamica = cliente.clicado ? 'cliente-clicado' : '';
                
                let datasHtml = `<span>üìÖ ${formatDateForDisplay(cliente.data)}</span>`;
                if (cliente.dataCobranca) {
                    datasHtml += ` <span style="color: var(--success-color); font-weight: bold;">üí≤ ${formatDateForDisplay(cliente.dataCobranca)}</span>`;
                }

                tr.innerHTML = `
                    <td>
                        <input class="select-cliente" type="checkbox" data-id="${cliente.id}" aria-label="Selecionar cliente" onclick="toggleSelecaoCliente(String(cliente.id), this.checked); event.stopPropagation();">
                        ${datasHtml}
                        <a href="#" class="${classeDinamica}" onclick="marcarClienteClicado(this); enviarMensagemWhatsApp('${nomeExibicaoBase}', '${cliente.telefone}', ${index}); return false;">
                            ${nomeExibicaoBase} (${cliente.Produto || 'N/I'})
                        </a>
                        ${botoesAcao}
                    </td>
                `;
                tabela.appendChild(tr);
            });
            atualizarContadores();
        }

        async function toggleAvisadoFromAvisados(clientId) {
            const clienteOriginalIndex = clientes.findIndex(c => c.id === clientId);
            if (clienteOriginalIndex === -1) return;

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            clientes[clienteOriginalIndex].avisado = false;
            clientes[clienteOriginalIndex].oculto = false;
            clientes[clienteOriginalIndex].clicado = false;
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("desmarcado avisado", clientes[clienteOriginalIndex].nome);
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao desmarcar cliente como avisado: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha ao desmarcar avisado", clientes[clienteOriginalIndex].nome);
            }
        }

        function abrirModalVerDepoisById(clientId) {
            const id = String(clientId);
            let obj = (clientes || []).find(c => String(c.id) === id);
            if (!obj) obj = (popupClientClones || []).find(c => String(c.id) === id);

            if (obj) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [obj];
                abrirModalVerDepois(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function abrirModalAlterarProdutoById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                abrirModalAlterarProduto(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function editarClienteById(clientId) {
            const id = String(clientId);
            let obj = (clientes || []).find(c => String(c.id) === id);
            if (!obj) obj = (popupClientClones || []).find(c => String(c.id) === id);

            if (obj) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [obj];
                editar(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function excluirClienteById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                excluir(index);
            }
        }

        function arquivarById(clientId) {
            const id = String(clientId);
            let obj = (clientes || []).find(c => String(c.id) === id);
            if (!obj) obj = (popupClientClones || []).find(c => String(c.id) === id);

            if (obj) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [obj];
                arquivar(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function toggleDesativadoById(clientId) {
            const id = String(clientId);
            let obj = (clientes || []).find(c => String(c.id) === id);
            if (!obj) obj = (popupClientClones || []).find(c => String(c.id) === id);

            if (obj) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [obj];
                toggleDesativado(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function duplicarClienteById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                duplicarCliente(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function enviarMensagemWhatsAppDolaById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                enviarMensagemWhatsAppDola(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function renovarAutomatiscoById(clientId) {
            const index = clientes.findIndex(c => c.id === clientId);
            if (index !== -1) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [clientes[index]];
                renovarAutomatico(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function pedirConfirmacaoRenovacaoDebitoById(clientId) {
            const id = String(clientId);
            let obj = (clientes || []).find(c => String(c.id) === id);
            if (!obj) obj = (popupClientClones || []).find(c => String(c.id) === id);

            if (obj) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [obj];
                pedirConfirmacaoRenovacaoDebito(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        function pedirConfirmacaoRenovacaoDebito(index) {
             clienteIndexParaRenovarDebito = index;
             document.getElementById('modalRenovarComDebito').style.display = 'flex';
             document.getElementById('btnConfirmarRenovacaoDebito').onclick = confirmarRenovacaoComDebito;
        }

        function pedirConfirmacaoRenovarHojeById(clientId) {
            clienteIdParaRenovarHoje = clientId;
            exibirConfirmacaoGenerica("Confirmar Renova√ß√£o HOJE", "Tem certeza que deseja renovar a data de vencimento deste cliente para **HOJE**?", confirmarRenovarHoje, false);
        }

        async function renovarAutomatico(index) {
            const cliente = clientesExibidos[index];
            if (!cliente.Produto || cliente.Produto === "N√£o informado") {
                exibirAlerta("O produto do cliente n√£o est√° informado! Por favor, edite o cliente e defina o produto antes de renovar.");
                return;
            }
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const clienteOriginalIndex = clientes.findIndex(c => c.id === cliente.id);
            if (clienteOriginalIndex !== -1) {
                renovarProximoMes(clientes[clienteOriginalIndex]);
                clientes[clienteOriginalIndex].debito = false;
                clientes[clienteOriginalIndex].oculto = false;
                clientes[clienteOriginalIndex].avisado = false;
                clientes[clienteOriginalIndex].reexibirEm = null;
                clientes[clienteOriginalIndex].desativado = false;
                clientes[clienteOriginalIndex].dola_sent = false;
                clientes[clienteOriginalIndex].clicado = false;
            }
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            pushLog(clientes[clienteOriginalIndex], 'renovado', 'auto'); showToast('Renovado'); atualizarUltimaAtualizacao("renovado automaticamente", cliente.nome);
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao renovar automaticamente: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha na renova√ß√£o autom√°tica", cliente.nome);
            }
        }

        function pedirConfirmacaoRenovarHoje(index) {
            const cliente = clientesExibidos[index];
            clienteIdParaRenovarHoje = cliente.id;
            exibirConfirmacaoGenerica("Confirmar Renova√ß√£o HOJE", `Tem certeza que deseja renovar a data de vencimento de **${cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '')}** para **HOJE**?`, confirmarRenovarHoje, false);
        }

        async function confirmarRenovarHoje() {
            if (clienteIdParaRenovarHoje === null) return;

            const alvoId = clienteIdParaRenovarHoje;
            const clienteOriginalIndex = clientes.findIndex(c => c.id === alvoId);
            
            if (clienteOriginalIndex !== -1) {
                saveStateToHistory();
                const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
                const clienteOriginalNome = clientes[clienteOriginalIndex].nome;

                const hoje = new Date();
                const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" + (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" + hoje.getFullYear();

                clientes[clienteOriginalIndex].data = hojeFormatada;
                clientes[clienteOriginalIndex].debito = false;
                clientes[clienteOriginalIndex].oculto = false;
                clientes[clienteOriginalIndex].avisado = false;
                clientes[clienteOriginalIndex].reexibirEm = null;
                clientes[clienteOriginalIndex].desativado = false;
                clientes[clienteOriginalIndex].dola_sent = false;
                clientes[clienteOriginalIndex].clicado = false;

                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                pushLog(clientes[clienteOriginalIndex], 'renovado', 'hoje'); showToast('Renovado para hoje'); atualizarUltimaAtualizacao("renovado a partir da data atual", clienteOriginalNome);
                exibirAlerta(`Cliente "${clienteOriginalNome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '')}" renovado para hoje!`);

                try {
                    await salvarClientes();
                } catch (error) {
                    clientes = estadoAnteriorClientes;
                    saveClientsToLocalStorage();
                    chamarFiltroAtual();
                    atualizarContadores();
                    exibirAlerta(`Erro ao renovar para hoje: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                    atualizarUltimaAtualizacao("falha na renova√ß√£o para hoje", clienteOriginalNome);
                }

                clienteIdParaRenovarHoje = null;
                return;
            }

            const cloneIndex = (popupClientClones || []).findIndex(c => String(c.id) === String(alvoId));
            if (cloneIndex !== -1) {
                const clone = popupClientClones[cloneIndex];
                const nome = clone.nome;
                const hoje = new Date();
                const hojeFormatada = hoje.getDate().toString().padStart(2, '0') + "/" + (hoje.getMonth() + 1).toString().padStart(2, '0') + "/" + hoje.getFullYear();

                clone.data = hojeFormatada;
                clone.debito = false;
                clone.oculto = false;
                clone.avisado = false;
                clone.reexibirEm = null;
                clone.desativado = false;
                clone.dola_sent = false;
                clone.clicado = false;

                if (typeof pushLog === 'function') pushLog(clone, 'renovado', 'hoje (popup-clone)');
                savePopupClientClones();
                showToast('Renovado para hoje (clone)');
                atualizarUltimaAtualizacao("renovado a partir da data atual (clone)", nome);

                try { checarEExibirPopupVencendo(); } catch (e) {}
            }

            clienteIdParaRenovarHoje = null;
        }

        async function confirmarRenovacaoComDebito() {
            if (clienteIndexParaRenovarDebito === null) return;

            const cliente = clientesExibidos[clienteIndexParaRenovarDebito];
            if (!cliente) {
                fecharModal();
                clienteIndexParaRenovarDebito = null;
                return;
            }

            if (!cliente.Produto || cliente.Produto === "N√£o informado") {
                exibirAlerta("O produto do cliente n√£o est√° informado! Por favor, edite o cliente e defina o produto antes de renovar.");
                fecharModal();
                clienteIndexParaRenovarDebito = null;
                return;
            }

            const clienteOriginalIndex = clientes.findIndex(c => c.id === cliente.id);
            if (clienteOriginalIndex !== -1) {
                saveStateToHistory();
                const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
                const clienteNome = cliente.nome;

                renovarProximoMes(clientes[clienteOriginalIndex]);
                clientes[clienteOriginalIndex].debito = true;
                clientes[clienteOriginalIndex].oculto = false;
                clientes[clienteOriginalIndex].avisado = false;
                clientes[clienteOriginalIndex].reexibirEm = null;
                clientes[clienteOriginalIndex].desativado = false;
                clientes[clienteOriginalIndex].dola_sent = false;
                clientes[clienteOriginalIndex].clicado = false;

                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                fecharModal();
                clienteIndexParaRenovarDebito = null;
                exibirAlerta("Cliente renovado e marcado como D√âBITO!");
                pushLog(clientes[clienteOriginalIndex], 'renovado', 'd√©bito'); showToast('Renovado (d√©bito)'); atualizarUltimaAtualizacao("renovado com d√©bito", clienteNome);

                try {
                    await salvarClientes();
                } catch (error) {
                    clientes = estadoAnteriorClientes;
                    saveClientsToLocalStorage();
                    chamarFiltroAtual();
                    atualizarContadores();
                    exibirAlerta(`Erro ao renovar com d√©bito: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                    atualizarUltimaAtualizacao("falha na renova√ß√£o com d√©bito", clienteNome);
                }
                return;
            }

            const cloneIndex = (popupClientClones || []).findIndex(c => String(c.id) === String(cliente.id));
            if (cloneIndex !== -1) {
                const clone = popupClientClones[cloneIndex];
                const clienteNome = clone.nome;

                renovarProximoMes(clone);
                clone.debito = true;
                clone.oculto = false;
                clone.avisado = false;
                clone.reexibirEm = null;
                clone.desativado = false;
                clone.dola_sent = false;
                clone.clicado = false;

                savePopupClientClones();
                fecharModal();
                clienteIndexParaRenovarDebito = null;

                if (typeof pushLog === 'function') pushLog(clone, 'renovado', 'd√©bito (popup-clone)');
                showToast('Renovado (d√©bito)');
                atualizarUltimaAtualizacao("renovado com d√©bito (clone)", clienteNome);
                exibirAlerta("Cliente (clone) renovado e marcado como D√âBITO!");

                try { checarEExibirPopupVencendo(); } catch (e) {}
                return;
            }

            fecharModal();
            clienteIndexParaRenovarDebito = null;
        }

        function renovarProximoMes(clienteObj) {
            const [dia, mes, ano] = clienteObj.data.split("/").map(num => parseInt(num));
            const dataObj = new Date(ano, mes - 1, dia);
            dataObj.setMonth(dataObj.getMonth() + 1);
            if (dataObj.getDate() !== dia) {
                dataObj.setDate(0);
            }
            clienteObj.data = `${dataObj.getDate().toString().padStart(2, '0')}/${(dataObj.getMonth() + 1).toString().padStart(2, '0')}/${dataObj.getFullYear()}`;
        }

        function duplicarCliente(index) {
            clienteIndexParaDuplicar = index;
            document.getElementById("modalConfirmacao").style.display = "flex";
        }

        async function confirmarDuplicacao() {
            if (clienteIndexParaDuplicar === null) return;
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const clienteOriginal = clientesExibidos[clienteIndexParaDuplicar];
            let novoTelefoneBase = clienteOriginal.telefone;
            let novoId = clienteOriginal.id;
            let contadorDuplicacao = 1;
            while (clientes.some(c => c.id === novoId)) {
                novoTelefoneBase = clienteOriginal.telefone + '_' + contadorDuplicacao;
                novoId = novoTelefoneBase.slice(-5);
                if (novoTelefoneBase.length < 5) {
                    novoId = "DUP" + String(contadorDuplicacao).padStart(3, '0');
                } else {
                    novoId = novoTelefoneBase.slice(-5);
                }
                contadorDuplicacao++;
                if (contadorDuplicacao > 100) {
                    exibirAlerta("N√£o foi poss√≠vel gerar um ID √∫nico para a duplica√ß√£o. Tente novamente.");
                    fecharModal();
                    return;
                }
            }
            const novoCliente = {
                id: novoId,
                data: clienteOriginal.data,
                nome: clienteOriginal.nome + " (C√≥pia)",
                telefone: novoTelefoneBase,
                avisado: false,
                debito: false,
                Produto: clienteOriginal.Produto || "N√£o informado",
                arquivado: false,
                oculto: false,
                reexibirEm: null,
                desativado: false,
                dola_sent: false,
                clicado: false,
                dataCobranca: clienteOriginal.dataCobranca
            };
            clientes.push(novoCliente);
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            fecharModal();
            clienteIndexParaDuplicar = null;
            atualizarUltimaAtualizacao("duplicado", clienteOriginal.nome);
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao duplicar cliente: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha na duplica√ß√£o", clienteOriginal.nome);
            }
        }

        function getNomeMes(mesNumero) {
            const meses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            return meses[mesNumero - 1];
        }

        async function copiarMensagemWhatsApp(index) {
            const cliente = clientesExibidos[index];
            const nomeExibicaoBase = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');
            const vencimento = cliente.data;
            const hoje = new Date();
            const [diaVenc, mesVenc, anoVenc] = vencimento.split("/").map(num => parseInt(num));
            const dataVencimentoObj = new Date(anoVenc, mesVenc - 1, diaVenc);
            const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
            const dataVencimentoSemHora = new Date(dataVencimentoObj.getFullYear(), dataVencimentoObj.getMonth(), dataVencimentoObj.getDate());
            const vencido = dataVencimentoSemHora < hojeSemHora;
            const hora = hoje.getHours();
            let saudacao = (hora >= 6 && hora < 12) ? "Bom dia" : (hora >= 12 && hora < 18) ? "Boa tarde" : "Boa noite";
            const nomeMes = getNomeMes(parseInt(mesVenc));
            let mensagem;
            if (vencido) {
                mensagem = `${saudacao}! Lembrete de vencimento *${vencimento} (${nomeMes})*.O pagamento via PIX pode ser feito no n√∫mero: *11947406124* (Waldemar Jose Luiz)`;
            } else {
                mensagem = `${saudacao}! Lembrete de *Vencimento*: ${cliente.data} (${nomeMes})O pagamento via PIX pode ser realizado no n√∫mero: *11947406124* (Waldemar Jose Luiz)`;
            }
            try {
                await navigator.clipboard.writeText(mensagem);
                exibirAlerta("Mensagem copiada para a √°rea de transfer√™ncia!");
            } catch (err) {
                exibirAlerta("Erro ao copiar a mensagem. Por favor, tente novamente.");
            }
        }

        async function copiarMensagemWhatsAppById(clientId) {
            const id = String(clientId);
            let obj = (clientes || []).find(c => String(c.id) === id);
            if (!obj) obj = (popupClientClones || []).find(c => String(c.id) === id);

            if (obj) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [obj];
                await copiarMensagemWhatsApp(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        async function copiarNumeroCliente(index) {
            const cliente = clientesExibidos[index];
            const numero = (cliente && cliente.telefone) ? String(cliente.telefone).replace(/\D/g, '') : '';
            if (!numero) return exibirAlerta("N√∫mero do cliente inv√°lido!");
            try {
                await navigator.clipboard.writeText(numero);
                showToast("N√∫mero copiado!");
            } catch (err) {
                exibirAlerta("N√£o consegui copiar automaticamente. N√∫mero: " + numero);
            }
        }

        async function copiarNumeroClienteById(clientId) {
            const id = String(clientId);
            let obj = (clientes || []).find(c => String(c.id) === id);
            if (!obj) obj = (popupClientClones || []).find(c => String(c.id) === id);

            if (obj) {
                const originalClientesExibidos = clientesExibidos;
                clientesExibidos = [obj];
                await copiarNumeroCliente(0);
                clientesExibidos = originalClientesExibidos;
            }
        }

        async function enviarMensagemWhatsAppDola(index) {
            const cliente = clientesExibidos[index];
            let telefoneParaWhatsApp = cliente.telefone.replace(/\D/g, '');
            if (!telefoneParaWhatsApp) {
                exibirAlerta("N√∫mero de telefone inv√°lido!");
                return;
            }
            if (!telefoneParaWhatsApp.startsWith('55')) {
                telefoneParaWhatsApp = '55' + telefoneParaWhatsApp;
            }

            const [diaVenc, mesVenc] = cliente.data.split('/');
            const mensagemDolaLembrete = `oi me lembre todo dia ${diaVenc} de cada m√™s de pagar Tv para Luiz no pix 11947406124 no nome de Waldemar jose luiz.`;
            const urlDola = `https://wa.me/16502234435?text=${encodeURIComponent(mensagemDolaLembrete)}`;
            const nomeMes = getNomeMes(parseInt(mesVenc));
            const mensagemCliente = `Ol√°! Lembrete de vencimento do seu plano de TV. üìÖ Vencimento: ${cliente.data} (${nomeMes}).üí≥ Pix: 11947406124 (Waldemar Jos√© Luiz).\nüîî Para ser lembrado automaticamente todo m√™s, clique em "Conversar" no link abaixo, ative o lembrete com o Dola e depois confirme aqui comigo se deu certo:\n${urlDola}\n‚ùì Qualquer d√∫vida, entre em contato.`;
            const urlFinal = `https://wa.me/${telefoneParaWhatsApp}?text=${encodeURIComponent(mensagemCliente)}`;
            window.open(urlFinal, '_blank');

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            let clienteOriginal = clientes.find(c => c.id === cliente.id);
            if (clienteOriginal) {
                clienteOriginal.oculto = false;
                clienteOriginal.dola_sent = true;
                clienteOriginal.clicado = true;
            }
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("mensagem Dola enviada", cliente.nome);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao enviar mensagem WhatsApp: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha no envio de mensagem Dola", cliente.nome);
            }
        }

        async function enviarMensagemWhatsApp(clienteNome, clienteTelefone, index) {
            let telefoneParaWhatsApp = clienteTelefone.replace(/\D/g, '');
            if (!telefoneParaWhatsApp) {
                exibirAlerta("N√∫mero de telefone inv√°lido!");
                return;
            }
            if (!telefoneParaWhatsApp.startsWith('55')) {
                telefoneParaWhatsApp = '55' + telefoneParaWhatsApp;
            }
            const cliente = clientesExibidos[index];
            const vencimento = cliente.data;
            const hoje = new Date();
            const [diaVenc, mesVenc, anoVenc] = vencimento.split("/").map(num => parseInt(num));
            const dataVencimentoObj = new Date(anoVenc, mesVenc - 1, diaVenc);
            const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
            const dataVencimentoSemHora = new Date(dataVencimentoObj.getFullYear(), dataVencimentoObj.getMonth(), dataVencimentoObj.getDate());
            const vencido = dataVencimentoSemHora < hojeSemHora;
            const hora = hoje.getHours();
            let saudacao = (hora >= 6 && hora < 12) ? "Bom dia" : (hora >= 12 && hora < 18) ? "Boa tarde" : "Boa noite";
            const nomeMes = getNomeMes(parseInt(mesVenc));
            let mensagem;
            if (vencido) {
                mensagem = `${saudacao}! Lembrete de *vencimento* *${vencimento} (${nomeMes})*. O pagamento via PIX pode ser feito no n√∫mero: *11947406124* (Waldemar Jose Luiz)`;
            } else {
                mensagem = `${saudacao}! Lembrete de vencimento *Vencimento*: ${cliente.data} (${nomeMes})O pagamento via PIX pode ser realizado no n√∫mero: *11947406124* (Waldemar Jose Luiz)`;
            }
            const url = `https://wa.me/${telefoneParaWhatsApp}?text=${encodeURIComponent(mensagem)}`;
            window.open(url, '_blank');

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            let clienteOriginal = clientes.find(c => c.id === cliente.id);
            if (clienteOriginal) {
                clienteOriginal.avisado = true;
                clienteOriginal.oculto = false;
                clienteOriginal.clicado = true;
            }
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("mensagem WhatsApp enviada", cliente.nome);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao enviar mensagem WhatsApp: ${error.message}. A√ß√£o desfeita localmente. Tente novamente.`);
                atualizarUltimaAtualizacao("falha no envio de mensagem", cliente.nome);
            }
        }

        function exportarClientes() {
            const clientesParaExportar = clientes.map(c => ({
                id: c.id,
                data: c.data,
                nome: c.nome,
                telefone: c.telefone,
                avisado: c.avisado || false,
                debito: c.debito || false,
                Produto: c.Produto || "N√£o informado",
                arquivado: c.arquivado || false,
                oculto: c.oculto || false,
                reexibirEm: c.reexibirEm || null,
                desativado: c.desativado || false,
                dola_sent: c.dola_sent || false,
                clicado: c.clicado || false,
                dataCobranca: c.dataCobranca || null,
                observacao: c.observacao || null,
                logs: c.logs || []
            }));
            const clientesJson = JSON.stringify(clientesParaExportar, null, 4);
            const blob = new Blob([clientesJson], {
                type: "application/json"
            });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "clientes.json";
            link.click();
            atualizarUltimaAtualizacao("clientes exportados");
        }

        async function importarClientes(file = null) {
            let fileToImport = file;
            if (!fileToImport) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => importarClientes(e.target.files[0]);
                input.click();
                return;
            }

            mostrarCarregando();
            const reader = new FileReader();
            reader.onload = async () => {
                try {
                    saveStateToHistory();
                    const clientesImportadosRaw = JSON.parse(reader.result);
                    const clientesProcessados = clientesImportadosRaw.map(c => {
                        const telefoneLimpo = c.telefone ? String(c.telefone).replace(/[^\d]/g, '') : '';
                        const id = telefoneLimpo.length >= 5 ? telefoneLimpo.slice(-5) : null;
                        const nomeAjustado = c.Produto && !c.nome.includes(`(${c.Produto})`) ?
                            `${c.nome.replace(/\s\(UniTv\)|\(Duplecast\)/g, '').trim()} (${c.Produto})` : c.nome;
                        return {
                            id: id,
                            data: c.data,
                            nome: nomeAjustado,
                            telefone: telefoneLimpo,
                            avisado: c.avisado || false,
                            debito: c.debito || false,
                            Produto: c.Produto || "N√£o informado",
                            arquivado: c.arquivado || false,
                            oculto: c.oculto || false,
                            reexibirEm: c.reexibirEm || null,
                            desativado: c.desativado || false,
                            dola_sent: c.dola_sent || false,
                            clicado: c.clicado || false,
                            dataCobranca: c.dataCobranca || null,
                            observacao: c.observacao || null,
                            logs: c.logs || []
                        };
                    });

                    let novosClientesAdicionados = 0,
                        clientesAtualizados = 0,
                        clientesIgnorados = 0;

                    for (const clienteImportado of clientesProcessados) {
                        if (!clienteImportado.id) {
                            clientesIgnorados++;
                            continue;
                        }
                        const indexClienteExistente = clientes.findIndex(c => c.id === clienteImportado.id);
                        if (indexClienteExistente !== -1) {
                            clientes[indexClienteExistente] = { ...clientes[indexClienteExistente], ...clienteImportado };
                            clientesAtualizados++;
                        } else {
                            clientes.push(clienteImportado);
                            novosClientesAdicionados++;
                        }
                    }

                    saveClientsToLocalStorage();
                    chamarFiltroAtual();
                    atualizarContadores();
                    prepararClientesVencidosParaMensagem();
                    exibirAlerta(`Importa√ß√£o conclu√≠da: ${novosClientesAdicionados} novos, ${clientesAtualizados} atualizados, ${clientesIgnorados} ignorados.`);
                    atualizarUltimaAtualizacao("clientes importados/atualizados");

                    await salvarClientes();
                } catch (error) {
                    exibirAlerta("Erro ao importar JSON. Verifique o arquivo.");
                    console.error("Erro ao importar:", error);
                } finally {
                    esconderCarregando();
                }
            };
            reader.readAsText(fileToImport);
        }

        function filtrarHoje() {
            filtroAtual = "hoje";
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
        }

        function filtrarAmanha() {
            filtroAtual = "amanha";
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
        }

        function filtrarVencidos() {
            filtroAtual = "vencidos";
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
        }

        function filtrarDebito() {
            filtroAtual = "debito";
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
        }

        function chamarFiltroAtual() {
            const filtros = {
                "hojeEVencidos": filtrarHojeEVencidos,
                "cobrancaHoje": filtrarCobrancaHoje,
                "hoje": filtrarHoje,
                "amanha": filtrarAmanha,
                "vencidos": filtrarVencidos,
                "debito": filtrarDebito,
                "verDepois": filtrarVerDepois,
                "arquivados": filtrarArquivados,
                "desativados": filtrarDesativados,
                "todos": exibirTodos
            };
            if (filtros[filtroAtual]) {
                filtros[filtroAtual]();
            } else if (filtroAtual.startsWith("produto:")) {
                filtrarPorProduto(filtroAtual.split(":")[1]);
            } else {
                filtrarHojeEVencidos();
            }
        }

        function exibirTodos() {
            filtroAtual = "todos";
            document.getElementById("searchInput").value = "";
            exibirTabela();
            atualizarContadores();
        }

        function confirmarLimparTodos() {
            exibirConfirmacaoGenerica("Limpar Todos os Clientes", "Tem certeza que deseja limpar **TODOS** os clientes? Essa a√ß√£o n√£o pode ser desfeita!", limparTodos, true);
        }

        function confirmarDesfazer() {
            if (historicoClientes.length <= 1) {
                exibirAlerta("N√£o h√° a√ß√µes para desfazer.");
                return;
            }
            exibirConfirmacaoGenerica("Desfazer √öltima A√ß√£o", "Tem certeza que deseja desfazer a √∫ltima altera√ß√£o?", desfazer, false);
        }

        function confirmarRefazer() {
            if (redoHistory.length === 0) {
                exibirAlerta("N√£o h√° a√ß√µes para refazer.");
                return;
            }
            exibirConfirmacaoGenerica("Refazer √öltima A√ß√£o", "Tem certeza que deseja refazer a √∫ltima a√ß√£o desfeita?", refazer, false);
        }

        async function limparTodos() {
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            clientes = [];
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("lista limpa", "");
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (e) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao limpar clientes no Google Sheets: ${e.message}. A√ß√£o desfeita localmente.`);
            }
        }

        async function desfazer() {
            if (historicoClientes.length <= 1) return;
            redoHistory.push(JSON.parse(JSON.stringify(clientes)));
            historicoClientes.pop();
            clientes = JSON.parse(JSON.stringify(historicoClientes[historicoClientes.length - 1]));
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            prepararClientesVencidosParaMensagem();
            atualizarUltimaAtualizacao("a√ß√£o desfeita");
            await salvarClientes();
        }

        async function refazer() {
            if (redoHistory.length === 0) return;
            historicoClientes.push(JSON.parse(JSON.stringify(clientes)));
            clientes = redoHistory.pop();
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            prepararClientesVencidosParaMensagem();
            atualizarUltimaAtualizacao("a√ß√£o refeita");
            await salvarClientes();
        }

        function editar(index) {
            let cliente = clientesExibidos[index];
            const modalEdicao = document.getElementById("modalEdicao");
            modalEdicao.style.display = "flex";
            const nomeLimpo = cliente.nome.replace(/\s\(UniTv\)/g, '').replace(/\s\(Duplecast\)/g, '');
            modalEdicao.innerHTML = `
                <div class="modal-content">
                    <h3>Editar Cliente</h3>
                    <input type="text" id="novoNome" value="${nomeLimpo}" placeholder="Nome"><br><br>
                    <input type="tel" id="novoTelefone" value="${cliente.telefone}" placeholder="Telefone"><br><br>
                    <label>Data de Vencimento</label><br>
                    <input type="date" id="novaData" value="${formatarParaInputDate(cliente.data)}"><br><br>
                    <label>Data de Cobran√ßa (Opcional)</label><br>
                    <input type="date" id="novaDataCobranca" value="${formatarParaInputDate(cliente.dataCobranca)}"><br><br>
                    <textarea id="novaObservacao" placeholder="Observa√ß√£o (Opcional)">${cliente.observacao || ''}</textarea><br><br>
                    <div>
                        <label><input type="radio" name="editarProduto" value="UniTv" ${cliente.Produto === "UniTv" ? "checked" : ""}> UniTv</label>
                        <label><input type="radio" name="editarProduto" value="Duplecast" ${cliente.Produto === "Duplecast" ? "checked" : ""}> Duplecast</label>
                    </div><br>
                    <button id="salvarBtn" class="btn-success icon-btn" title="Salvar">üíæ</button>
                    <button onclick="fecharModal()" class="btn-secondary icon-btn" title="Cancelar">‚ùå</button>
                </div>
            `;
            document.getElementById("salvarBtn").onclick = () => salvarEdicao(cliente.id);

            const novoNomeInput = document.getElementById('novoNome');
            const novoTelefoneInput = document.getElementById('novoTelefone');
            const novaDataInput = document.getElementById('novaData');

            novoNomeInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    novoTelefoneInput.focus();
                }
            });
            novoTelefoneInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    novaDataInput.focus();
                }
            });
            novaDataInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    salvarEdicao(cliente.id);
                }
            });

            document.addEventListener("keydown", fecharComEsc);
        }
        
        function mostrarObservacao(index) {
            const cliente = clientesExibidos[index];
            if (cliente && cliente.observacao) {
                exibirAlerta(`<b>Observa√ß√£o para ${cliente.nome.replace(/\s\(.*\)/, '')}:</b><br><br>${cliente.observacao}`);
            }
        }

        async function salvarEdicao(clientId) {
            const originalClienteIndex = clientes.findIndex(c => c.id === clientId);
            const cloneIndex = (popupClientClones || []).findIndex(c => String(c.id) === String(clientId));

            if (originalClienteIndex === -1 && cloneIndex === -1) return;

            let novoNome = document.getElementById("novoNome").value.trim();
            let novoTelefone = document.getElementById("novoTelefone").value.trim();
            let novaData = document.getElementById("novaData").value.trim();
            let novaDataCobranca = document.getElementById("novaDataCobranca").value.trim();
            let novaObservacao = document.getElementById("novaObservacao").value.trim();
            let novoProduto = document.querySelector('input[name="editarProduto"]:checked').value;

            if (!novoNome || !novaData) {
                exibirAlerta("Nome e data de vencimento s√£o obrigat√≥rios!");
                return;
            }

            const telefoneLimpoEditado = novoTelefone.replace(/[^\d]/g, '');
            if (telefoneLimpoEditado.length < 5) {
                exibirAlerta("O telefone deve ter pelo menos 5 d√≠gitos.");
                return;
            }

            let nomeComNovoProduto = `${novoNome.replace(/\s\(UniTv\)|\(Duplecast\)/g, '').trim()} (${novoProduto})`;

            if (cloneIndex !== -1 && originalClienteIndex === -1) {
                const cloneIdFixo = popupClientClones[cloneIndex].id;

                popupClientClones[cloneIndex] = {
                    ...popupClientClones[cloneIndex],
                    id: cloneIdFixo,
                    nome: nomeComNovoProduto,
                    telefone: telefoneLimpoEditado,
                    data: novaData.split("-").reverse().join("/"),
                    Produto: novoProduto,
                    dola_sent: false,
                    clicado: false,
                    dataCobranca: novaDataCobranca ? novaDataCobranca.split("-").reverse().join("/") : null,
                    observacao: novaObservacao || null
                };

                if (typeof pushLog === 'function') pushLog(popupClientClones[cloneIndex], 'editado', 'popup-clone');
                savePopupClientClones();
                fecharModal();
                showToast('Cliente (clone) editado');
                atualizarUltimaAtualizacao("editado (clone)", nomeComNovoProduto);

                try { checarEExibirPopupVencendo(); } catch (e) {}
                return;
            }

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));

            const novoId = telefoneLimpoEditado.slice(-5);
            if (novoId !== clientId && clientes.some(c => c.id === novoId)) {
                exibirAlerta(`O novo telefone final (${novoId}) j√° est√° em uso.`);
                return;
            }

            clientes[originalClienteIndex] = {
                ...clientes[originalClienteIndex],
                id: novoId,
                nome: nomeComNovoProduto,
                telefone: telefoneLimpoEditado,
                data: novaData.split("-").reverse().join("/"),
                Produto: novoProduto,
                dola_sent: false,
                clicado: false,
                dataCobranca: novaDataCobranca ? novaDataCobranca.split("-").reverse().join("/") : null,
                observacao: novaObservacao || null
            };

            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            fecharModal();
            pushLog(clientes[originalClienteIndex], 'editado', ''); showToast('Cliente editado'); atualizarUltimaAtualizacao("editado", nomeComNovoProduto);
            prepararClientesVencidosParaMensagem();

            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao salvar edi√ß√£o: ${error.message}. A√ß√£o desfeita localmente.`);
            }
        }

        function formatarParaInputDate(data) {
            if (!data) return '';
            let parts = data.split("/");
            if(parts.length !== 3) return '';
            let [dia, mes, ano] = parts;
            return `${ano}-${mes}-${dia}`;
        }

        function excluir(index) {
            const cliente = clientesExibidos[index];
            clienteIndexParaExcluir = clientes.findIndex(c => c.id === cliente.id);
            if (clienteIndexParaExcluir !== -1) {
                document.getElementById("modalExclusao").style.display = "flex";
            }
        }

        async function confirmarExclusao() {
            if (clienteIndexParaExcluir === null) return;
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const nomeClienteExcluido = clientes[clienteIndexParaExcluir].nome;
            clientes.splice(clienteIndexParaExcluir, 1);
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            fecharModal();
            clienteIndexParaExcluir = null;
            showToast('Cliente exclu√≠do'); atualizarUltimaAtualizacao("exclu√≠do", nomeClienteExcluido);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (e) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao excluir cliente no Google Sheets: ${e.message}. A√ß√£o desfeita localmente.`);
            }
        }

        function abrirModalVerDepois(index) {
            const cliente = clientesExibidos[index];
            clienteIdParaVerDepois = cliente.id;
            const amanha = new Date();
            amanha.setDate(amanha.getDate() + 1);
            document.getElementById('dataReexibicaoInput').value = amanha.toISOString().split('T')[0];
            document.getElementById('modalVerDepois').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('dataReexibicaoInput').focus();
            }, 0);
            document.addEventListener("keydown", fecharComEsc);
        }

        async function confirmarVerDepois() {
            if (!clienteIdParaVerDepois) return;
            const dataReexibicao = document.getElementById('dataReexibicaoInput').value;
            if (!dataReexibicao) {
                exibirAlerta("Por favor, selecione uma data.");
                return;
            }

            const clienteOriginalIndex = clientes.findIndex(c => c.id === clienteIdParaVerDepois);

            if (clienteOriginalIndex === -1) {
                const cloneIndex = (popupClientClones || []).findIndex(c => String(c.id) === String(clienteIdParaVerDepois));
                if (cloneIndex === -1) return;

                const nomeCliente = popupClientClones[cloneIndex].nome;
                popupClientClones[cloneIndex].reexibirEm = dataReexibicao;
                popupClientClones[cloneIndex].oculto = false;
                popupClientClones[cloneIndex].arquivado = false;
                popupClientClones[cloneIndex].desativado = false;
                popupClientClones[cloneIndex].clicado = false;

                fecharModal();
                if (typeof pushLog === 'function') pushLog(popupClientClones[cloneIndex], 'ver depois', dataReexibicao.split('-').reverse().join('/'));
                showToast('Agendado');
                atualizarUltimaAtualizacao(`agendado para ${dataReexibicao.split('-').reverse().join('/')}`, nomeCliente);

                savePopupClientClones();
                try { checarEExibirPopupVencendo(); } catch (e) {}

                clienteIdParaVerDepois = null;
                return;
            }

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const nomeCliente = clientes[clienteOriginalIndex].nome;
            clientes[clienteOriginalIndex].reexibirEm = dataReexibicao;
            clientes[clienteOriginalIndex].oculto = false;
            clientes[clienteOriginalIndex].arquivado = false;
            clientes[clienteOriginalIndex].desativado = false;
            clientes[clienteOriginalIndex].clicado = false;
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            fecharModal();
            pushLog(clientes[clienteOriginalIndex], 'ver depois', dataReexibicao.split('-').reverse().join('/')); showToast('Agendado'); atualizarUltimaAtualizacao(`agendado para ${dataReexibicao.split('-').reverse().join('/')}`, nomeCliente);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao agendar cliente: ${error.message}. A√ß√£o desfeita localmente.`);
            }

            clienteIdParaVerDepois = null;
        }

        async function desmarcarVerDepois(index) {
            const cliente = clientesExibidos[index];
            const clienteOriginalIndex = clientes.findIndex(c => c.id === cliente.id);
            if (clienteOriginalIndex === -1) return;
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const nomeCliente = clientes[clienteOriginalIndex].nome;
            clientes[clienteOriginalIndex].reexibirEm = null;
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            atualizarUltimaAtualizacao("reexibido (agendamento removido)", nomeCliente);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao desmarcar cliente: ${error.message}. A√ß√£o desfeita localmente.`);
            }
        }

        async function toggleDesativado(index) {
            const cliente = clientesExibidos[index];
            if (!cliente) return;

            const clienteOriginalIndex = clientes.findIndex(c => c.id === cliente.id);

            if (clienteOriginalIndex === -1) {
                const cloneIndex = (popupClientClones || []).findIndex(c => String(c.id) === String(cliente.id));
                if (cloneIndex === -1) return;

                const clone = popupClientClones[cloneIndex];
                clone.desativado = !clone.desativado;

                if (clone.desativado) {
                    clone.avisado = false;
                    clone.debito = false;
                    clone.oculto = false;
                    clone.reexibirEm = null;
                    clone.arquivado = false;
                    clone.clicado = false;
                }

                if (typeof pushLog === 'function') pushLog(clone, clone.desativado ? 'desativado' : 'reativado', 'popup-clone');
                savePopupClientClones();
                showToast(clone.desativado ? 'Desativado' : 'Reativado');
                atualizarUltimaAtualizacao(`status desativado (clone): ${clone.desativado ? 'sim' : 'n√£o'}`, clone.nome);

                try { checarEExibirPopupVencendo(); } catch (e) {}
                return;
            }

            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            clientes[clienteOriginalIndex].desativado = !clientes[clienteOriginalIndex].desativado;
            if (clientes[clienteOriginalIndex].desativado) {
                clientes[clienteOriginalIndex].avisado = false;
                clientes[clienteOriginalIndex].debito = false;
                clientes[clienteOriginalIndex].oculto = false;
                clientes[clienteOriginalIndex].reexibirEm = null;
                clientes[clienteOriginalIndex].arquivado = false;
                clientes[clienteOriginalIndex].clicado = false;
            }
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            pushLog(clientes[clienteOriginalIndex], clientes[clienteOriginalIndex].desativado ? 'desativado' : 'reativado', ''); showToast(clientes[clienteOriginalIndex].desativado ? 'Desativado' : 'Reativado'); atualizarUltimaAtualizacao(`status desativado: ${clientes[clienteOriginalIndex].desativado ? 'sim' : 'n√£o'}`, cliente.nome);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao alterar status desativado: ${error.message}. A√ß√£o desfeita localmente.`);
            }
        }

        function abrirModalAlterarProduto(index) {
            clienteIndexParaAlterarProduto = index;
            document.getElementById('modalEscolherProduto').style.display = 'flex';
        }

        async function alterarProdutoClienteConfirm(novoProduto) {
            if (clienteIndexParaAlterarProduto === null) return;
            saveStateToHistory();
            const estadoAnteriorClientes = JSON.parse(JSON.stringify(clientes));
            const clienteParaAtualizar = clientesExibidos[clienteIndexParaAlterarProduto];
            let clienteOriginalIndex = clientes.findIndex(c => c.id === clienteParaAtualizar.id);
            const clienteNome = clienteParaAtualizar.nome;
            if (clienteOriginalIndex !== -1) {
                let nomeSemProduto = clientes[clienteOriginalIndex].nome.replace(/\s\(UniTv\)|\(Duplecast\)/g, '').trim();
                clientes[clienteOriginalIndex].Produto = novoProduto;
                clientes[clienteOriginalIndex].nome = `${nomeSemProduto} (${novoProduto})`;
                clientes[clienteOriginalIndex].clicado = false;
            }
            saveClientsToLocalStorage();
            chamarFiltroAtual();
            atualizarContadores();
            fecharModal();
            clienteIndexParaAlterarProduto = null;
            exibirAlerta(`Produto do cliente alterado para ${novoProduto}!`);
            atualizarUltimaAtualizacao(`produto alterado para ${novoProduto}`, clienteNome);
            prepararClientesVencidosParaMensagem();
            try {
                await salvarClientes();
            } catch (error) {
                clientes = estadoAnteriorClientes;
                saveClientsToLocalStorage();
                chamarFiltroAtual();
                atualizarContadores();
                exibirAlerta(`Erro ao alterar produto: ${error.message}. A√ß√£o desfeita localmente.`);
            }
        }

        async function salvarClientes() {
            try {
                const response = await sendRequestToBackend('bulk_update_clients', {
                    clients: clientes
                });
                if (response.status !== 'success') {
                    throw new Error(response.message || 'Erro ao sincronizar com backend.');
                }
            } catch (e) {
                console.error("Erro ao salvar clientes no Google Sheets:", e);
                throw e;
            }
        }

        async function loadClientes() {
            addAppLog('INFO', 'loadClientes:start', 'Carregando clientes...');
            setTopStatus('Status: carregando clientes...');
            mostrarCarregando();
            try {
                const response = await sendRequestToBackend('get_all_clients');
                if (Array.isArray(response)) {
                    clientes = response.map(c => {
                        const telefoneLimpo = String(c.telefone || '').replace(/[^\d]/g, '');
                        const clienteId = telefoneLimpo.length >= 5 ? telefoneLimpo.slice(-5) : null;
                        let dataClienteFormatada = c.data;
                        if (c.data && typeof c.data === 'string') {
                            let datePart = c.data.split('T')[0];
                            const parts = datePart.split('-');
                            if (parts.length === 3) {
                                dataClienteFormatada = `${parts[2]}/${parts[1]}/${parts[0]}`;
                            }
                        }
                        return {
                            id: c.id || clienteId,
                            data: dataClienteFormatada,
                            nome: c.nome,
                            telefone: telefoneLimpo,
                            avisado: c.avisado || false,
                            debito: c.debito || false,
                            Produto: c.Produto || "N√£o informado",
                            arquivado: c.arquivado || false,
                            oculto: c.oculto || false,
                            reexibirEm: c.reexibirEm || null,
                            desativado: c.desativado || false,
                            dola_sent: c.dola_sent || false,
                            clicado: c.clicado || false,
                            dataCobranca: c.dataCobranca || null,
                            observacao: c.observacao || null,
                            logs: c.logs || []
                        };
                    }).filter(c => c.id !== null);
                    saveClientsToLocalStorage();
                } else {
                    throw new Error("Formato de dados inv√°lido.");
                }
                addAppLog('OK', 'loadClientes:done', `Total: ${(clientes||[]).length}`);
                setTopStatus('Status: pronto');
            } catch (e) {
                console.error("Erro ao carregar do Sheets:", e);
                const cache = localStorage.getItem('clientesCache');
                if (cache) {
                    try {
                        clientes = JSON.parse(cache);
                        exibirAlerta("Erro ao carregar dados. Carregando do cache local.");
                    } catch (parseError) {
                        clientes = [];
                        exibirAlerta("Erro no Sheets e cache corrompido.");
                    }
                } else {
                    clientes = [];
                    exibirAlerta("Erro ao carregar e sem cache local.");
                }
                setTopStatus('Status: erro de carregamento');
            } finally {
                esconderCarregando();
                loadConfiguracaoBotoes();
                filtrarHojeEVencidos();
                prepararClientesVencidosParaMensagem();
                saveStateToHistory();
                loadSettings();
                restoreAddSectionState();
                limparSelecao();
                setTimeout(checarEExibirPopupVencendo, 150);
            }

            document.getElementById('ultimaAtualizacaoInfo').textContent = localStorage.getItem('ultimaAtualizacaoCliente') || '√öltima Altera√ß√£o: Nunca';
        }

        function debouncePesquisa() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                exibirTabela();
            }, 300);
        }

        function limparPesquisa() {
            document.getElementById("searchInput").value = "";
            exibirTodos();
        }

        const SETTINGS_KEY = 'interfaceSettings';
        const DEFAULT_SETTINGS = {
            width: 16,
            roundButtons: false,
            transparentButtons: false,
            buttonSpacing: 5,
            clientNameColor: '#007bff',
            avisadoColor: '#e0f7fa',
            debitoColor: '#fff3e0',
            vencendoHojeColor: '#fff9c4',
            vencidoColor: '#ffcdd2'
        };

        function toggleSettingsArea() {
            const settingsArea = document.getElementById('settingsArea');
            settingsArea.style.display = (settingsArea.style.display === 'block') ? 'none' : 'block';
        }
        
        function applyButtonStyles() {
            const round = document.getElementById('roundButtonsCheckbox').checked;
            const transparent = document.getElementById('transparentButtonsCheckbox').checked;
            document.body.classList.toggle('round-buttons', round);
            document.body.classList.toggle('transparent-buttons', transparent);
        }
        
        function updateButtonSpacing(value) {
            document.getElementById('buttonSpacingValue').textContent = value;
            updateCssVariable('--button-gap', `${value}px`);
        }
        
        function updateCssVariable(variable, value) {
            document.documentElement.style.setProperty(variable, value);
        }

        function updateInputWidth(value) {
            document.getElementById('inputWidthValue').textContent = value;
            document.querySelectorAll('.input-wrapper').forEach(wrapper => {
                wrapper.style.flexBasis = `calc(${value}% - 10px)`;
            });
        }

        function saveSettings() {
            const settings = {
                width: document.getElementById('inputWidth').value,
                roundButtons: document.getElementById('roundButtonsCheckbox').checked,
                transparentButtons: document.getElementById('transparentButtonsCheckbox').checked,
                buttonSpacing: document.getElementById('buttonSpacingSlider').value,
                clientNameColor: document.getElementById('clientNameColorPicker').value,
                avisadoColor: document.getElementById('avisadoColorPicker').value,
                debitoColor: document.getElementById('debitoColorPicker').value,
                vencendoHojeColor: document.getElementById('vencendoHojeColorPicker').value,
                vencidoColor: document.getElementById('vencidoColorPicker').value
            };
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            exibirAlerta("Ajustes salvos!");
            toggleSettingsArea();
        }

        function loadSettings() {
            let settings = { ...DEFAULT_SETTINGS };
            const savedSettings = localStorage.getItem(SETTINGS_KEY);
            if (savedSettings) {
                try {
                    settings = { ...settings, ...JSON.parse(savedSettings) };
                } catch (e) {
                    localStorage.removeItem(SETTINGS_KEY);
                }
            }
            
            document.getElementById('inputWidth').value = settings.width;
            updateInputWidth(settings.width);

            document.getElementById('roundButtonsCheckbox').checked = settings.roundButtons;
            document.getElementById('transparentButtonsCheckbox').checked = settings.transparentButtons;
            applyButtonStyles();
            
            document.getElementById('buttonSpacingSlider').value = settings.buttonSpacing;
            updateButtonSpacing(settings.buttonSpacing);

            document.getElementById('clientNameColorPicker').value = settings.clientNameColor;
            updateCssVariable('--client-name-color', settings.clientNameColor);

            document.getElementById('avisadoColorPicker').value = settings.avisadoColor;
            updateCssVariable('--avisado-color', settings.avisadoColor);

            document.getElementById('debitoColorPicker').value = settings.debitoColor;
            updateCssVariable('--debito-color', settings.debitoColor);

            document.getElementById('vencendoHojeColorPicker').value = settings.vencendoHojeColor;
            updateCssVariable('--vencendo-hoje-color', settings.vencendoHojeColor);
            
            document.getElementById('vencidoColorPicker').value = settings.vencidoColor;
            updateCssVariable('--vencido-color', settings.vencidoColor);
        }

        function resetSettings() {
            localStorage.removeItem(SETTINGS_KEY);
            exibirAlerta("Ajustes redefinidos para o padr√£o!");
            loadSettings();
        }
        
        function loadConfiguracaoBotoes() {
            const configSalva = localStorage.getItem('acaoBotoesConfig');
            if (configSalva) {
                try {
                    const parsedConfig = JSON.parse(configSalva);
                    acaoBotoesConfig = { ...defaultAcaoBotoesConfig };
                    for (const key in parsedConfig) {
                        if (acaoBotoesConfig.hasOwnProperty(key)) {
                            acaoBotoesConfig[key].visivel = parsedConfig[key].visivel;
                        }
                    }
                } catch (e) {
                    console.error("Erro ao carregar configura√ß√£o de bot√µes, usando padr√£o.", e);
                    acaoBotoesConfig = JSON.parse(JSON.stringify(defaultAcaoBotoesConfig));
                }
            } else {
                acaoBotoesConfig = JSON.parse(JSON.stringify(defaultAcaoBotoesConfig));
            }
        }

        function abrirModalConfigurarBotoes() {
            const listContainer = document.getElementById('botoesConfigList');
            listContainer.innerHTML = '';
            for (const key in acaoBotoesConfig) {
                const config = acaoBotoesConfig[key];
                const checkboxId = `chk-btn-${key}`;
                const itemHtml = `
                    <div style="margin-bottom: 5px;">
                        <input type="checkbox" id="${checkboxId}" data-key="${key}" ${config.visivel ? 'checked' : ''}>
                        <label for="${checkboxId}">${config.label}</label>
                    </div>
                `;
                listContainer.innerHTML += itemHtml;
            }
            document.getElementById('modalConfigurarBotoes').style.display = 'flex';
        }

        function salvarConfiguracaoBotoes() {
            const checkboxes = document.querySelectorAll('#botoesConfigList input[type="checkbox"]');
            checkboxes.forEach(chk => {
                const key = chk.dataset.key;
                if (acaoBotoesConfig[key]) {
                    acaoBotoesConfig[key].visivel = chk.checked;
                }
            });
            localStorage.setItem('acaoBotoesConfig', JSON.stringify(acaoBotoesConfig));
            fecharModal();
            chamarFiltroAtual();
            exibirAlerta("Configura√ß√£o de bot√µes salva!");
        }

        function atualizarContadores() {
            const hoje = new Date();
            const hojeFormatada = hoje.toLocaleDateString('pt-BR').split('/').map(p => p.padStart(2,'0')).join('/');
            const hojeStr = new Date().toISOString().split('T')[0];

            const clientesVisiveis = clientes.filter(c => !c.arquivado && !c.oculto && !c.desativado && (!c.reexibirEm || c.reexibirEm <= hojeStr));
            const countHoje = clientesVisiveis.filter(c => c.data === hojeFormatada && !c.avisado).length;
            const countAmanha = clientesVisiveis.filter(c => {
                const amanha = new Date();
                amanha.setDate(amanha.getDate() + 1);
                return c.data === amanha.toLocaleDateString('pt-BR').split('/').map(p => p.padStart(2,'0')).join('/');
            }).length;
            const countVencidos = clientesVisiveis.filter(c => {
                if(!c.data) return false;
                const [dia, mes, ano] = c.data.split('/').map(Number);
                const dataCliente = new Date(ano, mes - 1, dia);
                const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
                return dataCliente < hojeSemHora && !c.avisado;
            }).length;
            
            const countCobrancaHoje = clientesVisiveis.filter(c => c.dataCobranca === hojeFormatada).length;

            updateBadge('badgeHojeEVencidos', countHoje + countVencidos);
            updateBadge('badgeCobrancaHoje', countCobrancaHoje);
            updateBadge('badgeHoje', countHoje);
            updateBadge('badgeAmanha', countAmanha);
            updateBadge('badgeVencidos', countVencidos);
            updateBadge('badgeDebito', clientesVisiveis.filter(c => c.debito).length);
            updateBadge('badgeArquivados', clientes.filter(c => c.arquivado).length);
            updateBadge('badgeDesativados', clientes.filter(c => c.desativado).length);
            updateBadge('badgeVerDepois', clientes.filter(c => c.reexibirEm && c.reexibirEm > hojeStr).length);
            updateBadge('badgeCentralMessage', clientesVencidosParaMensagem.length);
        }

        function updateBadge(badgeId, count) {
            const badge = document.getElementById(badgeId);
            if (badge) {
                badge.style.display = count > 0 ? 'inline-block' : 'none';
                badge.textContent = count;
            }
        }

        function mostrarContagemProdutos() {
            const clientesAtivos = clientes.filter(c => !c.arquivado && !c.oculto && !c.desativado);
            document.getElementById('countUniTv').textContent = clientesAtivos.filter(c => c.Produto === 'UniTv').length;
            document.getElementById('countDuplecast').textContent = clientesAtivos.filter(c => c.Produto === 'Duplecast').length;
            document.getElementById('modalContagemProdutos').style.display = 'flex';
        }

        function prepararClientesVencidosParaMensagem() {
            const hoje = new Date();
            const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
            const hojeStr = hoje.toISOString().split('T')[0];
            clientesVencidosParaMensagem = clientes.filter(c => {
                if(!c.data) return false;
                const [dia, mes, ano] = c.data.split("/").map(Number);
                const dataCliente = new Date(ano, mes - 1, dia);
                const isVencidoOuHoje = dataCliente.getTime() <= hojeSemHora.getTime();
                const isVisivel = !c.reexibirEm || c.reexibirEm <= hojeStr;
                return isVencidoOuHoje && isVisivel && !c.avisado && !c.arquivado && !c.oculto && !c.desativado;
            });
            atualizarContadores();
        }

        function enviarProximoClienteVencido() {
            prepararClientesVencidosParaMensagem();
            if (clientesVencidosParaMensagem.length === 0) {
                exibirAlerta("N√£o h√° clientes vencidos para enviar mensagem.");
                return;
            }
            const cliente = clientesVencidosParaMensagem[0];
            const nomeExibicaoBase = cliente.nome.replace(/\s\(UniTv\)|\(Duplecast\)/g, '').trim();
            const originalClientesExibidos = clientesExibidos;
            clientesExibidos = [cliente];
            enviarMensagemWhatsApp(nomeExibicaoBase, cliente.telefone, 0);
            clientesExibidos = originalClientesExibidos;
        }

        const POPUP_WATCHLIST_KEY = 'popupWatchlistClientIds';

        function getPopupWatchlistIds() {
            try {
                const raw = localStorage.getItem(POPUP_WATCHLIST_KEY);
                const arr = raw ? JSON.parse(raw) : [];
                return Array.isArray(arr) ? arr : [];
            } catch (e) {
                return [];
            }
        }

        function setPopupWatchlistIds(ids) {
            const uniq = Array.from(new Set((ids || []).filter(Boolean).map(String)));
            localStorage.setItem(POPUP_WATCHLIST_KEY, JSON.stringify(uniq));
        }

        const POPUP_CLONES_KEY = 'popupClientClones_v1';
        const POPUP_CLONE_MARK = 'A';

        function loadPopupClientClones() {
            try {
                const raw = localStorage.getItem(POPUP_CLONES_KEY);
                const arr = raw ? JSON.parse(raw) : [];
                if (!Array.isArray(arr)) return [];
                return arr
                    .filter(c => c && typeof c === 'object')
                    .map(c => {
                        const cc = { ...c };
                        cc.id = String(cc.id ?? '');
                        if (cc.popupCloneOf !== undefined && cc.popupCloneOf !== null) cc.popupCloneOf = String(cc.popupCloneOf);
                        cc.popupClone = true;
                        return cc;
                    });
            } catch (e) {
                return [];
            }
        }

        function savePopupClientClones() {
            try {
                localStorage.setItem(POPUP_CLONES_KEY, JSON.stringify(popupClientClones || []));
            } catch (e) {}
        }

        function getPopupCloneById(cloneId) {
            const id = String(cloneId ?? '');
            return (popupClientClones || []).find(c => String(c.id) === id) || null;
        }

        function getPopupCloneBySourceId(sourceId) {
            const sid = String(sourceId ?? '');
            return (popupClientClones || []).find(c => String(c.popupCloneOf || '') === sid) || null;
        }

        function generateUniquePopupCloneId(sourceId) {
            const base = String(sourceId ?? '').trim();
            const used = new Set((popupClientClones || []).map(c => String(c.id)));
            let candidate = `${base}${POPUP_CLONE_MARK}`;
            let i = 2;

            if (!candidate || candidate === POPUP_CLONE_MARK) candidate = `${POPUP_CLONE_MARK}0000`;

            while (used.has(candidate)) {
                candidate = `${base}${POPUP_CLONE_MARK}${i}`;
                i++;
                if (i > 9999) {
                    candidate = `${base}${POPUP_CLONE_MARK}${Date.now().toString().slice(-4)}`;
                    break;
                }
            }
            return candidate;
        }

        function cloneClienteParaPopup(clienteOriginal) {
            if (!clienteOriginal) return null;
            const sourceId = String(clienteOriginal.id);
            const cloneId = generateUniquePopupCloneId(sourceId);

            let clone;
            try {
                clone = JSON.parse(JSON.stringify(clienteOriginal));
            } catch (e) {
                clone = { ...clienteOriginal };
            }

            clone.id = cloneId;
            clone.popupCloneOf = sourceId;
            clone.popupClone = true;

            return clone;
        }

        function ensurePopupCloneForSourceId(sourceId) {
            const sid = String(sourceId ?? '').trim();
            if (!sid) return null;

            let existing = getPopupCloneBySourceId(sid);
            if (existing) return existing;

            existing = getPopupCloneById(`${sid}${POPUP_CLONE_MARK}`);
            if (existing) {
                existing.popupCloneOf = sid;
                existing.popupClone = true;
                savePopupClientClones();
                return existing;
            }

            const original = (clientes || []).find(c => String(c.id) === sid);
            if (!original) return null;

            const novoClone = cloneClienteParaPopup(original);
            if (!novoClone) return null;

            popupClientClones.push(novoClone);
            savePopupClientClones();
            return novoClone;
        }

        function syncPopupClonesWithWatchlist(sourceIds) {
            const uniq = Array.from(new Set((sourceIds || []).filter(Boolean).map(String)));

            uniq.forEach(sid => {
                try { ensurePopupCloneForSourceId(sid); } catch (e) {}
            });

            popupClientClones = (popupClientClones || []).filter(cl => {
                const sid = cl && cl.popupCloneOf ? String(cl.popupCloneOf) : '';
                if (sid && uniq.includes(sid)) return true;

                const inferred = String((cl && cl.id) ? cl.id : '').replace(/A\d*$/i, '');
                return inferred && uniq.includes(inferred);
            });

            popupClientClones.forEach(cl => {
                if (cl && !cl.popupCloneOf) {
                    const inferred = String(cl.id || '').replace(/A\d*$/i, '');
                    if (inferred) cl.popupCloneOf = inferred;
                }
                if (cl) cl.popupClone = true;
            });

            savePopupClientClones();
        }

        let popupClientClones = loadPopupClientClones();

        function parseDataBRToDate(dataBR) {
            if (!dataBR || typeof dataBR !== 'string') return null;
            const parts = dataBR.split('/');
            if (parts.length !== 3) return null;
            const [dd, mm, yyyy] = parts.map(n => parseInt(n, 10));
            if (!dd || !mm || !yyyy) return null;
            return new Date(yyyy, mm - 1, dd);
        }

        function diasAteVencimento(cliente) {
            const dt = parseDataBRToDate(cliente && cliente.data);
            if (!dt) return null;
            const hoje = new Date();
            const hojeSemHora = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
            const vencSemHora = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
            const ms = vencSemHora - hojeSemHora;
            return Math.floor(ms / (1000 * 60 * 60 * 24));
        }

        function clienteEstaElegivelParaPopup(cliente) {
            if (!cliente) return false;
            if (cliente.desativado || cliente.arquivado || cliente.oculto) return false;

            if (cliente.reexibirEm) {
                try {
                    const hoje = new Date();
                    const hojeIso = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate()).toISOString().split('T')[0];
                    if (String(cliente.reexibirEm) > String(hojeIso)) return false;
                } catch (e) {}
            }

            const dias = diasAteVencimento(cliente);
            return (dias !== null && dias >= 0 && dias <= 3);
        }

        function getClientesParaPopupVencendo() {
            const sourceIds = getPopupWatchlistIds();
            const lista = [];

            // 1) Clientes baseados na lista principal (watchIds)
            sourceIds.forEach(sourceId => {
                const clone = ensurePopupCloneForSourceId(sourceId);
                if (clone && clienteEstaElegivelParaPopup(clone)) lista.push(clone);
            });

            // 2) Clientes Manuais do Pop-up (ID come√ßa com "MAN" ou n√£o tem popupCloneOf linkado)
            popupClientClones.forEach(clone => {
                if(clone.id && clone.id.startsWith("MAN")) {
                    if (clienteEstaElegivelParaPopup(clone)) {
                        // Evita duplicata se j√° foi adicionado
                        if(!lista.find(c=>c.id===clone.id)) lista.push(clone);
                    }
                }
            });

            lista.sort((a, b) => {
                const da = diasAteVencimento(a);
                const db = diasAteVencimento(b);
                return (da ?? 9999) - (db ?? 9999);
            });
            return lista;
        }

        function formatDiasLabel(dias) {
            if (dias === 0) return "vence HOJE";
            if (dias === 1) return "vence em 1 dia";
            return `vence em ${dias} dias`;
        }

        async function marcarAvisadoById(clientId) {
            const id = String(clientId);

            const idx = clientes.findIndex(c => String(c.id) === id);
            if (idx !== -1) {
                saveStateToHistory();
                const backup = JSON.parse(JSON.stringify(clientes));
                try {
                    clientes[idx].avisado = true;
                    clientes[idx].oculto = false;
                    clientes[idx].clicado = true;
                    if (typeof pushLog === 'function') pushLog(clientes[idx], "marcado avisado (popup)", "");
                    saveClientsToLocalStorage();
                    chamarFiltroAtual();
                    atualizarContadores();
                    prepararClientesVencidosParaMensagem();
                    await salvarClientes();
                    showToast("Marcado como avisado!");
                } catch (e) {
                    clientes = backup;
                    saveClientsToLocalStorage();
                    chamarFiltroAtual();
                    atualizarContadores();
                    exibirAlerta("Erro ao marcar avisado: " + e.message);
                }
                return;
            }

            const cidx = (popupClientClones || []).findIndex(c => String(c.id) === id);
            if (cidx === -1) return;

            const c = popupClientClones[cidx];
            c.avisado = true;
            c.oculto = false;
            c.clicado = true;
            if (typeof pushLog === 'function') pushLog(c, "marcado avisado (popup)", "clone");
            savePopupClientClones();
            showToast("Marcado como avisado!");

            try { checarEExibirPopupVencendo(); } catch (e) {}
        }

        function abrirPopupVencendo(listaClientes) {
            // Garante que n√£o h√° outro modal aberto (evita sobreposi√ß√£o)
            fecharModal();
            const modal = document.getElementById('modalPopupVencendo');
            const box = document.getElementById('popupVencendoLista');
            if (!modal || !box) return;

            if (!listaClientes || !listaClientes.length) {
                modal.style.display = 'none';
                return;
            }

            box.innerHTML = '';
            listaClientes.forEach(c => {
                const dias = diasAteVencimento(c);
                const nomeLimpo = (c.nome || "").replace(/\s\(UniTv\)|\s\(Duplecast\)/g, "").trim();
                const card = document.createElement('div');
                card.className = 'popup-card';
                card.innerHTML = `
                    <div class="top">
                        <div><b>${nomeLimpo}</b> <span style="color:#777">(${c.Produto || "N/I"})</span></div>
                        <div style="font-weight:800; color: var(--danger-color);">${formatDiasLabel(dias)}</div>
                    </div>
                    <div class="meta">
                        <div>üìû ${c.telefone || "-"}</div>
                        <div>üìÖ Venc: <b>${c.data || "-"}</b></div>
                        ${c.dataCobranca ? `<div style="color:var(--success-color); font-weight:800;">üí≤ Cobran√ßa: ${c.dataCobranca}</div>` : ""}
                    </div>
                    ${c.observacao ? `<div style="margin-top:2px; padding:8px; background:#f7f7f7; border-radius:8px;"><b>Obs:</b> ${c.observacao}</div>` : ""}
                    <div class="actions">
                        <button class="btn-success" onclick="enviarMensagemWhatsAppById('${c.id}')">üì≤ Whats</button>
                        <button class="btn-info" onclick="marcarAvisadoById('${c.id}')">‚úÖ Avisado</button>
                        <button class="btn-secondary" onclick="abrirModalVerDepoisById('${c.id}')">‚è≥ Ver depois</button>
                        <button class="btn-warning" onclick="pedirConfirmacaoRenovarHojeById('${c.id}')">‚ö° Renovar hoje</button>
                        <button class="btn-danger" onclick="pedirConfirmacaoRenovacaoDebitoById('${c.id}')">üí≥ D√©bito</button>
                        <button onclick="editarClienteById('${c.id}')">‚úèÔ∏è Editar</button>
                        <button onclick="copiarMensagemWhatsAppById('${c.id}')">üìã Copiar msg</button>
                        <button onclick="copiarNumeroClienteById('${c.id}')">üî¢ Copiar n√∫mero</button>
                        <button onclick="arquivarById('${c.id}')">üìÇ Arquivar</button>
                        <button onclick="toggleDesativadoById('${c.id}')">üö´ Desativar</button>
                    </div>
                `;
                box.appendChild(card);
            });

            modal.style.display = 'flex';
            document.addEventListener("keydown", fecharComEsc);
        }

        function fecharPopupVencendo() {
            const modal = document.getElementById('modalPopupVencendo');
            if (modal) modal.style.display = 'none';

            try {
                const anyOpen = Array.from(document.querySelectorAll('.modal'))
                    .some(m => (m && m.style && m.style.display === 'flex'));
                if (!anyOpen) document.removeEventListener("keydown", fecharComEsc);
            } catch (e) {
                document.removeEventListener("keydown", fecharComEsc);
            }
        }

        function checarEExibirPopupVencendo() {
            const lista = getClientesParaPopupVencendo();
            if (lista.length) abrirPopupVencendo(lista);
        }

        let popupConfigTempIds = [];
        let popupConfigView = 'select'; 

        function popupConfigRenderAtual() {
            if (popupConfigView === 'manage') {
                if (typeof renderPopupClonesLista === 'function') renderPopupClonesLista();
            } else {
                if (typeof renderPopupConfigLista === 'function') renderPopupConfigLista();
            }
        }

        function abrirModalPopupConfig() {
            // Garante que n√£o h√° outro modal aberto (evita sobreposi√ß√£o)
            fecharModal();
            popupConfigView = 'select';
            addAppLog('INFO', 'popupConfig:abrirModal', 'Abrindo configura√ß√£o do pop-up');
            popupConfigTempIds = getPopupWatchlistIds();
            const modal = document.getElementById('modalPopupConfig');
            if (modal) modal.style.display = 'flex';
            const busca = document.getElementById('popupConfigBusca');
            if (busca) busca.value = '';
            renderPopupConfigLista();
            document.addEventListener("keydown", fecharComEsc);
        }

        function fecharModalPopupConfig() {
            const modal = document.getElementById('modalPopupConfig');
            if (modal) modal.style.display = 'none';
            try {
                const anyOpen = Array.from(document.querySelectorAll('.modal'))
                    .some(m => m && m.style && m.style.display === 'flex');
                if (!anyOpen) document.removeEventListener("keydown", fecharComEsc);
            } catch (e) {
                try { document.removeEventListener("keydown", fecharComEsc); } catch(_) {}
            }
        }

        function gerenciarClientesCadastrados() {
            // Atalho para abrir o modal de gerenciamento (agora separado)
            abrirModalGerenciarPopup();
        }

        function togglePopupConfigId(id, checked) {
            id = String(id);
            if (checked) {
                if (!popupConfigTempIds.includes(id)) popupConfigTempIds.push(id);
            } else {
                popupConfigTempIds = popupConfigTempIds.filter(x => String(x) !== id);
            }
        }

        function renderPopupConfigLista() {
            const listaEl = document.getElementById('popupConfigLista');
            if (!listaEl) return;

            const termo = (document.getElementById('popupConfigBusca')?.value || '').toLowerCase().trim();

            const ordenados = (clientes || []).slice().sort((a,b)=>{
                const na=(a.nome||'').toLowerCase(); const nb=(b.nome||'').toLowerCase();
                return na.localeCompare(nb);
            });

            const filtrados = ordenados.filter(c => {
                if (!c || !c.id) return false;
                if (c.isPopupClone) return false;
                const nome = (c.nome || '').toLowerCase();
                const tel = String(c.telefone || '').toLowerCase();
                if (!termo) return true;
                return nome.includes(termo) || tel.includes(termo) || String(c.id).includes(termo);
            });

            listaEl.innerHTML = '';
            if (!filtrados.length) {
                listaEl.innerHTML = '<div class="popup-muted">Nenhum cliente encontrado.</div>';
                return;
            }

            filtrados.forEach(c => {
                const id = String(c.id);
                const checked = popupConfigTempIds.includes(id);
                const cloneExistente = (popupClientClones || []).find(cl => String(cl.popupCloneOf || '') === id);
                const cloneIdLabel = cloneExistente ? String(cloneExistente.id) : '';
                const dias = diasAteVencimento(c);
                const status = (dias === null) ? '' : ` ‚Ä¢ ${formatDiasLabel(dias)}`;
                const nomeLimpo = (c.nome || "").replace(/\s\(UniTv\)|\s\(Duplecast\)/g, "").trim();

                const row = document.createElement('div');
                row.className = 'popup-config-row';
                row.innerHTML = `
                    <input type="checkbox" ${checked ? 'checked' : ''} onchange="togglePopupConfigId('${id}', this.checked)">
                    <div class="info">
                        <div><b>${nomeLimpo}</b> <span style="color:#777">(${c.Produto || "N/I"})</span></div>
                        <div class="popup-muted">ID: ${id}${cloneIdLabel ? ` ‚Ä¢ Clone: ${cloneIdLabel}` : ``} ‚Ä¢ üìû ${c.telefone || '-'} ‚Ä¢ üìÖ ${c.data || '-'}${status}</div>
                    </div>
                `;
                listaEl.appendChild(row);
            });
        }

        function removerPopupClone(cloneId) {
            const id = String(cloneId ?? '');
            popupClientClones = (popupClientClones || []).filter(c => String(c.id) !== id);
            
            // Remove do watchlist se for refer√™ncia
            const clone = getPopupCloneById(id);
            if(clone && clone.popupCloneOf) {
                let wIds = getPopupWatchlistIds();
                wIds = wIds.filter(wid => wid !== String(clone.popupCloneOf));
                setPopupWatchlistIds(wIds);
            }

            if (typeof savePopupClientClones === 'function') savePopupClientClones();
            
            // Re-renderiza a lista do gerenciador
            renderListaGerenciarPopup();
        }

        // =========================
        // NOVO: Fun√ß√µes do Modal Gerenciar Popup
        // =========================
        function abrirModalGerenciarPopup() {
            // Garante que n√£o h√° outro modal aberto (evita sobreposi√ß√£o)
            fecharModal();
            const modal = document.getElementById('modalGerenciarPopup');
            if (modal) modal.style.display = 'flex';
            renderListaGerenciarPopup();
            
            // Preenche data com hoje por padr√£o
            const today = new Date().toISOString().split('T')[0];
            const dateEl = document.getElementById('popData');
            if(dateEl && !dateEl.value) dateEl.value = today;

            document.addEventListener("keydown", fecharComEsc);
        }

        function fecharModalGerenciarPopup() {
            const modal = document.getElementById('modalGerenciarPopup');
            if (modal) modal.style.display = 'none';
            try {
                const anyOpen = Array.from(document.querySelectorAll('.modal'))
                    .some(m => m && m.style && m.style.display === 'flex');
                if (!anyOpen) document.removeEventListener("keydown", fecharComEsc);
            } catch (e) {
                try { document.removeEventListener("keydown", fecharComEsc); } catch(_) {}
            }
        }

        function renderListaGerenciarPopup() {
            const listaEl = document.getElementById('listaGerenciarPop');
            if (!listaEl) return;

            const termo = (document.getElementById('buscaGerenciarPop')?.value || '').toLowerCase().trim();
            const clones = (popupClientClones || []).slice().filter(c => c && c.id);

            const filtrados = clones.filter(c => {
                const nome = (c.nome || '').toLowerCase();
                const tel = String(c.telefone || '').toLowerCase();
                const id = String(c.id || '').toLowerCase();
                if (!termo) return true;
                return nome.includes(termo) || tel.includes(termo) || id.includes(termo);
            }).sort((a,b)=>{
                const na=(a.nome||'').toLowerCase(); const nb=(b.nome||'').toLowerCase();
                return na.localeCompare(nb);
            });

            if (!filtrados.length) {
                listaEl.innerHTML = `
                    <div style="padding:14px; text-align:center; opacity:.8;">
                        <b>Nenhum cliente no Pop-up.</b><br>
                        Cadastre manualmente acima ou importe da lista principal.
                    </div>
                `;
                return;
            }

            const html = filtrados.map(c => {
                const id = String(c.id || '');
                const origem = String(c.popupCloneOf || '');
                const nome = c.nome || '(Sem nome)';
                const tel = c.telefone ? String(c.telefone) : '';
                const venc = c.data ? String(c.data) : ''; // Corrigido para .data
                const isManual = id.startsWith('MAN');
                const tipoLabel = isManual ? '<span style="background:#e0f2f1; color:#00695c; padding:2px 6px; border-radius:4px; font-size:0.8em;">Manual</span>' : '<span style="background:#e3f2fd; color:#0d47a1; padding:2px 6px; border-radius:4px; font-size:0.8em;">Importado</span>';

                return `
                    <div style="display:flex; justify-content:space-between; gap:12px; align-items:center; padding:10px 12px; margin:8px 0; border:1px solid #e5e5e5; border-radius:12px; background:#fff;">
                        <div style="min-width:0;">
                            <div style="font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:flex; align-items:center; gap:8px;">
                                ${nome} ${tipoLabel}
                            </div>
                            <div style="font-size:.9em; opacity:.85; margin-top:2px; display:flex; gap:10px; flex-wrap:wrap;">
                                <span><b>Venc:</b> ${venc}</span>
                                ${tel ? `<span><b>Tel:</b> ${tel}</span>` : ``}
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                            <button class="btn-info" type="button" onclick="marcarAvisadoById(${JSON.stringify(id)})">‚úÖ Avisado</button>
                            <button class="btn-secondary" type="button" onclick="abrirModalVerDepoisById(${JSON.stringify(id)})">‚è≥ Ver depois</button>
                            <button class="btn-warning" type="button" onclick="pedirConfirmacaoRenovarHojeById(${JSON.stringify(id)})">‚ö° Renovar hoje</button>
                            <button class="btn-danger" type="button" onclick="pedirConfirmacaoRenovacaoDebitoById(${JSON.stringify(id)})">üí≥ D√©bito</button>
                            <button type="button" onclick="editarClienteById(${JSON.stringify(id)})">‚úèÔ∏è Editar</button>
                            <button type="button" onclick="copiarMensagemWhatsAppById(${JSON.stringify(id)})">üìã Copiar msg</button>
                            <button type="button" onclick="copiarNumeroClienteById(${JSON.stringify(id)})">üî¢ Copiar n√∫mero</button>
                            <button type="button" onclick="arquivarById(${JSON.stringify(id)})">üìÇ Arquivar</button>
                            <button type="button" onclick="toggleDesativadoById(${JSON.stringify(id)})">üö´ Desativar</button>
                            <button class="btn-danger icon-btn" style="width:34px; height:34px; font-size:1em;" title="Remover do Pop-up" type="button" onclick="removerPopupClone(${JSON.stringify(id)})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');

            listaEl.innerHTML = html;
        }

        function adicionarClienteManualPopup() {
            const nome = document.getElementById('popNome').value.trim();
            const tel = document.getElementById('popTel').value.trim();
            const data = document.getElementById('popData').value;
            const prod = document.querySelector('input[name="popProd"]:checked').value;

            if (!nome || !data) {
                exibirAlerta("Nome e Data de Vencimento s√£o obrigat√≥rios.");
                return;
            }

            const telLimpo = tel.replace(/[^\d]/g, '');
            // Gera ID manual √∫nico
            const id = 'MAN' + Date.now().toString().slice(-6);
            
            const novoClone = {
                id: id,
                nome: `${nome} (${prod})`,
                telefone: telLimpo,
                data: data.split("-").reverse().join("/"), // yyyy-mm-dd -> dd/mm/yyyy
                Produto: prod,
                popupClone: true,
                popupCloneOf: null, // Sem pai na lista principal
                avisado: false,
                debito: false,
                arquivado: false,
                oculto: false,
                desativado: false,
                clicado: false,
                reexibirEm: null
            };

            popupClientClones.push(novoClone);
            savePopupClientClones();
            
            // Limpa campos
            document.getElementById('popNome').value = '';
            document.getElementById('popTel').value = '';
            
            showToast("Cliente adicionado ao Pop-up!");
            renderListaGerenciarPopup();
            
            // Tenta atualizar pop-up de vencendo se estiver aberto/eleg√≠vel
            try { checarEExibirPopupVencendo(); } catch(e){}
        }

        function salvarPopupConfig() {
            setPopupWatchlistIds(popupConfigTempIds);
            try { syncPopupClonesWithWatchlist(popupConfigTempIds); } catch (e) {}
            showToast("Pop-up configurado!");
            fecharModalPopupConfig();
            
            // Se o modal de gerenciar estiver aberto, atualiza a lista dele
            const modalGerenciar = document.getElementById('modalGerenciarPopup');
            if(modalGerenciar && modalGerenciar.style.display === 'flex') {
                renderListaGerenciarPopup();
            }
            
            checarEExibirPopupVencendo();
        }


        document.addEventListener('DOMContentLoaded', () => {
            loadDebugLogs();
            addAppLog('OK', 'app:start', 'P√°gina carregou');
            setTopStatus('Status: pronto');
            const today = new Date();
            document.getElementById('dataInput').value = today.toISOString().split('T')[0];
            document.getElementById('dataAtual').innerText = today.toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit'
            });

            document.getElementById('dataInput').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    document.getElementById('nomeInput').focus();
                }
            });
            document.getElementById('nomeInput').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    document.getElementById('telefoneInput').focus();
                }
            });
            document.getElementById('telefoneInput').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    adicionarCliente();
                }
            });

            const formVerDepois = document.getElementById('formVerDepois');
            if (formVerDepois) {
                formVerDepois.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await confirmarVerDepois();
                });
            }

            document.addEventListener('keydown', async (e) => {
                const modal = document.getElementById('modalVerDepois');
                if (!modal) return;
                const aberto = (modal.style.display === 'flex');
                if (!aberto) return;

                if (e.key === 'Enter') {
                    e.preventDefault();
                    await confirmarVerDepois();
                }
            }, true);

            loadClientes()
                .then(() => { try { checarEExibirPopupVencendo(); } catch(e){} })
                .catch((e) => console.error('Erro ao carregar clientes:', e));
        });
    </script>

    <!-- Painel de Logs (debug) -->
    <div id="debugLogPanel">
        <div class="log-head">
            <b>Logs da P√°gina</b>
            <div class="log-actions">
                <button class="btn-secondary" onclick="copyDebugLogs()">üìã Copiar</button>
                <button class="btn-secondary" onclick="downloadDebugLogs()">‚¨áÔ∏è Baixar .txt</button>
                <button class="btn-warning" onclick="clearDebugLogs()">üßπ Limpar</button>
                <button class="btn-danger" onclick="toggleDebugLogPanel()">‚úñ Fechar</button>
            </div>
        </div>
        <div id="debugLogContent" class="log-body"></div>
    </div>

</body>
</html>
